---
phase: 07-song-library-setlists
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00011_songs.sql
  - lib/songs/types.ts
  - lib/songs/schemas.ts
  - lib/songs/queries.ts
  - lib/songs/actions.ts
autonomous: true
requirements:
  - SONG-01
  - SONG-02
  - SONG-03
  - SONG-05
  - SONG-06
  - SONG-07

must_haves:
  truths:
    - "Songs table exists with title, artist, default_key, default_tempo, tags (text[]), duration_seconds, links (jsonb), notes, created_by"
    - "Setlist_items table exists with service_id, song_id, sort_order, key_override, tempo_override, notes, added_by"
    - "RLS allows authenticated users SELECT on both tables"
    - "getSongs supports search (title/artist ilike) and filter (key eq, tag overlaps)"
    - "getSetlistForService returns setlist items with joined song data ordered by sort_order"
    - "getSongCountsForServices returns per-service song counts for dashboard"
    - "createSong, updateSong, deleteSong server actions work with role authorization"
    - "addToSetlist, removeFromSetlist, reorderSetlist, updateSetlistItemOverrides server actions work"
  artifacts:
    - path: "supabase/migrations/00011_songs.sql"
      provides: "songs + setlist_items tables, GIN index on tags, RLS policies, updated_at triggers"
      contains: "CREATE TABLE public.songs"
    - path: "lib/songs/types.ts"
      provides: "SongSummary, SongDetail, SetlistItemWithSong, SongLink types"
    - path: "lib/songs/schemas.ts"
      provides: "Zod schemas for song CRUD and setlist operations"
      exports: ["createSongSchema", "updateSongSchema", "addToSetlistSchema", "reorderSetlistSchema", "updateSetlistItemOverridesSchema"]
    - path: "lib/songs/queries.ts"
      provides: "Database query functions for songs and setlists"
      exports: ["getSongs", "getSongById", "getSetlistForService", "getSongCountsForServices", "getPopularTags", "getDistinctKeys"]
    - path: "lib/songs/actions.ts"
      provides: "Server actions for song and setlist mutations"
      exports: ["createSong", "updateSong", "deleteSong", "addToSetlist", "removeFromSetlist", "reorderSetlist", "updateSetlistItemOverrides"]
  key_links:
    - from: "lib/songs/queries.ts"
      to: "supabase songs table"
      via: "Supabase client query"
      pattern: "from.*songs"
    - from: "lib/songs/actions.ts"
      to: "lib/songs/schemas.ts"
      via: "Zod safeParse validation"
      pattern: "safeParse"
    - from: "lib/songs/actions.ts"
      to: "supabase admin client"
      via: "createAdminClient for writes"
      pattern: "createAdminClient"
---

<objective>
Create the database schema for songs and setlist items, and build the complete lib/songs module with types, Zod schemas, query functions, and server actions.

Purpose: This is the data foundation for the entire song library and setlist feature. All UI in Plans 02 and 03 depend on these types, queries, and actions.
Output: SQL migration (songs + setlist_items tables), lib/songs/ module (types.ts, schemas.ts, queries.ts, actions.ts)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-song-library-setlists/07-RESEARCH.md
@lib/services/actions.ts
@lib/services/queries.ts
@lib/services/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for songs and setlist_items tables</name>
  <files>supabase/migrations/00011_songs.sql</files>
  <action>
Create SQL migration file `supabase/migrations/00011_songs.sql` with:

1. **songs table:**
   - `id` uuid PK DEFAULT gen_random_uuid()
   - `title` text NOT NULL
   - `artist` text (nullable)
   - `default_key` text (nullable, free text: "C", "Bb", "F#m")
   - `default_tempo` int (nullable, BPM)
   - `tags` text[] NOT NULL DEFAULT '{}'
   - `duration_seconds` int (nullable)
   - `links` jsonb NOT NULL DEFAULT '[]' (array of {label, url} objects)
   - `notes` text (nullable)
   - `created_by` uuid REFERENCES public.members(id) ON DELETE SET NULL
   - `created_at` timestamptz NOT NULL DEFAULT now()
   - `updated_at` timestamptz NOT NULL DEFAULT now()

2. **setlist_items table:**
   - `id` uuid PK DEFAULT gen_random_uuid()
   - `service_id` uuid NOT NULL REFERENCES public.services(id) ON DELETE CASCADE
   - `song_id` uuid NOT NULL REFERENCES public.songs(id) ON DELETE CASCADE
   - `sort_order` int NOT NULL DEFAULT 0
   - `key_override` text (nullable, null = use song default)
   - `tempo_override` int (nullable, null = use song default)
   - `notes` text (nullable, per-service notes like "skip bridge")
   - `added_by` uuid REFERENCES public.members(id) ON DELETE SET NULL
   - `created_at` timestamptz NOT NULL DEFAULT now()
   - `updated_at` timestamptz NOT NULL DEFAULT now()

3. **Indexes:**
   - `idx_songs_title` on songs(title)
   - `idx_songs_artist` on songs(artist)
   - `idx_songs_tags` GIN on songs(tags) -- for array containment/overlap queries
   - `idx_setlist_items_service` on setlist_items(service_id, sort_order)
   - `idx_setlist_items_song` on setlist_items(song_id)

4. **RLS:**
   - Enable RLS on both tables
   - "Authenticated users can view songs" -- SELECT policy on songs for authenticated
   - "Authenticated users can view setlist items" -- SELECT policy on setlist_items for authenticated
   - Write operations go through admin client (bypass RLS), so no INSERT/UPDATE/DELETE policies needed

5. **Triggers:**
   - updated_at trigger on songs using existing `update_updated_at_column()` function
   - updated_at trigger on setlist_items using existing `update_updated_at_column()` function

6. **RPC function for popular tags:**
   - Create `get_popular_tags(limit_count int DEFAULT 10)` function that uses `unnest(tags)` + group by + order by count desc + limit
   - Returns TABLE(tag text, usage_count bigint)

7. Do NOT add a UNIQUE constraint on (service_id, song_id) in setlist_items -- allow same song twice in a setlist.
  </action>
  <verify>Review the SQL file for syntax correctness. Confirm it references existing tables (public.members, public.services) and the existing `update_updated_at_column()` function. Check GIN index is on tags column.</verify>
  <done>Migration file exists at supabase/migrations/00011_songs.sql with both tables, 5 indexes, 2 RLS policies, 2 triggers, and 1 RPC function</done>
</task>

<task type="auto">
  <name>Task 2: Complete lib/songs module (types, schemas, queries, actions)</name>
  <files>
    lib/songs/types.ts
    lib/songs/schemas.ts
    lib/songs/queries.ts
    lib/songs/actions.ts
  </files>
  <action>
Create the complete lib/songs/ module following the exact pattern of lib/services/ (schemas + queries + actions).

**lib/songs/types.ts:**
- `SongLink` interface: { label: string; url: string }
- `SongSummary` interface: all songs table columns (id, title, artist, default_key, default_tempo, tags, duration_seconds, links as SongLink[], notes, created_by, created_at, updated_at)
- `SetlistItemWithSong` interface: all setlist_items columns + nested `songs` object (id, title, artist, default_key, default_tempo, tags, duration_seconds)
- `PopularTag` interface: { tag: string; usage_count: number }

**lib/songs/schemas.ts:**
- Follow the Zod v4 pattern from lib/services/schemas.ts
- `songLinkSchema`: z.object({ label: z.string().min(1).max(50), url: z.string().url() })
- `createSongSchema`: title (required, min 1, max 300), artist (union string/literal "" optional), defaultKey (union string max 10/literal "" optional), defaultTempo (number int 20-300 optional), tags (array of string max 50, max 20 items, optional), durationSeconds (number int 1-3600 optional), links (array of songLinkSchema max 10 optional), notes (union string max 2000/literal "" optional)
- `updateSongSchema`: createSongSchema.partial().extend({ id: z.string().uuid() })
- `addToSetlistSchema`: serviceId (uuid), songId (uuid)
- `removeFromSetlistSchema`: itemId (uuid)
- `reorderSetlistSchema`: serviceId (uuid), itemIds (array uuid min 1)
- `updateSetlistItemOverridesSchema`: itemId (uuid), keyOverride (union string max 10/literal "" optional), tempoOverride (number int 20-300 optional), notes (union string max 2000/literal "" optional)
- Per MEMORY.md: use z.union([z.string()..., z.literal("")]).optional() for optional text fields -- NOT z.preprocess or z.transform().pipe()

**lib/songs/queries.ts:**
- Mark with `import "server-only"` at top (like lib/services/queries.ts)
- `getSongs(filters?: { search?: string; key?: string; tag?: string })`: query songs table with optional ilike on title/artist (using `.or()`), eq on default_key, overlaps on tags. Order by title ascending. Return SongSummary[].
- `getSongById(songId: string)`: single song by ID. Return SongSummary | null.
- `getSetlistForService(serviceId: string)`: query setlist_items with joined songs data (select `*, songs(id, title, artist, default_key, default_tempo, tags, duration_seconds)`), ordered by sort_order ascending. Return SetlistItemWithSong[].
- `getSongCountsForServices(serviceIds: string[])`: query setlist_items selecting service_id filtered by .in("service_id", serviceIds), count in application code. Return Record<string, number>.
- `getPopularTags(limit?: number)`: call supabase.rpc("get_popular_tags", { limit_count: limit ?? 10 }). Return PopularTag[].
- `getDistinctKeys()`: query songs selecting default_key, filter not null, get distinct values. Return string[].

**lib/songs/actions.ts:**
- Mark with `"use server"` directive
- Follow the exact pattern of lib/services/actions.ts: createClient() -> getUserRole() -> isAdminOrCommittee check -> safeParse -> createAdminClient() -> DB operation -> revalidatePath
- `createSong(data: unknown)`: validate with createSongSchema, insert into songs. Transform tags: filter empty strings, trim, lowercase. Convert empty strings to null with `|| null`. revalidatePath("/songs"). Return { success: true, songId } or { error }.
- `updateSong(data: unknown)`: validate with updateSongSchema, update songs by id. Same tag transform. revalidatePath("/songs"). Return success/error.
- `deleteSong(songId: string)`: validate UUID, delete from songs (cascades to setlist_items). revalidatePath("/songs"). Return success/error.
- `addToSetlist(data: unknown)`: validate with addToSetlistSchema. Get current max sort_order for the service, insert with sort_order = max + 1. revalidatePath for the service page. Return { success: true, itemId } or { error }.
- `removeFromSetlist(data: unknown)`: validate with removeFromSetlistSchema. Delete item. Then re-number remaining items for the same service_id (fetch remaining ordered by sort_order, update each with index-based sort_order). revalidatePath. Return success/error.
- `reorderSetlist(data: unknown)`: validate with reorderSetlistSchema. For each itemId in the array, update sort_order = index. revalidatePath. Return success/error.
- `updateSetlistItemOverrides(data: unknown)`: validate with updateSetlistItemOverridesSchema. Update key_override, tempo_override, notes on the item. Convert empty strings to null. revalidatePath. Return success/error.
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Check that all exports are valid and the module follows the same patterns as lib/services/.</verify>
  <done>All 4 files exist in lib/songs/, TypeScript compiles without errors, and the module exports 7 server actions, 6 query functions, 6+ Zod schemas, and all necessary types</done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no TypeScript errors
- supabase/migrations/00011_songs.sql contains CREATE TABLE for both songs and setlist_items
- lib/songs/types.ts exports SongSummary, SetlistItemWithSong, SongLink, PopularTag
- lib/songs/schemas.ts exports all 6 Zod schemas
- lib/songs/queries.ts exports getSongs, getSongById, getSetlistForService, getSongCountsForServices, getPopularTags, getDistinctKeys
- lib/songs/actions.ts exports createSong, updateSong, deleteSong, addToSetlist, removeFromSetlist, reorderSetlist, updateSetlistItemOverrides
</verification>

<success_criteria>
- Database migration file ready for `supabase db push`
- Complete lib/songs/ module with types, schemas, queries, and actions
- All server actions use role authorization (admin/committee only for writes)
- Tags use text[] with GIN index, not a separate table
- Setlist items support per-service overrides (key_override, tempo_override, notes)
- Sort order gap handling in removeFromSetlist (re-number after deletion)
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-song-library-setlists/07-01-SUMMARY.md`
</output>
