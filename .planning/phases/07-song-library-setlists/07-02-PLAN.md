---
phase: 07-song-library-setlists
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/(app)/songs/page.tsx
  - app/(app)/songs/song-search.tsx
  - app/(app)/songs/song-table.tsx
  - app/(app)/songs/song-form-dialog.tsx
  - app/(app)/songs/filter-chips.tsx
autonomous: true
requirements:
  - SONG-01
  - SONG-02
  - SONG-06

must_haves:
  truths:
    - "Admin/committee can add a song via dialog with title, artist, key, tempo, tags, duration, links, and notes fields"
    - "Song library page shows dense table with Title, Artist, Key, Tempo, Tags columns"
    - "Search bar filters songs by title/artist with debounced URL params"
    - "Filter chips allow filtering by key and tag"
    - "Admin/committee can edit and delete songs from the table"
    - "Song library is accessible via /songs route (sidebar link already exists)"
  artifacts:
    - path: "app/(app)/songs/page.tsx"
      provides: "Server component song library page with search params filtering"
      min_lines: 30
    - path: "app/(app)/songs/song-search.tsx"
      provides: "Client search input with 300ms debounce pushing to URL params"
    - path: "app/(app)/songs/song-table.tsx"
      provides: "Dense table rendering songs with edit/delete actions"
    - path: "app/(app)/songs/song-form-dialog.tsx"
      provides: "Dialog for creating and editing songs with react-hook-form + Zod"
    - path: "app/(app)/songs/filter-chips.tsx"
      provides: "Key and tag filter chips dynamically populated from DB"
  key_links:
    - from: "app/(app)/songs/page.tsx"
      to: "lib/songs/queries.ts"
      via: "getSongs, getPopularTags, getDistinctKeys server calls"
      pattern: "getSongs|getPopularTags|getDistinctKeys"
    - from: "app/(app)/songs/song-form-dialog.tsx"
      to: "lib/songs/actions.ts"
      via: "createSong/updateSong server action calls"
      pattern: "createSong|updateSong"
    - from: "app/(app)/songs/song-search.tsx"
      to: "URL search params"
      via: "router.replace with debounced query param"
      pattern: "useSearchParams|router\\.replace"
---

<objective>
Build the song library page with dense table layout, search, filter chips, and CRUD dialog.

Purpose: Users can browse, search, filter, add, edit, and delete songs in the library. This is the primary interface for managing the song catalog.
Output: Complete /songs page with table, search, filters, and form dialog
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-song-library-setlists/07-RESEARCH.md
@.planning/phases/07-song-library-setlists/07-01-SUMMARY.md
@app/(app)/team-roster/page.tsx
@components/services/service-form-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Song library page with search, filter chips, and dense table</name>
  <files>
    app/(app)/songs/page.tsx
    app/(app)/songs/song-search.tsx
    app/(app)/songs/filter-chips.tsx
    app/(app)/songs/song-table.tsx
  </files>
  <action>
Create the song library page following the team roster search/filter pattern exactly.

**app/(app)/songs/page.tsx** (server component):
- Read `searchParams` (Promise): `q` (search text), `key` (filter key), `tag` (filter tag)
- Await searchParams, then call `getSongs({ search: params.q, key: params.key, tag: params.tag })`
- Also call `getPopularTags(10)` and `getDistinctKeys()` for filter chip data
- Get `getUserRole(supabase)` to determine canManage (isAdminOrCommittee)
- Layout: page header "Song Library" with song count badge + "Add Song" button (if canManage), then SongSearch, then FilterChips, then SongTable
- "Add Song" button opens SongFormDialog (client component, rendered conditionally)
- Pass canManage, songs, popularTags, distinctKeys to child components

**app/(app)/songs/song-search.tsx** ("use client"):
- Clone the exact pattern from the team roster search (RosterSearch or similar debounced search input)
- Debounced input (300ms via setTimeout/useRef) that pushes `q` param to URL via `router.replace`
- Preserve existing key/tag params when updating search
- Search icon on the left, clear button when non-empty
- Default value from `defaultValue` prop

**app/(app)/songs/filter-chips.tsx** (server component or client):
- Two rows of chips:
  1. Key chips: "All Keys" default + chips for each distinct key from `getDistinctKeys()`
  2. Tag chips: "All Tags" default + chips for each popular tag from `getPopularTags()`
- Each chip is a Link (anchor tag) that sets/clears the corresponding URL param
- Active chip gets highlighted styling (bg-primary text-primary-foreground), inactive gets outline style
- Clicking active chip removes the filter (links to URL without that param)
- Preserve other params (q, tag when clicking key, and vice versa)
- Use Badge component for chips styling, rendered as Link elements

**app/(app)/songs/song-table.tsx** ("use client"):
- Dense table with columns: Title, Artist, Key, Tempo (BPM), Tags
- Per user decision: table rows layout for scanning lots of songs
- On desktop (md+): shadcn Table component with headers
- On mobile (< md): card layout with stacked info (same pattern as team roster: `hidden md:block` for table, `md:hidden` for cards)
- Tags column renders as small Badge components (truncate to first 3 tags + "+N more")
- Key column shows default_key value
- Tempo column shows default_tempo with "BPM" suffix
- Each row has an action dropdown (if canManage) with Edit and Delete options
- Edit opens SongFormDialog in edit mode
- Delete uses AlertDialog confirmation then calls deleteSong server action
- Empty state: "No songs found. Add your first song to get started."
- Clicking a row does NOT navigate anywhere (songs are managed in-place, not detail pages)
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Navigate to /songs in browser -- page should render with search bar, filter chips (empty until songs exist), and empty state message.</verify>
  <done>Song library page renders at /songs with search, filter chips, and table (or empty state). Search updates URL params with debounce. Filter chips link to filtered URLs.</done>
</task>

<task type="auto">
  <name>Task 2: Song form dialog for creating and editing songs</name>
  <files>app/(app)/songs/song-form-dialog.tsx</files>
  <action>
Create the song form dialog following the service form dialog pattern (components/services/service-form-dialog.tsx).

**app/(app)/songs/song-form-dialog.tsx** ("use client"):
- Dialog/DialogContent from shadcn
- Uses react-hook-form with zodResolver and createSongSchema (or updateSongSchema for edit mode)
- Props: `open`, `onOpenChange`, optional `editSong` (for edit mode with pre-populated values)
- Form fields:
  1. **Title** (required): text input
  2. **Artist** (optional): text input
  3. **Default Key** (optional): text input with placeholder "e.g., C, Bb, F#m" -- free text per user decision
  4. **Default Tempo** (optional but recommended): number input with placeholder "BPM", use `setValueAs` (NOT `valueAsNumber: true`) per MEMORY.md to handle NaN properly. Show this prominently per user decision.
  5. **Tags** (optional): custom tag input -- text input where user types a tag and presses Enter/comma to add. Tags show as Badge pills with X to remove. Free-form per user decision.
  6. **Duration** (optional): number input for seconds, or a minutes:seconds input. Keep simple -- just seconds input with helper text "Duration in seconds".
  7. **Links** (optional): dynamic field array. Each link has label input (placeholder "e.g., YouTube, Chord Chart") and URL input. "Add Link" button to add another row. Remove button per row. Per user decision: multiple link slots with labels.
  8. **Notes** (optional): textarea for general notes

- On submit: call createSong or updateSong server action
- Show toast on success, close dialog
- Show toast on error
- Tag input implementation: maintain local tags array state, input + Enter adds tag (trimmed, lowercased, no duplicates), Backspace on empty input removes last tag
- For edit mode: pre-populate all fields from editSong prop
- Use useTransition for pending state on submit button
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Open Add Song dialog, fill in fields, submit -- song should be created and appear in the table.</verify>
  <done>Song form dialog works for both create and edit modes. All fields render correctly. Tags input allows free-form entry. Links support multiple entries with labels. Form validates with Zod and calls appropriate server action.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no TypeScript errors
- /songs page renders with header, search bar, filter chips, and song table
- Add Song button opens dialog, song can be created with all metadata fields
- Created song appears in table after dialog closes
- Search filters songs by title/artist in real-time (debounced)
- Filter chips filter by key and tag
- Edit and delete work from table action menu
- Mobile layout switches to cards
</verification>

<success_criteria>
- Song library page fully functional with CRUD operations
- Search bar with debounced URL params (consistent with team roster pattern)
- Filter chips dynamically populated from database (popular tags + distinct keys)
- Dense table layout per user decision with Title, Artist, Key, Tempo, Tags columns
- Song form dialog with all metadata fields including free-form tags and multiple links
- Mobile responsive with card fallback
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-song-library-setlists/07-02-SUMMARY.md`
</output>
