---
phase: 07-song-library-setlists
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(app)/songs/song-table.tsx
  - app/(app)/songs/filter-chips.tsx
  - app/(app)/songs/song-filters.tsx
  - app/(app)/songs/page.tsx
  - app/(app)/services/[serviceId]/setlist-item-row.tsx
  - app/(app)/services/[serviceId]/setlist-panel.tsx
autonomous: true
requirements: [SONG-02, SONG-03, SONG-04]
gap_closure: true

must_haves:
  truths:
    - "Song table columns have stable widths that do not shift as data grows"
    - "Song table headers are clickable and sort the table client-side"
    - "Filters use a compact Filters button with popover dropdowns instead of inline chips"
    - "Active filters show as badges with X to clear"
    - "Setlist drag-and-drop reorder reflects instantly in the UI before server confirms"
    - "Setlist key/tempo overrides and resets reflect instantly in the UI before server confirms"
  artifacts:
    - path: "app/(app)/songs/song-table.tsx"
      provides: "Stable column widths with sort state and clickable headers"
    - path: "app/(app)/songs/song-filters.tsx"
      provides: "Compact popover-based filter UI replacing inline chips"
    - path: "app/(app)/services/[serviceId]/setlist-panel.tsx"
      provides: "Optimistic drag-and-drop reordering with local state"
    - path: "app/(app)/services/[serviceId]/setlist-item-row.tsx"
      provides: "Optimistic override/reset with callback-based parent updates"
  key_links:
    - from: "app/(app)/songs/song-filters.tsx"
      to: "app/(app)/songs/page.tsx"
      via: "Replaces FilterChips import with SongFilters"
      pattern: "SongFilters"
    - from: "app/(app)/services/[serviceId]/setlist-panel.tsx"
      to: "app/(app)/services/[serviceId]/setlist-item-row.tsx"
      via: "onOptimisticUpdate callback prop for key/tempo/reset changes"
      pattern: "onOptimisticUpdate"
---

<objective>
Close 3 diagnosed UAT gaps for Phase 7 Song Library & Setlists: (1) stabilize song table column widths and add client-side sorting, (2) replace space-wasting inline filter chips with a compact Filters popover, (3) add optimistic UI to setlist operations for instant feedback.

Purpose: All 6 UAT issues are minor UX polish -- table layout stability, filter compactness, and perceived responsiveness.
Output: Updated song-table.tsx, new song-filters.tsx replacing filter-chips.tsx, updated setlist-panel.tsx and setlist-item-row.tsx with optimistic UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-song-library-setlists/07-UAT.md
@app/(app)/songs/song-table.tsx
@app/(app)/songs/filter-chips.tsx
@app/(app)/songs/page.tsx
@app/(app)/services/[serviceId]/setlist-item-row.tsx
@app/(app)/services/[serviceId]/setlist-panel.tsx
@lib/songs/types.ts
@lib/songs/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stabilize song table columns and add client-side sorting</name>
  <files>app/(app)/songs/song-table.tsx</files>
  <action>
Modify the desktop Table in `song-table.tsx` to fix column widths and add client-side sorting:

**Column width constraints:**
- Title: keep `w-[280px]` but add `max-w-[280px]` and add `truncate` to the TableCell
- Artist: add `w-[180px] max-w-[180px]` to TableHead and add `truncate` to the TableCell
- Key: keep `w-[80px]`
- Tempo: keep `w-[90px]`
- Tags: add `w-[200px] max-w-[200px]` to TableHead, add `overflow-hidden` to the TableCell
- Actions column: keep `w-[50px]`

**Add `table-fixed` to the Table element** so column widths are enforced by the header, not content.

**Client-side sorting:**
1. Add sort state: `const [sortField, setSortField] = useState<"title" | "artist" | "key" | "tempo" | null>(null)` and `const [sortDir, setSortDir] = useState<"asc" | "desc">("asc")`
2. Add `useMemo` to compute `sortedSongs` from the `songs` prop based on `sortField` and `sortDir`. Sort logic:
   - `title`: localeCompare on title
   - `artist`: localeCompare on artist (nulls last)
   - `key`: localeCompare on default_key (nulls last)
   - `tempo`: numeric compare on default_tempo (nulls last)
3. Create a `SortableHeader` sub-component that renders a clickable `<button>` inside the TableHead. Clicking toggles: null -> asc -> desc -> null. Display `ArrowUpDown` icon when unsorted, `ArrowUp` when asc, `ArrowDown` when desc. Import these from lucide-react.
4. Replace the static TableHead elements for Title, Artist, Key, Tempo with `SortableHeader` wrappers.
5. Render `sortedSongs` instead of `songs` in the TableBody map.

Do NOT change the mobile card layout -- sorting only applies to the desktop table.
  </action>
  <verify>
    <automated>cd /Users/chungweijian/Desktop/ym-serving-system && pnpm build 2>&1 | tail -5</automated>
    <manual>Visit /songs. Verify columns don't shift when tags/artist text varies. Click column headers to sort. Tags column truncates with overflow hidden.</manual>
  </verify>
  <done>Song table has fixed column widths with truncation on Title/Artist/Tags. All four data columns (Title, Artist, Key, Tempo) are sortable via clickable headers with sort direction icons. Table uses table-fixed layout.</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline filter chips with compact Filters popover</name>
  <files>app/(app)/songs/song-filters.tsx, app/(app)/songs/page.tsx</files>
  <action>
Create a new client component `app/(app)/songs/song-filters.tsx` to replace the server-rendered FilterChips:

**SongFilters component** (`"use client"`):
1. Props: `{ distinctKeys: string[]; popularTags: PopularTag[]; activeKey?: string; activeTag?: string; }` (import PopularTag from `@/lib/songs/types`)
2. Use `useRouter`, `usePathname`, `useSearchParams` from next/navigation (same pattern as SongSearch)
3. Render a single `<Button variant="outline" size="sm">` labeled "Filters" with a `SlidersHorizontal` icon (from lucide-react). When filters are active, show a count badge next to the label (e.g., "Filters (2)").
4. Wrap the button in a `<Popover>` (from `@/components/ui/popover`). The `<PopoverContent>` contains:
   - **Key filter**: A `<Select>` (from `@/components/ui/select`) with placeholder "All Keys". Options are each distinct key. Selecting a key calls `router.replace` with updated `?key=` param. Selecting the placeholder clears the key param.
   - **Tag filter**: A `<Select>` with placeholder "All Tags". Options are each popular tag's `.tag` value. Selecting calls `router.replace` with updated `?tag=` param.
   - A "Clear all" button at the bottom (only shown when filters active) that clears both key and tag params.
5. Below the Filters button (outside the Popover), render active filter badges inline:
   - For active key: `<Badge variant="secondary">Key: {activeKey} <X size={12} onClick={clearKey} /></Badge>`
   - For active tag: `<Badge variant="secondary">Tag: {activeTag} <X size={12} onClick={clearTag} /></Badge>`
   - Each badge's X clears that specific filter param via router.replace.
6. The URL update helper should preserve existing params (q, key, tag) and only modify the relevant one -- same `URLSearchParams` pattern as SongSearch.

**Update page.tsx:**
1. Replace `import { FilterChips } from "./filter-chips"` with `import { SongFilters } from "./song-filters"`
2. Replace the `<FilterChips ... />` usage with `<SongFilters distinctKeys={distinctKeys} popularTags={popularTags} activeKey={keyFilter || undefined} activeTag={tagFilter || undefined} />`
3. Wrap `<SongFilters>` in `<Suspense fallback={null}>` (since it uses useSearchParams)
4. Put `<SongSearch>` and `<SongFilters>` on the same row: `<div className="flex flex-wrap items-center gap-3">` instead of the current `flex-col gap-3` wrapper.

Do NOT delete `filter-chips.tsx` -- just stop importing it. The old file can be cleaned up later.
  </action>
  <verify>
    <automated>cd /Users/chungweijian/Desktop/ym-serving-system && pnpm build 2>&1 | tail -5</automated>
    <manual>Visit /songs. Verify a compact "Filters" button appears next to the search bar. Click it to see Key and Tag dropdowns in a popover. Select a filter -- badge appears with X to clear. Active filter count shows on button.</manual>
  </verify>
  <done>Filters button with popover replaces inline chips. Popover contains Key and Tag Select dropdowns. Active filters show as removable badges below the button. Vertical space reduced from ~60-80px to a single row.</done>
</task>

<task type="auto">
  <name>Task 3: Add optimistic UI to setlist operations</name>
  <files>app/(app)/services/[serviceId]/setlist-panel.tsx, app/(app)/services/[serviceId]/setlist-item-row.tsx</files>
  <action>
Refactor setlist-panel.tsx and setlist-item-row.tsx to use local state for instant UI updates, with non-blocking server sync.

**setlist-panel.tsx changes:**
1. Add local state: `const [localItems, setLocalItems] = useState(items)`. Add `useEffect` to sync when `items` prop changes (from server re-render): `useEffect(() => { setLocalItems(items); }, [items])`.
2. In `handleDragEnd`: immediately call `setLocalItems(arrayMove(localItems, oldIndex, newIndex))` BEFORE the startTransition server call. This gives instant visual reorder.
3. In the startTransition callback: call `reorderSetlist()` then `router.refresh()`. On error, revert: `setLocalItems(items)` and show toast.
4. Render `localItems` instead of `items` everywhere (map, itemIds, existingItemSongIds, empty state check).
5. Add an `onOptimisticUpdate` callback prop to `SetlistItemRow`: `onOptimisticUpdate: (itemId: string, updates: { key_override?: string | null; tempo_override?: number | null }) => void`. Pass this from SetlistPanel to each SetlistItemRow.
6. In `SetlistPanel`, define `handleOptimisticUpdate` that calls `setLocalItems(prev => prev.map(i => i.id === itemId ? { ...i, ...updates } : i))`.

**setlist-item-row.tsx changes:**
1. Add `onOptimisticUpdate` to the `SetlistItemRowProps` interface: `onOptimisticUpdate: (itemId: string, updates: { key_override?: string | null; tempo_override?: number | null }) => void`
2. `handleKeySave(val)`: call `onOptimisticUpdate(item.id, { key_override: val })` immediately, THEN fire the server action in startTransition. On server error, call `onOptimisticUpdate(item.id, { key_override: item.key_override })` to revert, and show toast.
3. `handleTempoSave(val)`: call `onOptimisticUpdate(item.id, { tempo_override: num })` immediately, then fire server action. On error, revert with original `item.tempo_override`.
4. `handleResetKey()`: call `onOptimisticUpdate(item.id, { key_override: null })` immediately, then fire server action. On error, revert.
5. `handleResetTempo()`: call `onOptimisticUpdate(item.id, { tempo_override: null })` immediately, then fire server action. On error, revert.
6. For key/tempo display values: use the item's current values (which now update instantly via parent state).
7. Keep `router.refresh()` inside startTransition but make it non-blocking by not awaiting it -- use `router.refresh()` as fire-and-forget after the successful server action. Pattern: `const result = await serverAction(); if ("error" in result) { revert; toast.error; return; } router.refresh();`

Do NOT change handleNotesSave or handleRemove -- notes editing is not reported as an issue, and remove already has a confirmation dialog that provides perceived responsiveness.
  </action>
  <verify>
    <automated>cd /Users/chungweijian/Desktop/ym-serving-system && pnpm build 2>&1 | tail -5</automated>
    <manual>Navigate to a service with 3+ setlist songs. Drag to reorder -- should reorder instantly. Click a key value, change it -- should show bold blue immediately. Click reset icon -- should revert immediately. No 2-7 second delays.</manual>
  </verify>
  <done>Drag-and-drop reorder updates visually before server confirms. Key/tempo overrides and resets reflect instantly. Server errors revert the optimistic update and show a toast. No perceived delay on any setlist operation.</done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Song table columns maintain fixed widths regardless of content length
3. Clicking sort headers cycles through asc/desc/none with correct icons
4. Filters button opens popover with Key and Tag selects
5. Active filters show as badges with X to clear
6. Setlist drag reorder is visually instant
7. Setlist key/tempo override and reset are visually instant
</verification>

<success_criteria>
All 6 UAT issues from Tests 2, 4, 5, 10, 11, 12 are resolved:
- Song table has stable, non-shifting columns with sort capability
- Filter UI is compact (single Filters button) instead of space-wasting inline chips
- Setlist operations provide instant visual feedback via optimistic updates
</success_criteria>

<output>
After completion, create `.planning/phases/07-song-library-setlists/07-04-SUMMARY.md`
</output>
