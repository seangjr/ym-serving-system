---
phase: 07-song-library-setlists
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - app/(app)/services/[serviceId]/page.tsx
  - app/(app)/services/[serviceId]/service-tabs.tsx
  - app/(app)/services/[serviceId]/setlist-panel.tsx
  - app/(app)/services/[serviceId]/setlist-item-row.tsx
  - app/(app)/services/[serviceId]/song-picker.tsx
  - app/(app)/services/[serviceId]/song-browse-dialog.tsx
  - components/services/service-list.tsx
autonomous: true
requirements:
  - SONG-03
  - SONG-04
  - SONG-05
  - SONG-07

must_haves:
  truths:
    - "Service detail page has tabbed view with Assignments, Setlist, and Details tabs"
    - "Team lead can add songs to setlist via inline search picker or Browse Library dialog"
    - "Setlist items display with numbered rows and drag handles for reordering"
    - "Drag-and-drop reorders setlist items and persists new order via server action"
    - "Song key and tempo can be overridden inline on setlist rows without changing library entry"
    - "Overridden values shown in bold + blue accent with reset button to revert to default"
    - "Per-service notes can be added to setlist items"
    - "Dashboard upcoming services list shows song count per service"
  artifacts:
    - path: "app/(app)/services/[serviceId]/service-tabs.tsx"
      provides: "Client tabs wrapper (Assignments | Setlist | Details)"
    - path: "app/(app)/services/[serviceId]/setlist-panel.tsx"
      provides: "Setlist builder with dnd-kit sortable context"
      min_lines: 50
    - path: "app/(app)/services/[serviceId]/setlist-item-row.tsx"
      provides: "Single sortable setlist row with inline override editing"
    - path: "app/(app)/services/[serviceId]/song-picker.tsx"
      provides: "Inline search combobox for quick song adds"
    - path: "app/(app)/services/[serviceId]/song-browse-dialog.tsx"
      provides: "Full library browse dialog using CommandDialog"
    - path: "app/(app)/services/[serviceId]/page.tsx"
      provides: "Refactored service detail page with tabbed layout"
    - path: "components/services/service-list.tsx"
      provides: "Updated service list with song count display"
  key_links:
    - from: "app/(app)/services/[serviceId]/setlist-panel.tsx"
      to: "lib/songs/actions.ts"
      via: "addToSetlist, removeFromSetlist, reorderSetlist server actions"
      pattern: "addToSetlist|removeFromSetlist|reorderSetlist"
    - from: "app/(app)/services/[serviceId]/setlist-item-row.tsx"
      to: "lib/songs/actions.ts"
      via: "updateSetlistItemOverrides server action"
      pattern: "updateSetlistItemOverrides"
    - from: "app/(app)/services/[serviceId]/page.tsx"
      to: "lib/songs/queries.ts"
      via: "getSetlistForService query"
      pattern: "getSetlistForService"
    - from: "components/services/service-list.tsx"
      to: "lib/songs/queries.ts"
      via: "song count display from parent page"
      pattern: "songCount"
---

<objective>
Build the setlist builder on the service detail page with tabbed layout, drag-and-drop reordering, inline overrides, and integrate song counts into the dashboard service list.

Purpose: Team leads can build per-service setlists by adding songs, reordering them, and customizing key/tempo/notes without modifying the library. Dashboard shows song counts for quick visibility.
Output: Tabbed service detail page with setlist builder, song picker, browse dialog, inline overrides, and dashboard song count integration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-song-library-setlists/07-RESEARCH.md
@.planning/phases/07-song-library-setlists/07-01-SUMMARY.md
@app/(app)/services/[serviceId]/page.tsx
@app/(app)/services/[serviceId]/assignment-panel.tsx
@components/services/service-list.tsx
@components/ui/tabs.tsx
@components/ui/command.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor service detail page to tabbed layout with setlist panel</name>
  <files>
    app/(app)/services/[serviceId]/page.tsx
    app/(app)/services/[serviceId]/service-tabs.tsx
    app/(app)/services/[serviceId]/setlist-panel.tsx
    app/(app)/services/[serviceId]/setlist-item-row.tsx
  </files>
  <action>
Refactor the service detail page to use a tabbed layout and build the core setlist panel.

**app/(app)/services/[serviceId]/service-tabs.tsx** ("use client"):
- Use shadcn Tabs component (radix-ui, already installed at components/ui/tabs.tsx)
- Three tabs: "Assignments", "Setlist", "Details"
- Props: `assignmentsContent`, `setlistContent`, `detailsContent` (all React.ReactNode)
- Default tab: "assignments" (most common use case)
- TabsList styled with full width on mobile, inline on desktop

**app/(app)/services/[serviceId]/page.tsx** (server component refactor):
- Add `getSetlistForService(serviceId)` and `getSongs()` (full list for picker) to the Promise.all data fetch
- Keep the existing back link and header section ABOVE the tabs (unchanged)
- Move the existing "Assignments" section content (AssignmentPanel + PositionAdder + SwapApprovalList) into the `assignmentsContent` prop of ServiceTabs
- Move the existing "Service Details" and "Rehearsal" cards + AvailabilityBanner into the `detailsContent` prop of ServiceTabs
- Create `setlistContent` with the new SetlistPanel component, passing setlist items, all songs, canManage, serviceId
- Import and use ServiceTabs to wrap all three content areas
- The swap requests section should go inside the Assignments tab (it's assignment-related)

**app/(app)/services/[serviceId]/setlist-panel.tsx** ("use client"):
- Replicate the dnd-kit sortable pattern from assignment-panel.tsx
- Uses DndContext, SortableContext, verticalListSortingStrategy, closestCenter from @dnd-kit
- Props: `items` (SetlistItemWithSong[]), `allSongs` (SongSummary[]), `serviceId`, `canManage`
- Renders numbered rows with drag handles via SortableSetlistItem wrapper
- On drag end: call `reorderSetlist` server action with new order of item IDs, then `router.refresh()`
- Use PointerSensor with `activationConstraint: { distance: 5 }` (same as assignment panel) to prevent accidental drags on scroll
- If canManage: show SongPicker (inline search) and "Browse Library" button above the list
- Empty state: dashed border container with Music icon, "No songs in setlist", "Add songs from the library to build your setlist" subtitle (per research recommendation)
- Each item renders via SetlistItemRow component
- Per user decision: drag handle + numbered rows (1, 2, 3... with grip handle on left). No total duration display.

**app/(app)/services/[serviceId]/setlist-item-row.tsx** ("use client"):
- Single setlist row displaying: row number, song title, artist (muted), key (with inline edit), tempo (with inline edit), per-service notes (with inline edit), remove button
- Inline click-to-edit pattern for key, tempo, and notes:
  - Display values as styled text by default
  - Single click opens a compact input (h-7 w-16 for key/tempo, wider for notes)
  - Save on blur or Enter key
  - Cancel on Escape (revert to original value)
  - Per user decision: overridden values shown in bold + blue accent (font-bold text-blue-600 dark:text-blue-400)
  - Reset icon button (RotateCcw from lucide, size-3) next to overridden values to revert to library default
  - Show the effective value: key_override ?? song.default_key, tempo_override ?? song.default_tempo
- On save: call `updateSetlistItemOverrides` server action
- Remove button (Trash2 icon) calls `removeFromSetlist` server action with confirmation
- Use useTransition for pending states
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Navigate to a service detail page -- should see three tabs. Assignments tab shows existing content. Setlist tab shows empty state or list of songs. Details tab shows service info cards.</verify>
  <done>Service detail page has working tabbed layout. Setlist panel renders with drag-and-drop reordering. Inline override editing works for key, tempo, and notes with bold+blue styling for overridden values. Remove button works with re-numbering.</done>
</task>

<task type="auto">
  <name>Task 2: Song picker, browse dialog, and dashboard song count integration</name>
  <files>
    app/(app)/services/[serviceId]/song-picker.tsx
    app/(app)/services/[serviceId]/song-browse-dialog.tsx
    components/services/service-list.tsx
  </files>
  <action>
Build the two song-adding interfaces and integrate song counts into the dashboard.

**app/(app)/services/[serviceId]/song-picker.tsx** ("use client"):
- Inline search picker for quick song adds (per user decision: one of two ways to add songs)
- Use @base-ui/react Combobox (same pattern as assignment-slot.tsx for member assignment)
- Combobox with object values: { value: songId, label: `${title} - ${artist}` }
- Filter songs client-side via Combobox's built-in search filtering
- On select: call `addToSetlist({ serviceId, songId })` server action, then router.refresh()
- Clear selection after adding
- Compact input with "Search songs..." placeholder and Music icon
- Show useTransition pending state while adding
- Props: `allSongs` (SongSummary[]), `serviceId`, `existingItemSongIds` (string[] to show which songs are already in the setlist -- but still allow adding duplicates per research decision)

**app/(app)/services/[serviceId]/song-browse-dialog.tsx** ("use client"):
- Full library browse dialog (per user decision: second way to add songs)
- Use CommandDialog from shadcn/cmdk (components/ui/command.tsx)
- Opens via "Browse Library" button in setlist panel
- Search input at top (built into CommandDialog)
- Scrollable list of songs below, each showing title, artist, key, tempo
- Click a song to add it to setlist (call addToSetlist, keep dialog open for adding multiple)
- Songs already in the setlist show a small checkmark icon (but can still be added again)
- Group songs by first letter or show flat list (flat list is simpler, prefer that)
- CommandEmpty: "No songs found. Add songs to the library first."
- Props: `open`, `onOpenChange`, `allSongs`, `serviceId`, `existingItemSongIds`

**components/services/service-list.tsx** (modify existing):
- Add `songCount` to the `ServiceListService` interface (optional number)
- Display song count next to each service in the list: show a small Music icon + count (e.g., "3 songs") below the service type badge, only if songCount > 0
- Style: text-xs text-muted-foreground with Music icon size-3
- The parent dashboard page.tsx will need to pass song counts down. Add a comment noting the parent needs to call `getSongCountsForServices` and map counts to services. Update the dashboard page.tsx to:
  1. Import `getSongCountsForServices` from lib/songs/queries
  2. After fetching upcoming services, call `getSongCountsForServices(serviceIds)`
  3. Map songCount onto each service object before passing to ServiceList
- Update the `ServiceListProps` interface and `ServiceListService` interface to include `songCount?: number`
- In the dashboard page.tsx: add the getSongCountsForServices call to the data fetching, merge counts into the services array passed to ServiceList
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. On a service detail page, use the inline picker to add a song, then use Browse Library to add another. Dashboard should show song counts next to services that have setlist items.</verify>
  <done>Both song adding methods work (inline picker and browse dialog). Songs can be added to setlist from both. Dashboard service list shows song count per service with Music icon. All changes build without errors.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes with no TypeScript errors
- Service detail page shows three tabs: Assignments, Setlist, Details
- Existing assignment functionality is preserved and works in Assignments tab
- Service details and rehearsal cards appear in Details tab
- Setlist tab shows empty state or list of songs with drag handles and numbers
- Drag-and-drop reorders items and persists via server action
- Inline song picker adds songs via search
- Browse Library dialog shows all songs with search, clicking adds to setlist
- Key and tempo inline editing works with bold+blue for overridden values
- Reset button reverts override to library default
- Per-service notes editable inline
- Remove button deletes item and re-numbers remaining
- Dashboard service list shows song count with Music icon
</verification>

<success_criteria>
- Tabbed service detail page per user decision (Assignments | Setlist | Details)
- Two song adding methods per user decision (inline picker + browse dialog)
- Drag-and-drop with numbered rows and grip handles per user decision
- Inline click-to-edit for key, tempo, notes per user decision
- Overridden values in bold + blue accent with reset button per user decision
- No total duration display per user decision
- Dashboard shows song count per service (SONG-07)
- `pnpm build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-song-library-setlists/07-03-SUMMARY.md`
</output>
