---
phase: 05-availability-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/(app)/availability/page.tsx
  - app/(app)/availability/availability-calendar.tsx
  - app/(app)/availability/blackout-manager.tsx
  - app/(app)/availability/recurring-pattern-dialog.tsx
  - app/(app)/availability/recurring-pattern-list.tsx
  - app/(app)/availability/team-overlay-calendar.tsx
  - app/(app)/availability/member-selector.tsx
autonomous: true

must_haves:
  truths:
    - "Member can navigate to /availability from sidebar and see their own availability calendar"
    - "Member can click a single date on the calendar to add a blackout date with optional reason"
    - "Member can select a date range to add a multi-day blackout (vacation)"
    - "Member can create recurring unavailability patterns (weekly, biweekly, monthly, nth_weekday)"
    - "Member can delete blackout dates and recurring patterns they created"
    - "Calendar visually distinguishes one-time blackouts (solid red) from recurring unavailability (hatched amber)"
    - "Team leads see a member selector dropdown to manage availability on behalf of their team members"
    - "Team leads can switch to Team Overview tab showing X/Y available counts per date"
    - "Everyone can view teammates' availability (read-only)"
  artifacts:
    - path: "app/(app)/availability/page.tsx"
      provides: "Server component page for /availability route with data fetching"
      contains: "export default async function AvailabilityPage"
    - path: "app/(app)/availability/availability-calendar.tsx"
      provides: "Client component with custom DayButton for availability visualization"
      contains: "AvailabilityCalendarContext"
    - path: "app/(app)/availability/blackout-manager.tsx"
      provides: "Client component for adding/removing blackout dates with calendar click and range mode"
      contains: "BlackoutManager"
    - path: "app/(app)/availability/recurring-pattern-dialog.tsx"
      provides: "Dialog for creating recurring unavailability patterns"
      contains: "RecurringPatternDialog"
    - path: "app/(app)/availability/recurring-pattern-list.tsx"
      provides: "List of active recurring patterns with delete capability"
      contains: "RecurringPatternList"
    - path: "app/(app)/availability/team-overlay-calendar.tsx"
      provides: "Team lead calendar view showing available/total counts per date"
      contains: "TeamOverlayCalendar"
    - path: "app/(app)/availability/member-selector.tsx"
      provides: "Dropdown for team leads to switch between managing own vs team member availability"
      contains: "MemberSelector"
  key_links:
    - from: "app/(app)/availability/blackout-manager.tsx"
      to: "lib/availability/actions.ts"
      via: "addBlackoutDate/addBlackoutRange/deleteBlackout server actions"
      pattern: "addBlackoutDate|addBlackoutRange|deleteBlackout"
    - from: "app/(app)/availability/recurring-pattern-dialog.tsx"
      to: "lib/availability/actions.ts"
      via: "createRecurringPattern server action"
      pattern: "createRecurringPattern"
    - from: "app/(app)/availability/page.tsx"
      to: "lib/availability/queries.ts"
      via: "Server-side data fetching for blackouts, patterns, and team availability"
      pattern: "getMyBlackouts|getMyRecurringPatterns|getTeamAvailability"
    - from: "app/(app)/availability/availability-calendar.tsx"
      to: "lib/availability/recurrence.ts"
      via: "expandRecurringPatterns to compute recurring dates for calendar display"
      pattern: "expandRecurringPatterns"
---

<objective>
Build the /availability page with interactive calendar for managing blackout dates, recurring patterns, and team availability overlay.

Purpose: This is the primary UI for AVAIL-01, AVAIL-02, and AVAIL-04 -- members manage their availability and team leads reference it during scheduling decisions.

Output: A complete /availability page with calendar visualization, blackout date management, recurring pattern management, member selector for team leads, and team overlay view.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-availability-management/05-RESEARCH.md
@.planning/phases/05-availability-management/05-01-SUMMARY.md

# Key patterns to follow:
@components/services/service-calendar.tsx
@app/(app)/services/[serviceId]/page.tsx
@components/ui/calendar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Availability page, calendar component, and blackout manager</name>
  <files>
    app/(app)/availability/page.tsx
    app/(app)/availability/availability-calendar.tsx
    app/(app)/availability/blackout-manager.tsx
    app/(app)/availability/member-selector.tsx
  </files>
  <action>
**page.tsx (server component):**
Follow the service detail page pattern (server component fetching data, passing to client components).

1. Get user role and memberId via getUserRole(supabase)
2. Determine `targetMemberId` from URL searchParams `?member=` (for team leads managing others) -- defaults to own memberId
3. If targetMemberId != own memberId, verify authorization: admin/committee always allowed, or check team lead access via team_members table
4. Fetch in parallel: getMyBlackouts(targetMemberId), getMyRecurringPatterns(targetMemberId)
5. For team leads (admin/committee or has lead role on any team): also fetch team members list for member-selector dropdown and team list for overlay tab
6. Render layout with Tabs (shadcn/ui): "My Availability" tab + "Team Overview" tab (team overview only visible for admin/committee/team leads)
7. Pass data to client components: AvailabilityCalendar, BlackoutManager, RecurringPatternList, RecurringPatternDialog

Layout structure:
```
<Tabs defaultValue="my-availability">
  <TabsList>
    <TabsTrigger value="my-availability">My Availability</TabsTrigger>
    {isTeamLead && <TabsTrigger value="team-overview">Team Overview</TabsTrigger>}
  </TabsList>

  <TabsContent value="my-availability">
    {isTeamLead && <MemberSelector ... />}
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div className="lg:col-span-2">
        <BlackoutManager ... />
      </div>
      <div>
        <RecurringPatternList ... />
        <RecurringPatternDialog ... />
      </div>
    </div>
  </TabsContent>

  <TabsContent value="team-overview">
    <TeamOverlayCalendar ... />
  </TabsContent>
</Tabs>
```

**member-selector.tsx (client component):**
A dropdown at the top of the "My Availability" tab. Shows "Managing: [My Availability]" by default.
- When a team lead selects a different member, navigate to `/availability?member={memberId}` using router.push
- Use shadcn/ui Select component with position="popper" and max-h-48 (following established pattern)
- Options: "My Availability" (default) + list of team members the current user can manage
- Admin/committee see all serving members (use fetchAllMembers pattern from Phase 2)
- Team leads see only their team members
- Regular members don't see this component at all

**availability-calendar.tsx (client component):**
Follow the ServiceCalendar custom DayButton pattern exactly from components/services/service-calendar.tsx.

1. Create `AvailabilityCalendarContext` with `blackoutDates: Map<string, string | null>` (dateString -> reason) and `recurringDates: Map<string, string | null>` (dateString -> reason)
2. Create `AvailabilityDayButton` component (same signature as ServiceDayButton):
   - Check if day is in blackoutDates map -> solid red background (`bg-red-100 dark:bg-red-900/30`) with small red dot
   - Check if day is in recurringDates map -> hatched amber background with CSS `repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(251, 146, 60, 0.15) 3px, rgba(251, 146, 60, 0.15) 6px)` over `bg-amber-50 dark:bg-amber-900/20` with small orange dot
   - Blackout takes visual precedence when both apply (solid red, not hatched)
   - Past dates: dimmed with `opacity-50`, not clickable for adding new blackouts
   - Show today with existing `today` modifier styling
3. The calendar supports both single click and range selection. Controlled by BlackoutManager which wraps it.
4. Use `expandRecurringPatterns` from lib/availability/recurrence.ts to compute recurring dates for the visible month range. Import is safe since recurrence.ts is a pure module.
5. Render with shadcn Calendar component, passing `components={{ DayButton: AvailabilityDayButton }}` and `disabled={{ before: new Date() }}` for past dates.

**blackout-manager.tsx (client component):**
Wraps the AvailabilityCalendar and provides the blackout CRUD controls.

1. State: `mode: 'view' | 'single' | 'range'` to toggle between viewing, single-click adding, and range selection
2. In `view` mode: calendar is read-only, shows existing blackouts and recurring dates
3. In `single` mode: clicking a date calls addBlackoutDate server action. Show a small reason input (optional) that appears above the calendar.
4. In `range` mode: use react-day-picker `mode="range"` to select start/end dates, then show reason input and submit button. Call addBlackoutRange.
5. Toggle buttons above calendar: "View" / "Add Date" / "Add Range" (using Button group or segmented control)
6. Below calendar: list of existing blackout dates as a simple list with date(s), reason, and delete button (Trash2 icon). Call deleteBlackout on click with toast confirmation.
7. Toast feedback via sonner for add/delete operations (toast.success / toast.error)

Use startTransition + useTransition for pending states during server actions.
  </action>
  <verify>
    Run `pnpm build` to confirm all components compile. Navigate to /availability in browser and verify the calendar renders with mode toggle buttons.
  </verify>
  <done>
    /availability page renders with calendar, blackout management (single + range), member selector for team leads, and correct visual styling (red for blackouts, hatched amber for recurring).
  </done>
</task>

<task type="auto">
  <name>Task 2: Recurring pattern dialog, pattern list, and team overlay calendar</name>
  <files>
    app/(app)/availability/recurring-pattern-dialog.tsx
    app/(app)/availability/recurring-pattern-list.tsx
    app/(app)/availability/team-overlay-calendar.tsx
  </files>
  <action>
**recurring-pattern-dialog.tsx (client component):**
A Dialog (shadcn/ui) for creating recurring unavailability patterns.

1. Form with react-hook-form + zodResolver using createRecurringPatternSchema
2. Fields:
   - Frequency: Select dropdown with options: Weekly, Every Other Week (biweekly), Monthly (same day of month), Nth Weekday of Month (nth_weekday)
   - Day of Week: Select dropdown (Sunday through Saturday, values 0-6)
   - Nth Occurrence: Select dropdown (1st, 2nd, 3rd, 4th, Last) -- only visible when frequency is 'nth_weekday'
   - Start Date: Date picker (use the Calendar component in a Popover, matching existing date picker patterns)
   - End Date: Optional date picker. Show "No end date (ongoing)" checkbox/toggle -- when checked, end_date is null
   - Reason: optional Textarea
3. On submit: call createRecurringPattern server action with the form data + targetMemberId
4. Show a friendly description preview: e.g. "Every Wednesday", "Every other Sunday starting Feb 14", "First Saturday of every month"
5. Accept targetMemberId prop so team leads can create patterns on behalf of members
6. Success: toast + close dialog. Error: toast.error.

**recurring-pattern-list.tsx (client component):**
Displays active recurring patterns for the selected member.

1. Render as a Card with "Recurring Patterns" title and Plus button to open RecurringPatternDialog
2. Each pattern shows: frequency description (human-readable), day of week name, start date, end date or "Ongoing", reason (if set)
3. Delete button (Trash2 icon) on each pattern -- calls deleteRecurringPattern server action
4. Empty state: "No recurring patterns set" with a prompt to add one
5. Human-readable descriptions:
   - weekly: "Every {DayName}"
   - biweekly: "Every other {DayName}"
   - monthly: "{DayOfMonth}th of every month"
   - nth_weekday: "{Nth} {DayName} of every month"

**team-overlay-calendar.tsx (client component):**
Calendar for team leads showing "X/Y available" counts per date.

1. Props: teams list (for team selector), initial teamId, initial month
2. Team selector: Select dropdown at top to choose which team to view
3. When team or month changes: fetch availability data via a server action wrapper (fetchTeamAvailability that wraps getTeamAvailability query)
4. Custom DayButton shows availability count instead of day number below the date:
   - Each day cell shows the date number + a small text below showing "{available}/{total}"
   - Color-code: green when all available, amber when some unavailable, red when >50% unavailable
   - Tooltip on hover: lists the unavailable member names and reasons
5. Month navigation using the same Calendar component pattern
6. Add the `fetchTeamAvailability` server action wrapper in lib/availability/actions.ts (same pattern as fetchTemplates in assignments: `export async function fetchTeamAvailability(teamId, monthStart, monthEnd) { return getTeamAvailability(teamId, monthStart, monthEnd); }`)
  </action>
  <verify>
    Run `pnpm build` to confirm all components compile. Run `pnpm lint` to check formatting. Navigate to /availability, verify recurring pattern dialog opens, pattern list renders, and team overlay tab shows calendar with counts.
  </verify>
  <done>
    Recurring pattern dialog creates patterns with all 4 frequency types. Pattern list shows human-readable descriptions with delete capability. Team overlay calendar shows X/Y counts per date with color coding. All data flows through server actions with proper revalidation.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm lint` passes with no Biome issues
3. /availability page is accessible from sidebar navigation for all roles
4. Calendar shows blackout dates in red and recurring dates in hatched amber
5. Single-date blackout can be added by clicking a date
6. Date range blackout can be added using range selection mode
7. Recurring patterns can be created with all 4 frequency types
8. Team leads see member selector dropdown and Team Overview tab
9. Team overlay shows availability counts per date
10. Past dates are dimmed and not interactive for new blackouts
</verification>

<success_criteria>
- /availability page renders with full calendar UI
- Blackout dates can be added (single + range) and deleted
- Recurring patterns can be created (4 types) and deleted
- Team leads can manage availability for team members
- Team overlay shows X/Y available counts
- Visual distinction between one-time (red) and recurring (amber hatched) unavailability
</success_criteria>

<output>
After completion, create `.planning/phases/05-availability-management/05-02-SUMMARY.md`
</output>
