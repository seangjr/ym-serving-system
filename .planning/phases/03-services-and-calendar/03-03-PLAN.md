---
phase: 03-services-and-calendar
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - components/services/recurring-service-dialog.tsx
  - components/services/duplicate-service-dialog.tsx
  - components/services/service-type-manager.tsx
  - app/(app)/services/[serviceId]/page.tsx
  - app/(app)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can open a recurring services dialog, select frequency (weekly/biweekly/monthly), date range, time, type, and title template, and create multiple service instances at once"
    - "Admin can duplicate an existing service to a new date from the service detail page or upcoming list"
    - "Admin can view and manage service types (add, edit, delete) including name, label, and color"
    - "Service detail page shows full service information: title, date, time, type, duration, rehearsal details, notes, and action buttons for edit/duplicate/delete"
    - "Recurring service creation is capped at 52 instances with clear feedback on how many services will be created"
  artifacts:
    - path: "components/services/recurring-service-dialog.tsx"
      provides: "Dialog for creating recurring service patterns"
      exports: ["RecurringServiceDialog"]
    - path: "components/services/duplicate-service-dialog.tsx"
      provides: "Dialog for duplicating a service to a new date"
      exports: ["DuplicateServiceDialog"]
    - path: "components/services/service-type-manager.tsx"
      provides: "Admin UI for managing service types (CRUD)"
      exports: ["ServiceTypeManager"]
    - path: "app/(app)/services/[serviceId]/page.tsx"
      provides: "Service detail page showing full info and action buttons"
      contains: "getServiceById"
  key_links:
    - from: "components/services/recurring-service-dialog.tsx"
      to: "lib/services/actions.ts"
      via: "createRecurringServices action call"
      pattern: "createRecurringServices"
    - from: "components/services/duplicate-service-dialog.tsx"
      to: "lib/services/actions.ts"
      via: "duplicateService action call"
      pattern: "duplicateService"
    - from: "components/services/service-type-manager.tsx"
      to: "lib/services/actions.ts"
      via: "createServiceType, updateServiceType, deleteServiceType action calls"
      pattern: "createServiceType|updateServiceType|deleteServiceType"
    - from: "app/(app)/services/[serviceId]/page.tsx"
      to: "lib/services/queries.ts"
      via: "getServiceById query"
      pattern: "getServiceById"
---

<objective>
Build the advanced service features: recurring service creation, service duplication, service type configuration, and the service detail page.

Purpose: Completes the Phase 3 feature set. Recurring services (SERV-05) eliminate tedious manual creation of weekly/biweekly services. Duplication (SERV-07) enables quick setup from existing services. Type configuration (SERV-08) lets admins manage service categories. The detail page provides a foundation for Phase 4 (assignment UI).

Output: 3 dialog components, 1 manager component, and the service detail page.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-services-and-calendar/03-RESEARCH.md
@.planning/phases/03-services-and-calendar/03-01-SUMMARY.md
@.planning/phases/03-services-and-calendar/03-02-SUMMARY.md
@lib/services/schemas.ts
@lib/services/actions.ts
@lib/services/queries.ts
@lib/services/recurrence.ts
@components/services/service-form-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Recurring service dialog and duplicate service dialog</name>
  <files>
components/services/recurring-service-dialog.tsx
components/services/duplicate-service-dialog.tsx
  </files>
  <action>
**components/services/recurring-service-dialog.tsx** -- "use client" component:

Dialog for creating a batch of recurring services from a pattern.

Props:
```typescript
interface RecurringServiceDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  serviceTypes: { id: string; name: string; label: string; color: string }[];
}
```

Form fields (from createRecurringSchema):
- Title Template (Input, required -- e.g., "Sunday Morning Service")
- Frequency (Select: Weekly, Biweekly, Monthly)
- Start Date (date picker via Popover + Calendar)
- End Date (date picker via Popover + Calendar)
- Day of Week (Select: Sunday through Saturday, optional -- auto-derived from start date if not set)
- Start Time (Input type="time")
- End Time (Input type="time", optional)
- Duration (Input type="number" in minutes, optional)
- Service Type (Select dropdown from serviceTypes prop)

Behavior:
- Use react-hook-form with zodResolver and createRecurringSchema
- Show a preview count: when frequency + start/end dates are filled, compute and display "This will create N services" using generateRecurringDates from lib/services/recurrence.ts (call it client-side for preview -- it's a pure function with no server dependencies)
- If count exceeds 52, show a warning: "Maximum 52 services per pattern. Adjust end date."
- On submit: call createRecurringServices(data) from lib/services/actions.ts
- On success: toast.success(`Created ${count} services`), close dialog
- On error: toast.error with error message
- Use 2-column grid layout for the form fields

**components/services/duplicate-service-dialog.tsx** -- "use client" component:

Simple dialog for duplicating a service to a new date.

Props:
```typescript
interface DuplicateServiceDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  sourceService: { id: string; title: string; serviceDate: string };
}
```

Form fields:
- Source service display (read-only: title and original date)
- Target Date (date picker via Popover + Calendar, required)

Behavior:
- Use react-hook-form with zodResolver and duplicateServiceSchema
- sourceServiceId is pre-filled from sourceService.id (hidden field or set in onSubmit)
- On submit: call duplicateService({ sourceServiceId, targetDate }) from lib/services/actions.ts
- On success: toast.success("Service duplicated"), close dialog
- On error: toast.error with error message
- Compact dialog -- just the date picker and submit button
  </action>
  <verify>
Run `pnpm build` -- must compile. Verify RecurringServiceDialog imports and calls createRecurringServices. Verify DuplicateServiceDialog imports and calls duplicateService. Check that generateRecurringDates is imported for the preview count.
  </verify>
  <done>
RecurringServiceDialog shows a form for creating recurring services with live preview count capped at 52 instances. DuplicateServiceDialog allows selecting a new date to copy a service.
  </done>
</task>

<task type="auto">
  <name>Task 2: Service type manager, service detail page, and dashboard integration</name>
  <files>
components/services/service-type-manager.tsx
app/(app)/services/[serviceId]/page.tsx
app/(app)/dashboard/page.tsx
  </files>
  <action>
**components/services/service-type-manager.tsx** -- "use client" component:

Admin-only UI for managing service types (SERV-08).

Props:
```typescript
interface ServiceTypeManagerProps {
  serviceTypes: { id: string; name: string; label: string; color: string; sortOrder: number; isActive: boolean }[];
}
```

Implementation:
- Render as a Card with a list of current service types
- Each type row shows: colored dot (matching hex color), label, name (muted), and action buttons (Edit, Delete)
- "Add Type" button at the bottom opens an inline form (not a dialog -- follow PositionManager inline form pattern from teams)
- Inline form fields: name (slug), label, color (hex Input with a small color preview square), sort_order (number)
- Edit: same inline form, pre-filled with existing values
- Delete: window.confirm before calling deleteServiceType
- All actions call createServiceType/updateServiceType/deleteServiceType from lib/services/actions.ts
- Use sonner toast for feedback

Where to place: This component will be rendered on the dashboard page inside a collapsible section or via a settings Dialog accessible from the dashboard header (gear icon). For simplicity, add a "Manage Types" button in the dashboard header (admin-only) that opens a Dialog containing ServiceTypeManager.

**app/(app)/services/[serviceId]/page.tsx** -- server component:

Service detail page -- a scaffold for Phase 4 to add assignment UI.

Implementation:
- Fetch service: `const service = await getServiceById(params.serviceId)`
- If not found, call `notFound()` from next/navigation
- Fetch user role for action buttons
- Fetch service types for edit dialog

Layout:
```
<div className="flex flex-col gap-6">
  <!-- Back link -->
  <Link href="/dashboard" className="flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground">
    <ArrowLeft className="size-4" /> Back to Dashboard
  </Link>

  <!-- Header: title + action buttons -->
  <div className="flex items-center justify-between">
    <div>
      <div className="flex items-center gap-2">
        <h1 className="text-2xl font-bold">{service.title}</h1>
        {service.isCancelled && <Badge variant="destructive">Cancelled</Badge>}
        {service.serviceType && <Badge style={{ backgroundColor: service.serviceType.color }}>{service.serviceType.label}</Badge>}
      </div>
      <p className="text-muted-foreground">{formatted date}</p>
    </div>
    {isAdminOrCommittee(role) && <ServiceDetailActions ... />}
  </div>

  <!-- Service info grid -->
  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
    <Card> <!-- Service Details -->
      <CardHeader><CardTitle>Service Details</CardTitle></CardHeader>
      <CardContent>
        - Date: formatted service_date
        - Time: start_time - end_time (or just start_time)
        - Duration: duration_minutes + " minutes" (if set)
        - Type: service type label with color dot
        - Notes: service notes
      </CardContent>
    </Card>

    <Card> <!-- Rehearsal Details (if any) -->
      <CardHeader><CardTitle>Rehearsal</CardTitle></CardHeader>
      <CardContent>
        - Date: rehearsal_date (or "No rehearsal scheduled")
        - Time: rehearsal_time
        - Notes: rehearsal_notes
      </CardContent>
    </Card>
  </div>

  <!-- Assignments placeholder for Phase 4 -->
  <Card>
    <CardHeader><CardTitle>Assignments</CardTitle></CardHeader>
    <CardContent>
      <div className="flex items-center justify-center rounded-lg border border-dashed p-8">
        <p className="text-sm text-muted-foreground">
          Team assignments will be available after Phase 4 (Scheduling & Assignments).
        </p>
      </div>
    </CardContent>
  </Card>
</div>
```

Create a "use client" wrapper `ServiceDetailActions` that renders action buttons:
- Edit button (opens ServiceFormDialog in edit mode)
- Duplicate button (opens DuplicateServiceDialog)
- Delete button (calls deleteService with confirmation, redirects to /dashboard on success)

**app/(app)/dashboard/page.tsx** -- update:

Add integration points for the new dialogs:
- Add "Create Recurring" button next to "Create Service" in the DashboardActions wrapper (admin/committee only). This opens RecurringServiceDialog.
- Add "Manage Types" button (admin only -- use isAdmin check) that opens a Dialog containing ServiceTypeManager.
- Both buttons should be in a small button group or dropdown: Primary "Create Service" button + secondary dropdown with "Create Recurring Series" and "Manage Service Types" options.

Pattern: Use a DropdownMenu attached to a secondary button (ChevronDown icon) next to the primary "Create Service" button, or use a split button pattern. The dropdown contains "Create Recurring Series" and "Manage Service Types" (admin only).

Make sure to import and render RecurringServiceDialog and manage its open state in DashboardActions.
  </action>
  <verify>
Run `pnpm build` -- must compile without errors. Run `pnpm lint` -- must pass. Navigate to /services/[any-valid-id] to confirm the detail page renders. Check dashboard for Create Service + dropdown with recurring/type management options.
  </verify>
  <done>
ServiceTypeManager lets admin CRUD service types with color configuration. Service detail page shows full service info with edit/duplicate/delete actions. Dashboard integrates recurring service creation and type management via dropdown menu. Phase 4 assignment placeholder is visible on detail page.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm lint` passes with no errors on new/modified files
3. Recurring service dialog shows live preview count and calls createRecurringServices
4. Duplicate service dialog copies service to new date
5. Service type manager allows admin to add, edit, and delete service types
6. Service detail page at /services/[serviceId] shows all service fields and action buttons
7. Dashboard has dropdown with "Create Recurring Series" and "Manage Service Types" options
8. Service detail page includes Phase 4 assignment placeholder
</verification>

<success_criteria>
- RecurringServiceDialog validates with createRecurringSchema, shows preview count, caps at 52 instances
- DuplicateServiceDialog calls duplicateService with source ID and target date
- ServiceTypeManager follows inline form pattern (like PositionManager) for add/edit types
- Service detail page renders service info in 2-column grid with rehearsal card
- Dashboard actions include primary create button and secondary dropdown for advanced options
</success_criteria>

<output>
After completion, create `.planning/phases/03-services-and-calendar/03-03-SUMMARY.md`
</output>
