---
phase: 03-services-and-calendar
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - components/services/service-calendar.tsx
  - components/services/service-form-dialog.tsx
  - components/services/service-list.tsx
  - components/services/service-stats.tsx
  - app/(app)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows a calendar month view with colored dots on days that have services, each dot matching the service type color"
    - "User can navigate between months using previous/next buttons on the calendar"
    - "Admin/committee user can open a Create Service dialog from the dashboard and fill in title, date, time, type, duration, rehearsal info, and notes"
    - "Dashboard shows an upcoming services list with service title, date, time, type badge, and placeholder assignment stats"
    - "Dashboard shows stats cards with upcoming services count, and placeholder cards for unassigned positions and pending confirmations"
    - "Dashboard is responsive: side-by-side calendar+list on desktop, stacked on mobile"
  artifacts:
    - path: "components/services/service-calendar.tsx"
      provides: "Month calendar with color-coded service dots and month navigation"
      exports: ["ServiceCalendar"]
    - path: "components/services/service-form-dialog.tsx"
      provides: "Create and edit service dialog with all SERV-01/SERV-06 fields"
      exports: ["ServiceFormDialog"]
    - path: "components/services/service-list.tsx"
      provides: "Upcoming services list with type badges and stats"
      exports: ["ServiceList"]
    - path: "components/services/service-stats.tsx"
      provides: "Stats cards for dashboard header"
      exports: ["ServiceStats"]
    - path: "app/(app)/dashboard/page.tsx"
      provides: "Dashboard page assembling calendar, list, stats, and create button"
      contains: "ServiceCalendar"
  key_links:
    - from: "components/services/service-calendar.tsx"
      to: "react-day-picker DayPicker"
      via: "Custom DayButton component rendering colored dots"
      pattern: "DayButton"
    - from: "components/services/service-form-dialog.tsx"
      to: "lib/services/actions.ts"
      via: "createService/updateService server action call"
      pattern: "createService"
    - from: "app/(app)/dashboard/page.tsx"
      to: "lib/services/queries.ts"
      via: "Server component data fetching"
      pattern: "getServicesByMonth|getUpcomingServices|getServiceStats"
---

<objective>
Build the complete services dashboard UI: a calendar month view with color-coded service indicators, an upcoming services list, stats cards, and a create/edit service dialog.

Purpose: This is the primary interface users see when they open the app. It transforms the placeholder dashboard into a functional services hub where admins can create services and all users can see the schedule at a glance. Satisfies SERV-01, SERV-02, SERV-03, SERV-04, SERV-06, SERV-09.

Output: 4 components in components/services/ and a rewritten dashboard page.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-services-and-calendar/03-RESEARCH.md
@.planning/phases/03-services-and-calendar/03-01-SUMMARY.md
@components/ui/calendar.tsx
@lib/services/schemas.ts
@lib/services/queries.ts
@lib/services/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Service calendar component and create/edit form dialog</name>
  <files>
components/services/service-calendar.tsx
components/services/service-form-dialog.tsx
  </files>
  <action>
**components/services/service-calendar.tsx** -- "use client" component:

Build a custom calendar that shows colored dots for services on each day. Use the existing shadcn Calendar component (`@/components/ui/calendar`) as the base and extend it via the `components` prop to customize the DayButton.

Props interface:
```typescript
interface CalendarService {
  id: string;
  serviceDate: string; // YYYY-MM-DD
  title: string;
  color: string; // hex from service_types
  typeLabel: string;
}

interface ServiceCalendarProps {
  services: CalendarService[];
  month: Date;
  onMonthChange: (month: Date) => void;
  onDayClick?: (date: Date) => void;
}
```

Implementation:
- Use the shadcn `Calendar` component from `@/components/ui/calendar` as the base
- Override the `DayButton` via `components={{ DayButton: ServiceDayButton }}` where `ServiceDayButton` extends the existing `CalendarDayButton` to add colored dots below the date number
- The custom DayButton should:
  - Render the default button content (date number)
  - Below the date number, render up to 3 small colored dots (size 1.5, rounded-full) for services on that day
  - If >3 services on one day, show 3 dots (truncate)
  - Use `isSameDay` from date-fns to match services to dates (parse serviceDate with parseISO)
- Pass services data into the custom DayButton via a React context (create ServiceCalendarContext with services array) since DayButton components prop doesn't directly accept extra props
- Month navigation is handled by Calendar's controlled `month`/`onMonthChange` props
- onDayClick: when a day is clicked and it has services, call onDayClick with the date (for future navigation to service detail)
- Export `ServiceCalendar` and `CalendarService` type

**components/services/service-form-dialog.tsx** -- "use client" component:

Create a Dialog for creating and editing services. Uses react-hook-form with zodResolver and the createServiceSchema / updateServiceSchema from lib/services/schemas.ts.

Props interface:
```typescript
interface ServiceFormDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  serviceTypes: { id: string; name: string; label: string; color: string }[];
  editService?: { id: string; title: string; serviceDate: string; startTime: string; endTime?: string; durationMinutes?: number; serviceTypeId?: string; rehearsalDate?: string; rehearsalTime?: string; rehearsalNotes?: string; notes?: string };
}
```

Form fields (all from SERV-01 + SERV-06):
- Title (Input, required)
- Service Date (date picker -- use shadcn Popover + Calendar for date selection, format as YYYY-MM-DD)
- Start Time (Input type="time")
- End Time (Input type="time", optional)
- Duration (Input type="number" in minutes, optional -- show as helper if endTime is not set)
- Service Type (Select dropdown populated from serviceTypes prop)
- Rehearsal Date (date picker, optional)
- Rehearsal Time (Input type="time", optional)
- Rehearsal Notes (Textarea, optional)
- Notes (Textarea, optional)

Dialog behavior:
- Title: "Create Service" or "Edit Service" based on editService prop
- On submit: call createService(data) or updateService(data) from lib/services/actions.ts
- On success: show toast("Service created/updated"), close dialog
- On error: show toast.error with error message
- Reset form on close
- Use sonner toast for feedback (import { toast } from "sonner")

Layout: Two-column grid on desktop (md:grid-cols-2) for the main fields, full-width for textareas. Group rehearsal fields in a collapsible section or under a "Rehearsal Details" label.
  </action>
  <verify>
Run `pnpm build` -- must compile. Verify both components export correctly. Check that ServiceCalendar uses DayPicker/Calendar with custom DayButton. Check that ServiceFormDialog uses react-hook-form with zodResolver and calls createService/updateService.
  </verify>
  <done>
ServiceCalendar renders a month view with colored dots for services on each day, supports month navigation, and fires onDayClick. ServiceFormDialog provides a complete create/edit form for all SERV-01 and SERV-06 fields with validation and toast feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard page with upcoming services list, stats cards, and responsive layout</name>
  <files>
components/services/service-list.tsx
components/services/service-stats.tsx
app/(app)/dashboard/page.tsx
  </files>
  <action>
**components/services/service-list.tsx** -- "use client" component (for edit/delete interactions):

Upcoming services list showing the next N services with their details.

Props:
```typescript
interface ServiceListProps {
  services: Array<{
    id: string;
    title: string;
    serviceDate: string;
    startTime: string;
    endTime?: string;
    serviceType?: { id: string; name: string; label: string; color: string };
    isCancelled: boolean;
  }>;
  userRole: string;
  serviceTypes: { id: string; name: string; label: string; color: string }[];
}
```

Implementation:
- Render each service as a Card with: title, date (formatted with date-fns `format(parseISO(serviceDate), 'EEE, MMM d')`), time range (startTime - endTime or just startTime), type Badge with background color matching the service type color
- Show "Cancelled" badge if isCancelled
- Each card is a Link to `/services/${service.id}` (click-through to detail page, scaffold in Plan 03)
- For admin/committee users: show a "..." dropdown menu (DropdownMenu) on each card with Edit and Delete options
  - Edit: opens ServiceFormDialog in edit mode (manage via state: editingService)
  - Delete: calls deleteService action with confirmation (use window.confirm for simplicity)
- Show placeholder text for assignment stats: "Assignments: Coming in Phase 4" in muted text
- If no upcoming services, show empty state message: "No upcoming services"
- Import and render ServiceFormDialog for edit functionality (pass serviceTypes prop)

**components/services/service-stats.tsx** -- server component (no interactivity):

Stats cards row for the dashboard header.

Props:
```typescript
interface ServiceStatsProps {
  stats: {
    upcomingCount: number;
    unassignedPositions: number;
    pendingConfirmations: number;
  };
}
```

Implementation:
- Three shadcn Card components in a responsive grid (grid-cols-1 sm:grid-cols-3)
- Card 1: "Upcoming Services" with CalendarCheck icon, show stats.upcomingCount as large number
- Card 2: "Unassigned Positions" with Users icon, show stats.unassignedPositions (will be 0 until Phase 4), add text-muted-foreground note "Available after scheduling" if 0
- Card 3: "Pending Confirmations" with Clock icon, show stats.pendingConfirmations (will be 0 until Phase 6), add text-muted-foreground note "Available after scheduling" if 0
- Use `lucide-react` icons: CalendarCheck, Users, Clock

**app/(app)/dashboard/page.tsx** -- server component (data fetching):

Rewrite the placeholder dashboard into the real services dashboard.

Implementation:
- This is a Server Component. Fetch data at the top:
  - `const services = await getServicesByMonth(currentYear, currentMonth)` -- use current date
  - `const upcoming = await getUpcomingServices(10)`
  - `const stats = await getServiceStats()`
  - `const serviceTypes = await getServiceTypes()`
  - Get user role via `const supabase = await createClient(); const { role } = await getUserRole(supabase);`

- Layout structure:
  ```
  <div className="flex flex-col gap-6">
    <!-- Header with title + Create Service button (admin/committee only) -->
    <div className="flex items-center justify-between">
      <div>
        <h1>Services</h1>
        <p>Manage upcoming services and team assignments</p>
      </div>
      {isAdminOrCommittee(role) && <DashboardActions serviceTypes={serviceTypes} />}
    </div>

    <!-- Stats cards -->
    <ServiceStats stats={stats} />

    <!-- Main content: Calendar + Upcoming list -->
    <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
      <!-- Calendar: takes 3 of 5 cols on desktop -->
      <div className="lg:col-span-3">
        <Card>
          <CardHeader><CardTitle>Calendar</CardTitle></CardHeader>
          <CardContent>
            <DashboardCalendar services={calendarServices} />
          </CardContent>
        </Card>
      </div>

      <!-- Upcoming list: takes 2 of 5 cols on desktop -->
      <div className="lg:col-span-2">
        <Card>
          <CardHeader><CardTitle>Upcoming Services</CardTitle></CardHeader>
          <CardContent>
            <ServiceList services={upcoming} userRole={role} serviceTypes={serviceTypes} />
          </CardContent>
        </Card>
      </div>
    </div>
  </div>
  ```

- Create a small "use client" wrapper `DashboardCalendar` inline or in a separate component that manages calendar month state (useState for month, onMonthChange handler) and wraps ServiceCalendar. This is needed because ServiceCalendar needs client state for month navigation, but the dashboard page is a server component.

- Create a small "use client" wrapper `DashboardActions` that renders the "Create Service" Button + manages the ServiceFormDialog open state.

- Transform the services from getServicesByMonth into CalendarService[] format for ServiceCalendar: map id, service_date -> serviceDate, title, service_types.color -> color, service_types.label -> typeLabel.

- Transform upcoming services from getUpcomingServices to match ServiceList props format.

- On mobile (below lg breakpoint): calendar and list stack vertically (grid-cols-1 is the default).

Important: Use date-fns `format` for date formatting. Use `parseISO` when parsing date strings. Do NOT use `new Date("YYYY-MM-DD")` directly (timezone issue per research pitfall).
  </action>
  <verify>
Run `pnpm build` -- must compile without errors. Run `pnpm lint` -- must pass on all new/modified files. Verify the dashboard page imports and renders ServiceCalendar, ServiceList, ServiceStats, and ServiceFormDialog. Check responsive layout: lg:grid-cols-5 for side-by-side, grid-cols-1 for stacked mobile.
  </verify>
  <done>
Dashboard page fetches real service data and renders: stats cards (3 cards with upcoming count and placeholders), a calendar month view with colored dots and month navigation, an upcoming services list with type badges and edit/delete for admins, and a create service button that opens the form dialog. Layout is responsive: side-by-side on desktop, stacked on mobile.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero TypeScript errors
2. `pnpm lint` passes with no errors on new/modified files
3. Dashboard page at `/dashboard` renders stats cards, calendar, and upcoming list
4. Calendar shows colored dots on days with services (dots match service type colors)
5. Month navigation (prev/next) works on the calendar
6. Create Service dialog opens from dashboard (admin/committee only) and submits successfully
7. Upcoming services list shows service title, date, time, and type badge
8. Admin/committee can edit and delete services from the list
9. Layout is responsive: side-by-side on lg+, stacked on smaller screens
</verification>

<success_criteria>
- ServiceCalendar uses react-day-picker v9 with custom DayButton for colored service dots
- ServiceFormDialog validates all SERV-01 + SERV-06 fields via Zod and calls server actions
- Dashboard page is a server component that fetches data and passes to client components
- Stats cards show real upcoming count and placeholder values for Phase 4/6 stats
- Responsive layout: 3:2 column split on desktop, stacked on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/03-services-and-calendar/03-02-SUMMARY.md`
</output>
