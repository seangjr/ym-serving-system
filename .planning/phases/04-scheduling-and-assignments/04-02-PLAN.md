---
phase: 04-scheduling-and-assignments
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(app)/services/[serviceId]/page.tsx
  - app/(app)/services/[serviceId]/assignment-panel.tsx
  - app/(app)/services/[serviceId]/assignment-slot.tsx
  - app/(app)/services/[serviceId]/position-adder.tsx
  - app/(app)/services/[serviceId]/conflict-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Service detail page shows position slots grouped by Team then Position Category (two-level hierarchy)"
    - "Position categories are expanded by default (not collapsed)"
    - "Unassigned slots display dashed outline with 'Assign' button"
    - "Combobox dropdown shows eligible team members with name and conflict warning icon"
    - "Assigned slot displays member name and status badge (pending/confirmed/declined)"
    - "Confirmation dialog appears when assigning a member with overlapping service times"
    - "Persistent warning badge stays on slot after confirmed conflict assignment"
    - "Team lead/admin can add positions inline from team's existing positions"
    - "Team lead/admin can remove positions with assignment warning dialog"
    - "Per-assignment notes field is available on each assigned slot"
  artifacts:
    - path: "app/(app)/services/[serviceId]/assignment-panel.tsx"
      provides: "Main assignment UI component with team/category grouping"
      contains: "AssignmentPanel"
    - path: "app/(app)/services/[serviceId]/assignment-slot.tsx"
      provides: "Individual position slot with combobox assignment and status display"
      contains: "AssignmentSlot"
    - path: "app/(app)/services/[serviceId]/position-adder.tsx"
      provides: "Inline position add dropdown for per-service position management"
      contains: "PositionAdder"
    - path: "app/(app)/services/[serviceId]/conflict-dialog.tsx"
      provides: "AlertDialog for conflict confirmation with service/position/time details"
      contains: "ConflictDialog"
    - path: "app/(app)/services/[serviceId]/page.tsx"
      provides: "Updated service detail page fetching assignment data"
      contains: "getServiceAssignments"
  key_links:
    - from: "app/(app)/services/[serviceId]/assignment-panel.tsx"
      to: "lib/assignments/queries.ts"
      via: "Server-fetched data passed as props from page.tsx"
      pattern: "TeamAssignmentGroup"
    - from: "app/(app)/services/[serviceId]/assignment-slot.tsx"
      to: "lib/assignments/actions.ts"
      via: "Server action calls for assign/unassign/updateNote"
      pattern: "assignMember|unassignMember"
    - from: "app/(app)/services/[serviceId]/conflict-dialog.tsx"
      to: "lib/assignments/types.ts"
      via: "ConflictInfo type for dialog display"
      pattern: "ConflictInfo"
---

<objective>
Build the complete assignment UI on the service detail page with combobox-per-slot assignment, conflict detection, position management, and all locked user decisions.

Purpose: This is the core user-facing scheduling interface -- the primary value of the entire application. Team leads open a service, see positions grouped by team and category, and assign members using searchable dropdowns with conflict warnings.

Output: Fully functional assignment panel replacing the Phase 4 placeholder on the service detail page.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-scheduling-and-assignments/04-CONTEXT.md
@.planning/phases/04-scheduling-and-assignments/04-RESEARCH.md
@.planning/phases/04-scheduling-and-assignments/04-01-SUMMARY.md

@app/(app)/services/[serviceId]/page.tsx
@app/(app)/services/[serviceId]/service-detail-actions.tsx
@components/ui/combobox.tsx
@components/ui/collapsible.tsx
@components/ui/badge.tsx
@components/ui/alert-dialog.tsx
@lib/assignments/types.ts
@lib/assignments/queries.ts
@lib/assignments/actions.ts
@lib/assignments/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build AssignmentPanel and AssignmentSlot components</name>
  <files>
app/(app)/services/[serviceId]/assignment-panel.tsx
app/(app)/services/[serviceId]/assignment-slot.tsx
app/(app)/services/[serviceId]/conflict-dialog.tsx
app/(app)/services/[serviceId]/page.tsx
  </files>
  <action>
**Update `page.tsx`** to replace the Phase 4 placeholder:
- Import `getServiceAssignments` and `getTeams` (or use a query that gets teams with members for the service).
- Fetch assignment data alongside service data in Promise.all.
- Pass assignment data, eligible members per team, service info, and canManage flag to AssignmentPanel.
- Import and render AssignmentPanel where the placeholder card currently is.
- Also fetch team data (teams that have positions defined) to enable the position adder.

**Create `assignment-panel.tsx`** ("use client"):
- Props: `teams: TeamAssignmentGroup[]`, `serviceId: string`, `serviceDate: string`, `startTime: string`, `endTime: string | null`, `durationMinutes: number | null`, `canManage: boolean`, `allTeams: { id, name, color, positions: { id, name, category }[], members: { id, fullName }[] }[]`
- Render a list of Cards, one per team that has positions on this service.
- Within each team Card:
  - CardHeader with team name (and team colour indicator)
  - CardContent with Collapsible sections for each position category
  - Use `Collapsible` with `defaultOpen` (per locked decision: expanded by default)
  - CollapsibleTrigger shows category name (or "General" if null) with ChevronDown icon
  - CollapsibleContent contains AssignmentSlot components for each position in that category
- If no teams have positions yet, show an empty state card: "No positions assigned yet. Use 'Add Position' below to start scheduling."
- Single-column on mobile, `grid-cols-1 lg:grid-cols-2` on desktop (per Claude's discretion for mobile layout).

**Create `assignment-slot.tsx`** ("use client"):
- Props: `position: ServicePositionWithAssignment`, `eligibleMembers: EligibleMember[]`, `serviceId: string`, `canManage: boolean`
- Two states: **Unassigned** and **Assigned**.

**Unassigned state** (per locked decision):
- Dashed border outline (`border-dashed border-2 border-muted-foreground/25`)
- Position name label on the left
- "Assign" button on the right that opens the Combobox
- When Combobox opens, show eligible members with:
  - Member full_name as text
  - If `member.hasConflict`, show `AlertTriangle` icon in amber-500 next to name (per locked decision)
  - Use `Combobox` from `@/components/ui/combobox` with search filtering (ComboboxInput with search)
  - ComboboxEmpty shows "No matching members"
  - On selection, call `assignMember` server action
  - If result has `conflict` key, open ConflictDialog (don't assign yet)
  - If result has `success`, show toast "Member assigned"
  - If result has `error`, show toast.error

**Assigned state** (per locked decision):
- Solid border
- Position name on the left
- Member name + status badge on the right
- Status badge colours (per Claude's discretion from RESEARCH.md):
  - pending: `bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400`
  - confirmed: `bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400`
  - declined: `bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400`
- If `assignment.hasConflict`, show persistent AlertTriangle icon in amber-500 with Tooltip showing conflict details (per locked decision: persistent warning badge)
- If canManage: show a small menu (or X button) to unassign, and a notes input
- Notes: small Textarea or inline text input, saves via `updateAssignmentNote` on blur/submit
- Unassign: calls `unassignMember` server action, shows toast confirmation

Use `useTransition` for all server action calls (optimistic feel). Follow the established pattern from `service-detail-actions.tsx`.

**Create `conflict-dialog.tsx`** ("use client"):
- AlertDialog component matching the existing delete confirmation pattern.
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `conflict: ConflictInfo`, `onConfirm: () => void`, `isPending: boolean`
- Dialog content shows (per locked decision):
  - Title: "Scheduling Conflict"
  - Description: "{member name} is assigned as {position name} on {service name} ({service time}). Assign anyway?"
  - Shows the conflicting service name, position, and time clearly
  - Footer: Cancel button + "Assign Anyway" button (non-destructive, amber/warning style)
- On confirm, call the assignMember action with `forceAssign: true`
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript errors. Navigate to a service detail page in the browser and verify:
1. The assignment panel renders (even if empty -- shows empty state)
2. No console errors
  </verify>
  <done>
Service detail page shows assignment panel with team/category grouping. Combobox opens and shows eligible members with conflict icons. Assigning a member shows status badge. Conflict dialog appears for overlapping assignments. Persistent warning badge visible after force-assign.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build PositionAdder and position removal with assignment warnings</name>
  <files>
app/(app)/services/[serviceId]/position-adder.tsx
app/(app)/services/[serviceId]/assignment-panel.tsx
  </files>
  <action>
**Create `position-adder.tsx`** ("use client"):
- Props: `serviceId: string`, `teams: { id, name, color, positions: { id, name, category }[] }[]`
- Renders a section at the bottom of each team's card (or as a standalone component below the assignment panel)
- UI: A row with:
  - Team selector (if multiple teams) -- Select dropdown showing team names
  - Position selector -- Select dropdown showing positions from the selected team's existing `team_positions` (per locked decision: select from team's existing positions, NOT free-text)
  - "Add" button (Plus icon)
- When clicked, calls `addServicePosition` server action with { serviceId, teamId, positionId }
- Shows toast on success ("Position added") or error
- Can add multiples of the same position (per locked decision: e.g., 2 Vocalists). The dropdown does NOT filter out already-added positions.
- Position options are grouped by category in the Select dropdown for clarity.

**Update `assignment-panel.tsx`** to integrate PositionAdder:
- Add PositionAdder below each team's positions section (inside the team Card)
- Only show PositionAdder when canManage is true

**Position removal** (in assignment-slot.tsx or assignment-panel.tsx):
- Add a remove/trash icon button on each position slot (only when canManage)
- Per Claude's discretion from RESEARCH.md:
  - If the position has NO assignment: remove immediately with `removeServicePosition`, show toast "Position removed"
  - If the position HAS an assignment: show AlertDialog confirmation: "Remove {Position Name}? {Member Name} is currently assigned to this position and will be unassigned."
    - Cancel / Remove buttons
    - On confirm, call `removeServicePosition` (CASCADE handles the DB cleanup)
    - Show toast "Position and assignment removed"
- Use the same AlertDialog pattern as the existing service delete confirmation

The position removal button should be subtle (ghost variant, small icon) to avoid accidental clicks, positioned at the far right of the slot row.
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript errors. In the browser:
1. Open a service detail page
2. Use the position adder to add a position from a team
3. The position slot appears in the correct team/category group
4. Adding the same position again creates a second slot (multiples allowed)
5. Removing an unassigned position removes it immediately
6. Removing an assigned position shows confirmation dialog
  </verify>
  <done>
Team leads and admins can add positions inline from team's existing positions, add multiples of the same position, and remove positions with appropriate confirmation when assigned members would be affected.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. Service detail page renders assignment panel instead of placeholder
3. Positions are grouped by Team then Category with Collapsible sections expanded by default
4. Combobox shows team members with conflict warning icons
5. Assignment creates pending status badge on the slot
6. Conflict dialog appears and force-assign sets persistent warning badge
7. Position adder allows adding from team's existing positions (including multiples)
8. Position removal shows confirmation when assignment exists
9. All actions show appropriate toast notifications
10. Layout is responsive: single column on mobile, grid on desktop
</verification>

<success_criteria>
- Complete assignment UI replaces Phase 4 placeholder on service detail page
- All locked decisions from CONTEXT.md implemented:
  - Combobox per slot (not drag-and-drop)
  - Member name + availability indicator in dropdown
  - Member name + status badge for assigned slots (no avatars)
  - Conflict = overlapping times only (not same-day)
  - Confirmation dialog for conflicts with service name + position + time
  - Persistent warning badge after confirmed conflict
  - Two-level hierarchy: Team > Category, expanded by default
  - Dashed outline + Assign button for unassigned slots
  - Add/remove positions inline from team's existing positions
  - Multiples of same position supported
  - Per-assignment notes supported
</success_criteria>

<output>
After completion, create `.planning/phases/04-scheduling-and-assignments/04-02-SUMMARY.md`
</output>
