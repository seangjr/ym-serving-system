---
phase: 06-accept-decline-and-notifications
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - lib/notifications/actions.ts
  - lib/notifications/queries.ts
  - components/schedule/swap-request-dialog.tsx
  - components/schedule/assignment-card.tsx
  - components/assignments/swap-approval-list.tsx
  - app/(app)/services/[serviceId]/page.tsx
  - components/notifications/notification-item.tsx
  - app/(app)/my-schedule/page.tsx
autonomous: true
requirements:
  - RESP-03
  - RESP-04

must_haves:
  truths:
    - "Member can request a swap from their assignment card on My Schedule"
    - "Requesting a swap notifies eligible members for the same position"
    - "Another member can accept a swap request (from their notifications)"
    - "Team lead can approve or reject a swap request from the service detail page"
    - "Approved swap reassigns the position to the accepting member"
    - "Rejected swap notifies both the requester and acceptor"
  artifacts:
    - path: "lib/notifications/actions.ts"
      provides: "requestSwap, acceptSwap, resolveSwap server actions"
      exports: ["requestSwap", "acceptSwap", "resolveSwap"]
    - path: "lib/notifications/queries.ts"
      provides: "getSwapRequests, getPendingSwapsForService queries"
      exports: ["getSwapRequests", "getPendingSwapsForService"]
    - path: "components/schedule/swap-request-dialog.tsx"
      provides: "Dialog for member to request a swap with optional reason"
      min_lines: 30
    - path: "components/assignments/swap-approval-list.tsx"
      provides: "List of pending swaps for team lead approval on service detail"
      min_lines: 40
  key_links:
    - from: "components/schedule/swap-request-dialog.tsx"
      to: "lib/notifications/actions.ts"
      via: "requestSwap server action"
      pattern: "requestSwap"
    - from: "lib/notifications/actions.ts"
      to: "lib/notifications/send.ts"
      via: "createNotification for swap events"
      pattern: "createNotification"
    - from: "components/assignments/swap-approval-list.tsx"
      to: "lib/notifications/actions.ts"
      via: "resolveSwap server action"
      pattern: "resolveSwap"
---

<objective>
Implement the swap request workflow: member requests a swap, eligible members are notified, one accepts, team lead approves or rejects. On approval, the assignment is reassigned.

Purpose: Swaps allow members to find replacements when they cannot serve, reducing the team lead's manual coordination burden. The state machine (pending -> accepted -> approved/rejected) ensures proper oversight.

Output: requestSwap, acceptSwap, resolveSwap actions, swap dialog on My Schedule, swap approval list on service detail page
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@.planning/phases/06-accept-decline-and-notifications/06-02-SUMMARY.md
@.planning/phases/06-accept-decline-and-notifications/06-03-SUMMARY.md
@lib/notifications/types.ts
@lib/notifications/schemas.ts
@lib/notifications/actions.ts
@lib/notifications/queries.ts
@lib/notifications/send.ts
@lib/assignments/queries.ts
@components/schedule/assignment-card.tsx
@app/(app)/services/[serviceId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add swap server actions and queries</name>
  <files>
    lib/notifications/actions.ts
    lib/notifications/queries.ts
  </files>
  <action>
**Add to lib/notifications/queries.ts:**

`getSwapRequests(memberId: string)`: Query swap_requests where requester_member_id = memberId, ordered by created_at DESC. Join with service_assignments -> service_positions -> team_positions (position name), services (title, date). Return SwapRequest[] with position/service context.

`getPendingSwapsForService(serviceId: string)`: Query swap_requests WHERE status IN ('pending', 'accepted') AND the assignment's service_position belongs to the given service. Join to get requester name, acceptor name (if accepted), position name, service title. Used on the service detail page for team lead approval.

**Add to lib/notifications/actions.ts:**

`requestSwap(data: unknown)`:
1. Parse with requestSwapSchema
2. Get caller's memberId, verify they own the assignment (member_id = callerId)
3. Check no existing pending swap for this assignment (prevent duplicates)
4. Insert into swap_requests: assignment_id, requester_member_id = callerId, reason
5. Find eligible members for the same position on the same service:
   - Get the service_position's position_id and team_id
   - Get team_members for that team who have skills for that position (member_position_skills)
   - Exclude the requester
6. Send 'swap_requested' notification to each eligible member:
   - title: 'Swap Request'
   - body: '{requesterName} is looking for a swap for {positionName} on {serviceTitle}'
   - actionUrl: '/my-schedule' (they'll see it in their notifications)
   - metadata: { swapRequestId, assignmentId, serviceId }
7. Also notify the team lead of the swap request
8. revalidatePath('/my-schedule')
9. Return { success: true }

`acceptSwap(data: unknown)`:
1. Parse with acceptSwapSchema
2. Get caller's memberId
3. Atomic update: `UPDATE swap_requests SET status = 'accepted', accepted_by_member_id = callerId WHERE id = swapRequestId AND status = 'pending'`
   - If 0 rows updated: return error "Swap request is no longer available" (handles race condition per research Pitfall 3)
4. Notify the requester: 'swap_accepted', '{acceptorName} has accepted your swap request for {positionName}. Awaiting team lead approval.'
5. Notify the team lead: 'swap_accepted', '{acceptorName} accepted {requesterName}\'s swap for {positionName}. Please approve or reject.'
   - actionUrl: '/services/{serviceId}'
6. revalidatePath('/my-schedule')
7. Return { success: true }

`resolveSwap(data: unknown)`:
1. Parse with resolveSwapSchema (swapRequestId + action: 'approve'|'reject')
2. Get caller's role + memberId. Verify caller is admin/committee or team lead for the assignment's team.
3. Update swap_requests: status = 'approved'|'rejected', resolved_by = callerId, resolved_at = now()
4. **If approved:**
   - Reassign: update service_assignments SET member_id = accepted_by_member_id WHERE id = assignment_id
   - Notify requester: 'swap_approved', 'Your swap request has been approved. {acceptorName} will serve as {positionName}.'
   - Notify acceptor: 'swap_approved', 'The swap has been approved. You are now assigned as {positionName} for {serviceTitle}.'
5. **If rejected:**
   - Reset swap_request status to 'rejected'
   - Notify requester: 'swap_rejected', 'Your swap request has been rejected by the team lead.'
   - Notify acceptor: 'swap_rejected', 'The swap request you accepted has been rejected by the team lead.'
6. revalidatePath for both /my-schedule and /services/{serviceId}
7. Return { success: true }

All notification calls wrapped in try/catch to prevent failures from blocking the primary action.
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Verify requestSwap, acceptSwap, and resolveSwap are exported from the file.</verify>
  <done>Three swap server actions exist with full state machine: request (pending), accept (accepted with race condition protection), resolve (approved with reassignment or rejected with notifications to both parties).</done>
</task>

<task type="auto">
  <name>Task 2: Build swap UI components</name>
  <files>
    components/schedule/swap-request-dialog.tsx
    components/schedule/assignment-card.tsx
    components/assignments/swap-approval-list.tsx
    app/(app)/services/[serviceId]/page.tsx
  </files>
  <action>
**components/schedule/swap-request-dialog.tsx** ("use client"):
- Dialog (from shadcn/ui) with trigger button "Request Swap"
- Form with optional reason textarea (max 500 chars)
- Submit calls requestSwap action
- Shows toast on success ("Swap request sent to eligible members")
- Closes dialog on success
- Uses useTransition for pending state

**Modify components/schedule/assignment-card.tsx:**
- Add "Request Swap" button alongside Confirm/Decline buttons (only for pending assignments)
- For confirmed assignments: also show "Request Swap" button (member might need to swap after confirming)
- "Request Swap" opens SwapRequestDialog
- If assignment already has a pending swap: show "Swap Pending" badge instead of button
- To know if a swap exists: the page component should pass a `hasSwapPending` prop (queried from swap_requests table in my-schedule/page.tsx)

**Modify app/(app)/my-schedule/page.tsx:**
- Query swap_requests for the member's assignments to determine which have pending swaps
- Pass `hasSwapPending` flag to each assignment card

**Also in my-schedule/page.tsx:**
- Show incoming swap requests in the notifications (these are already handled by notification-bell). But if member received a 'swap_requested' notification with actionUrl, clicking it should bring them here.
- Add an "Accept Swap" button for incoming swap_requested notifications. Implementation: check if there are swap_requests WHERE status = 'pending' AND the assignment's position matches a position the current member has skills for AND requester is not the current member.
  - For simplicity in this plan: handle swap acceptance via notification item click. When a member clicks a swap_requested notification, show an "Accept Swap" confirmation (either inline in the notification or a small dialog). Calls acceptSwap action.
  - Alternative simpler approach: Add an "Accept" button directly on swap_requested notification items in notification-item.tsx. Modify notification-item.tsx to check if notification.type === 'swap_requested' and render an Accept button.

**components/assignments/swap-approval-list.tsx** ("use client"):
- Props: swapRequests (from getPendingSwapsForService), serviceId
- Renders a Card with title "Pending Swap Requests" (only shown if there are pending/accepted swaps)
- Each swap request shows:
  - Requester name, position name
  - Status: "Waiting for acceptance" (pending) or "Accepted by {name}, awaiting approval" (accepted)
  - For 'accepted' status: "Approve" (green) and "Reject" (red) buttons
  - Calls resolveSwap action
  - Uses useTransition for pending state

**Modify app/(app)/services/[serviceId]/page.tsx:**
- Import getPendingSwapsForService
- Fetch pending swaps for this service (only if user is admin/committee or team lead)
- Render SwapApprovalList below the assignment panel (only if canManage and there are pending swaps)

**Modify components/notifications/notification-item.tsx:**
- For notifications with type 'swap_requested': add an "Accept Swap" button
- Button calls acceptSwap with the swapRequestId from notification.metadata
- Use useTransition, show toast on success/error
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Run `pnpm lint`. Test the full swap flow: member requests swap -> eligible members see notification with Accept button -> accepting member clicks Accept -> team lead sees approval list on service detail -> team lead approves -> assignment reassigned.</verify>
  <done>Full swap workflow is functional: member requests from My Schedule, eligible members receive notification with Accept button, team lead can approve/reject from service detail page. Approved swaps reassign the position. All parties are notified at each step.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `pnpm lint` passes
- Member can tap "Request Swap" on an assignment card
- Eligible members receive swap_requested notification with Accept button
- Accepting a swap uses atomic UPDATE to prevent race conditions
- Service detail page shows "Pending Swap Requests" section for team leads
- Approve/Reject buttons work and trigger reassignment/notification
- All notification types (swap_requested, swap_accepted, swap_approved, swap_rejected) are created correctly
</verification>

<success_criteria>
- RESP-03 satisfied: member can request swap, eligible members notified
- RESP-04 satisfied: team lead can approve/reject swap requests
- Swap state machine works: pending -> accepted -> approved (with reassignment) or rejected
- Race condition handled: only first acceptor succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-04-SUMMARY.md`
</output>
