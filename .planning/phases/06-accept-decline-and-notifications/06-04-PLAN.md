---
phase: 06-accept-decline-and-notifications
plan: 04
type: execute
wave: 3
depends_on: [06-01, 06-02, 06-03]
files_modified:
  - lib/notifications/actions.ts
  - lib/notifications/queries.ts
  - components/assignments/swap-request-dialog.tsx
  - components/assignments/swap-approval-list.tsx
  - components/assignments/assignment-card.tsx
  - app/(app)/services/[id]/page.tsx
autonomous: true
requirements: [RESP-03, RESP-04]

must_haves:
  truths:
    - "Member can request a swap by selecting a specific team member from a dropdown (pre-arranged model)"
    - "Swap request creates a row in swap_requests with target_member_id set at creation"
    - "Team lead is notified of the swap request"
    - "Team lead can approve or reject a swap request from the service detail page"
    - "Approving a swap reassigns the position from requester to target member"
    - "Rejecting a swap notifies the requester"
    - "Only one pending swap per assignment at a time"
    - "Reason field is optional in the swap dialog"
  artifacts:
    - path: "components/assignments/swap-request-dialog.tsx"
      provides: "Dialog for requesting a pre-arranged swap"
      exports: ["SwapRequestDialog"]
    - path: "components/assignments/swap-approval-list.tsx"
      provides: "Team lead view of pending swap requests on service detail"
      exports: ["SwapApprovalList"]
    - path: "lib/notifications/actions.ts"
      provides: "requestSwap, resolveSwap server actions added"
      exports: ["requestSwap", "resolveSwap"]
  key_links:
    - from: "components/assignments/swap-request-dialog.tsx"
      to: "lib/notifications/actions.ts"
      via: "requestSwap server action"
      pattern: "requestSwap"
    - from: "components/assignments/swap-approval-list.tsx"
      to: "lib/notifications/actions.ts"
      via: "resolveSwap server action"
      pattern: "resolveSwap"
    - from: "lib/notifications/actions.ts"
      to: "lib/notifications/send.ts"
      via: "createNotification on swap events"
      pattern: "createNotification"
---

<objective>
Build the pre-arranged swap request workflow. Members can request a swap by selecting a specific team member they already arranged with offline. Team leads approve or reject. The swap partner does NOT need to accept in-system -- the offline agreement is sufficient.

Purpose: Formalizes the team's existing offline swap process in the system. Satisfies RESP-03, RESP-04.
Output: Swap dialog on My Schedule, approval list on service detail, requestSwap/resolveSwap actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-CONTEXT.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@.planning/phases/06-accept-decline-and-notifications/06-02-SUMMARY.md
@.planning/phases/06-accept-decline-and-notifications/06-03-SUMMARY.md
@lib/notifications/types.ts
@lib/notifications/schemas.ts
@lib/notifications/actions.ts
@lib/notifications/queries.ts
@lib/notifications/send.ts
@components/assignments/assignment-card.tsx
@app/(app)/services/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: requestSwap and resolveSwap server actions with swap queries</name>
  <files>lib/notifications/actions.ts, lib/notifications/queries.ts</files>
  <action>
**Add to lib/notifications/actions.ts:**

requestSwap(data: unknown):
1. Auth: createClient, getUserRole, get callerId
2. Parse with requestSwapSchema: { assignmentId, targetMemberId, reason? }
3. Verify ownership: query service_assignments where id = assignmentId AND member_id = callerId. If not found, return error.
4. Verify no existing pending swap: query swap_requests where assignment_id = assignmentId AND status = 'pending'. If found, return { error: "A swap request is already pending for this assignment." }
5. Verify target member is on the same team: query the assignment's service_position -> team_id, then check team_members for targetMemberId on that team. If not on team, return error.
6. Insert via admin client into swap_requests: assignment_id, requester_member_id = callerId, target_member_id = targetMemberId, reason = reason || null, status = 'pending'
7. Notify team lead(s):
   - Query team lead for the assignment's team (team_members where role='lead')
   - createNotification to team lead:
     - type: 'swap_requested'
     - title: 'Swap Request'
     - body: '{requesterName} requests to swap {positionName} with {targetName} for {serviceTitle}'
     - actionUrl: '/services/{serviceId}'
8. revalidatePath('/my-schedule') and revalidatePath('/services/{serviceId}')
9. Return { success: true }

resolveSwap(data: unknown):
1. Auth: createClient, getUserRole, get callerId
2. Parse with resolveSwapSchema: { swapRequestId, action: 'approved' | 'rejected' }
3. Fetch swap_request with assignment details (join through assignment -> service_position -> team_id)
4. Authorize: caller must be admin, committee, or team lead for the assignment's team
5. Verify swap is still pending: if status != 'pending', return error
6. If action = 'approved':
   - Use atomic update: UPDATE swap_requests SET status='approved', resolved_by=callerId, resolved_at=now() WHERE id=swapRequestId AND status='pending'. Check rowCount -- if 0, another resolver beat us (race condition protection per Pitfall 3).
   - Reassign: UPDATE service_assignments SET member_id = swap.target_member_id WHERE id = swap.assignment_id
   - Notify requester:
     - type: 'swap_approved'
     - title: 'Swap Approved'
     - body: 'Your swap request for {positionName} at {serviceTitle} has been approved'
     - actionUrl: '/my-schedule'
   - Notify target member:
     - type: 'assignment_new'
     - title: 'New Assignment (Swap)'
     - body: 'You have been assigned as {positionName} for {serviceTitle} via swap'
     - actionUrl: '/my-schedule'
7. If action = 'rejected':
   - UPDATE swap_requests SET status='rejected', resolved_by=callerId, resolved_at=now()
   - Notify requester:
     - type: 'swap_rejected'
     - title: 'Swap Rejected'
     - body: 'Your swap request for {positionName} at {serviceTitle} was rejected'
     - actionUrl: '/my-schedule'
8. revalidatePath for /services/{serviceId} and /my-schedule
9. Return { success: true }

**Add to lib/notifications/queries.ts:**

getSwapRequestsForService(serviceId: string): Promise<SwapRequest[]>
- Query swap_requests joined through service_assignments -> service_positions where service_positions.service_id = serviceId
- Join members table for requester and target names
- Return SwapRequest[] with all fields populated
- Used on the service detail page for team lead approval view

getActiveSwapForAssignment(assignmentId: string): Promise<SwapRequest | null>
- Query swap_requests where assignment_id = assignmentId AND status = 'pending'
- Returns the pending swap if one exists (for showing "Swap Pending" state on assignment card)

getTeamMembersForSwap(assignmentId: string, currentMemberId: string): Promise<{id: string, fullName: string}[]>
- Given an assignment, find the team for that assignment's position
- Return all team members EXCEPT the current member (can't swap with yourself)
- Used to populate the swap partner dropdown
  </action>
  <verify>Run `pnpm build` to verify compilation. Check that requestSwap validates ownership, prevents duplicate pending swaps, and notifies team lead. Check that resolveSwap handles both approve (reassign) and reject (notify) paths.</verify>
  <done>requestSwap and resolveSwap server actions handle the full pre-arranged swap lifecycle. Race condition protection on approval. Team lead notified on request, requester notified on resolution. Swap queries ready for UI consumption.</done>
</task>

<task type="auto">
  <name>Task 2: Swap request dialog on My Schedule and approval list on service detail</name>
  <files>components/assignments/swap-request-dialog.tsx, components/assignments/swap-approval-list.tsx, components/assignments/assignment-card.tsx, app/(app)/services/[id]/page.tsx</files>
  <action>
**components/assignments/swap-request-dialog.tsx** ("use client"):
- Dialog (not AlertDialog -- this is a form, not a confirmation)
- Props: assignmentId (string), open (boolean), onOpenChange (fn)
- On open, fetch team members for swap via a server action wrapper of getTeamMembersForSwap
- Content:
  - Title: "Request Swap"
  - Description: "Select the team member you've arranged to swap with"
  - Combobox/Select dropdown of team members (id + fullName). Use the Select component (simpler than Combobox since the list is typically small per-team)
  - Optional reason textarea: placeholder "Reason (optional)", max 500 chars
  - Cancel + "Request Swap" buttons
- On submit: call requestSwap({ assignmentId, targetMemberId, reason })
- Show toast on success ("Swap request sent") or error
- useTransition for pending state

**components/assignments/swap-approval-list.tsx** ("use client"):
- Props: swapRequests (SwapRequest[]), onResolve? (callback for optimistic update)
- Renders a list of pending swap requests for team lead review
- Each item shows:
  - Requester name -> Target name (e.g., "John -> Sarah")
  - Position name
  - Reason (if provided, in text-xs text-muted-foreground)
  - Created at (relative time)
  - Approve button (green, Check icon) and Reject button (red, X icon)
- Approve calls resolveSwap({ swapRequestId, action: 'approved' })
- Reject calls resolveSwap({ swapRequestId, action: 'rejected' })
- useTransition for pending state per button
- If no pending swaps: don't render anything (return null)

**Update components/assignments/assignment-card.tsx:**
- Add a "Swap" button (ArrowLeftRight icon from lucide-react) alongside Confirm/Decline buttons
- The Swap button opens the SwapRequestDialog
- If there's an active pending swap for this assignment, show "Swap Pending" badge instead of the Swap button (prevent multiple pending swaps)
- Pass assignmentId to SwapRequestDialog
- Fetch active swap status: add hasActivePendingSwap prop to the card (fetched at page level in my-schedule/page.tsx and passed down)

**Update app/(app)/services/[id]/page.tsx:**
- Import getSwapRequestsForService from lib/notifications/queries
- Fetch pending swap requests for this service
- If there are pending swaps AND the current user is admin/committee/team lead, render SwapApprovalList component in a new section on the service detail page
- Section title: "Pending Swap Requests" with a count badge
- Place it above or below the assignment section for visibility
  </action>
  <verify>Run `pnpm build` to verify compilation. Test: open My Schedule, click Swap on an assignment card, select a team member, submit. Verify swap_requests row created. Navigate to service detail as team lead, verify SwapApprovalList shows pending swaps. Approve a swap, verify assignment is reassigned.</verify>
  <done>Swap dialog on My Schedule lets members select a specific swap partner. Service detail page shows pending swaps for team lead approval. Approving reassigns the position. Rejecting notifies the requester. Only one pending swap allowed per assignment.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- Member can open swap dialog from assignment card, select team member, submit request
- Swap request creates row in swap_requests with target_member_id set
- Team lead receives 'swap_requested' notification
- Team lead sees pending swaps on service detail page
- Approve: reassigns position to target member, notifies requester
- Reject: notifies requester, position unchanged
- Only one pending swap per assignment enforced
- Reason field is optional
</verification>

<success_criteria>
- Pre-arranged swap model works end-to-end
- Member selects specific swap partner (not broadcast)
- Team lead approval required and visible on service detail
- Swap partner does NOT need to accept in-system
- Race condition protection on swap approval
- All swap state changes emit appropriate notifications
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-04-SUMMARY.md`
</output>
