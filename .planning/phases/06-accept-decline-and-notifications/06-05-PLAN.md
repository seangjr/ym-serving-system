---
phase: 06-accept-decline-and-notifications
plan: 05
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - supabase/migrations/00010_reminder_cron.sql
  - app/api/reminders/route.ts
autonomous: true
requirements: [NOTF-05]

must_haves:
  truths:
    - "Members receive reminder notifications before their service date based on their configured reminder_days_before preference"
    - "Reminders are not sent for declined assignments"
    - "Reminders are not duplicated (same assignment does not get reminded twice)"
    - "Reminder generation can be triggered via API route for environments without pg_cron"
  artifacts:
    - path: "supabase/migrations/00010_reminder_cron.sql"
      provides: "SQL function for generating reminders + pg_cron schedule"
      contains: "generate_service_reminders"
    - path: "app/api/reminders/route.ts"
      provides: "API route fallback for triggering reminders"
      exports: ["POST"]
  key_links:
    - from: "supabase/migrations/00010_reminder_cron.sql"
      to: "supabase/migrations/00009_notifications.sql"
      via: "INSERT into notifications table"
      pattern: "INSERT INTO public.notifications"
    - from: "app/api/reminders/route.ts"
      to: "supabase/migrations/00010_reminder_cron.sql"
      via: "Calls generate_service_reminders() function"
      pattern: "generate_service_reminders"
---

<objective>
Create the daily reminder system that generates notification rows for members with upcoming service assignments based on their configured reminder_days_before preference. Uses pg_cron for automated daily execution and provides an API route fallback for environments without pg_cron.

Purpose: Members get timely reminders before their service dates. Satisfies NOTF-05 (configurable reminder days before service date).
Output: SQL function + pg_cron job + API route for reminder generation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-CONTEXT.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@supabase/migrations/00004_member_profiles.sql
@supabase/migrations/00009_notifications.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reminder SQL function and pg_cron schedule</name>
  <files>supabase/migrations/00010_reminder_cron.sql</files>
  <action>
Create migration 00010_reminder_cron.sql:

1. **Enable pg_cron extension** (if not already enabled):
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA extensions;
   ```

2. **Create generate_service_reminders() function:**
   - Returns integer (number of reminders generated)
   - Query logic:
     - JOIN service_assignments sa
       -> service_positions sp ON sa.service_position_id = sp.id
       -> services s ON sp.service_id = s.id
       -> team_positions tp ON sp.position_id = tp.id
       -> member_profiles mp ON sa.member_id = mp.member_id
     - WHERE conditions:
       - sa.status != 'declined' (don't remind declined assignments)
       - s.is_cancelled = false
       - s.service_date = CURRENT_DATE + (mp.reminder_days_before || ' days')::interval
       - mp.reminder_days_before > 0 (only if reminders are enabled)
     - NOT EXISTS: check that a reminder notification doesn't already exist for this assignment (prevents duplicates):
       - SELECT 1 FROM notifications n WHERE n.recipient_member_id = sa.member_id AND n.type = 'reminder' AND n.metadata->>'assignment_id' = sa.id::text
   - INSERT INTO notifications:
     - recipient_member_id = sa.member_id
     - type = 'reminder'
     - title = 'Serving Reminder'
     - body = 'You are serving as ' || tp.name || ' at ' || s.title || ' on ' || to_char(s.service_date, 'DD Mon YYYY')
     - metadata = jsonb_build_object('service_id', s.id, 'assignment_id', sa.id)
     - action_url = '/my-schedule'
   - Return GET DIAGNOSTICS row_count

3. **Schedule pg_cron job:**
   ```sql
   SELECT cron.schedule(
     'daily-service-reminders',
     '0 8 * * *',  -- Daily at 8:00 AM UTC
     $$SELECT public.generate_service_reminders()$$
   );
   ```

4. **Grant execute** on the function to authenticated and service_role.

NOTE: pg_cron may not be available in all environments (local dev, some Supabase plans). The function itself is the core logic; pg_cron is optional automation. The API route (Task 2) provides a fallback.

Wrap the pg_cron schedule in a DO block with exception handling so the migration doesn't fail if pg_cron is not enabled:
```sql
DO $$
BEGIN
  PERFORM cron.schedule('daily-service-reminders', '0 8 * * *', 'SELECT public.generate_service_reminders()');
EXCEPTION WHEN undefined_function OR insufficient_privilege THEN
  RAISE NOTICE 'pg_cron not available -- skipping cron schedule. Use the /api/reminders route instead.';
END;
$$;
```
  </action>
  <verify>Apply migration. Test the function manually: `SELECT public.generate_service_reminders();` Verify it returns 0 when no reminders are due, and creates notification rows when assignments match the reminder window.</verify>
  <done>generate_service_reminders() function creates reminder notifications for members based on their reminder_days_before preference. Duplicate prevention via NOT EXISTS. pg_cron scheduled daily at 8 AM (gracefully skipped if pg_cron unavailable).</done>
</task>

<task type="auto">
  <name>Task 2: API route fallback for reminder generation</name>
  <files>app/api/reminders/route.ts</files>
  <action>
Create app/api/reminders/route.ts as a POST endpoint:

1. **Authentication:** Verify the request includes a valid authorization header:
   - Accept either: a) Bearer token matching CRON_SECRET env var (for external cron services like Vercel Cron), or b) a valid Supabase service role key
   - If neither, return 401 Unauthorized
   - Add CRON_SECRET to .env.local.example with a comment

2. **Execute reminder generation:**
   - Use createAdminClient() to call the SQL function:
     ```typescript
     const { data, error } = await admin.rpc('generate_service_reminders');
     ```
   - Return JSON: { success: true, remindersGenerated: data } on success
   - Return JSON: { error: error.message } with status 500 on failure

3. **Response headers:**
   - Cache-Control: no-store (prevent caching)

This route serves as:
- Fallback when pg_cron is not available (local dev, hobby Supabase plans)
- Integration point for external cron services (Vercel Cron, GitHub Actions, etc.)
- Manual trigger for testing

Keep it simple -- the core logic is in the SQL function, this route just invokes it.
  </action>
  <verify>Run `pnpm build` to verify compilation. Test with curl: `curl -X POST http://localhost:3000/api/reminders -H "Authorization: Bearer $CRON_SECRET"` -- should return { success: true, remindersGenerated: 0 }.</verify>
  <done>API route /api/reminders POST endpoint triggers reminder generation. Authenticated via CRON_SECRET or service role key. Returns count of reminders generated. Works as fallback for environments without pg_cron.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- Migration applies successfully (pg_cron schedule gracefully skipped if extension unavailable)
- `SELECT public.generate_service_reminders()` returns integer
- Function creates reminder notifications matching member's reminder_days_before
- No duplicate reminders for the same assignment
- Declined assignments don't get reminders
- Cancelled services don't generate reminders
- API route returns 401 without proper auth
- API route returns success with reminder count when properly authenticated
</verification>

<success_criteria>
- Reminder function generates notifications based on per-member reminder_days_before preference
- Duplicate prevention works (running twice doesn't create duplicate reminders)
- pg_cron schedules daily execution (graceful fallback if unavailable)
- API route provides manual/external trigger for environments without pg_cron
- Reminders skip declined assignments and cancelled services
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-05-SUMMARY.md`
</output>
