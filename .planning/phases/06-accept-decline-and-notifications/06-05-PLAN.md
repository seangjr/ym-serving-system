---
phase: 06-accept-decline-and-notifications
plan: 05
type: execute
wave: 3
depends_on: ["06-01"]
files_modified:
  - supabase/migrations/00010_reminders.sql
  - app/api/reminders/route.ts
  - components/profiles/notification-preferences.tsx
  - lib/profiles/actions.ts
autonomous: true
requirements:
  - NOTF-05

must_haves:
  truths:
    - "Reminder notifications are generated for upcoming service assignments"
    - "Reminders respect each member's configurable reminder_days_before setting"
    - "Duplicate reminders are prevented (same assignment is not reminded twice)"
    - "Member can configure their reminder_days_before preference"
  artifacts:
    - path: "supabase/migrations/00010_reminders.sql"
      provides: "pg_cron daily reminder job + 90-day notification cleanup job"
      contains: "cron.schedule"
    - path: "app/api/reminders/route.ts"
      provides: "API route that generates reminder notifications (called by pg_cron via pg_net or directly)"
      exports: ["POST"]
    - path: "components/profiles/notification-preferences.tsx"
      provides: "Updated notification preferences with reminder_days_before configuration"
  key_links:
    - from: "supabase/migrations/00010_reminders.sql"
      to: "app/api/reminders/route.ts"
      via: "pg_cron + pg_net HTTP call or direct SQL insert"
      pattern: "cron.schedule"
    - from: "app/api/reminders/route.ts"
      to: "lib/notifications/send.ts"
      via: "createNotification for each due reminder"
      pattern: "createNotification"
---

<objective>
Implement the reminder system: a daily job that generates reminder notifications for members with upcoming service assignments, respecting each member's configurable reminder_days_before preference.

Purpose: Members should receive a reminder notification X days before their service date so they can prepare. This is the final piece of the notification system.

Output: pg_cron migration, reminder API route, updated notification preferences UI
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@lib/notifications/send.ts
@lib/notifications/types.ts
@supabase/migrations/00004_member_profiles.sql
@components/profiles/notification-preferences.tsx
@lib/profiles/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reminder generation API route and pg_cron migration</name>
  <files>
    app/api/reminders/route.ts
    supabase/migrations/00010_reminders.sql
  </files>
  <action>
**app/api/reminders/route.ts:**
- POST handler (protected by a secret header: `x-api-key` must match `CRON_SECRET` env var, or allow from service role)
- Query logic:
  1. Use admin client (createAdminClient)
  2. Fetch all service_assignments WHERE status != 'declined', joined with:
     - service_positions -> services (service_date, title, is_cancelled=false)
     - service_positions -> team_positions (name)
     - member_profiles (reminder_days_before)
  3. Filter: service_date = CURRENT_DATE + reminder_days_before days AND reminder_days_before > 0
  4. For each match, check NOT EXISTS in notifications table: same recipient_member_id, type = 'reminder', metadata->>'assignment_id' = assignment.id (prevents duplicates per research Pitfall 2)
  5. For each eligible reminder, call createNotification():
     - recipientMemberId: member_id from assignment
     - type: 'reminder'
     - title: 'Serving Reminder'
     - body: 'You are serving as {positionName} at {serviceTitle} on {formattedDate}'
     - metadata: { serviceId, assignmentId }
     - actionUrl: '/my-schedule'
  6. Return JSON response: { reminders_sent: count }

- Alternative approach (simpler, avoids pg_net complexity): Do the reminder generation entirely in the SQL migration using a pure SQL pg_cron job that directly inserts into notifications (no HTTP call needed). This avoids the pg_net dependency and is more reliable. The API route can then serve as a manual trigger or fallback.

**Use the SQL-direct approach** for the pg_cron job (simpler, no pg_net needed):

**supabase/migrations/00010_reminders.sql:**

1. Enable pg_cron extension: `CREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA pg_catalog;`
   (Note: pg_cron may need to be enabled via Supabase Dashboard > Database > Extensions first. Add a comment noting this.)

2. Daily reminder job (runs at 8:00 AM UTC):
```sql
SELECT cron.schedule(
  'daily-service-reminders',
  '0 8 * * *',
  $$
    INSERT INTO public.notifications (recipient_member_id, type, title, body, metadata, action_url)
    SELECT
      sa.member_id,
      'reminder',
      'Serving Reminder',
      'You are serving as ' || tp.name || ' at ' || s.title || ' on ' || to_char(s.service_date, 'DD Mon YYYY'),
      jsonb_build_object('service_id', s.id, 'assignment_id', sa.id),
      '/my-schedule'
    FROM public.service_assignments sa
    JOIN public.service_positions sp ON sa.service_position_id = sp.id
    JOIN public.services s ON sp.service_id = s.id
    JOIN public.team_positions tp ON sp.position_id = tp.id
    LEFT JOIN public.member_profiles mp ON sa.member_id = mp.member_id
    WHERE sa.status != 'declined'
      AND s.is_cancelled = false
      AND COALESCE(mp.reminder_days_before, 2) > 0
      AND s.service_date = CURRENT_DATE + (COALESCE(mp.reminder_days_before, 2) || ' days')::interval
      AND NOT EXISTS (
        SELECT 1 FROM public.notifications n
        WHERE n.recipient_member_id = sa.member_id
          AND n.type = 'reminder'
          AND n.metadata->>'assignment_id' = sa.id::text
      );
  $$
);
```

3. Notification cleanup job (runs weekly, deletes notifications older than 90 days per research Pitfall 6):
```sql
SELECT cron.schedule(
  'cleanup-old-notifications',
  '0 3 * * 0',
  $$
    DELETE FROM public.notifications
    WHERE created_at < now() - interval '90 days';
  $$
);
```

4. Swap request expiry job (runs daily, expires pending swaps for past services):
```sql
SELECT cron.schedule(
  'expire-stale-swaps',
  '0 7 * * *',
  $$
    UPDATE public.swap_requests sr
    SET status = 'expired', updated_at = now()
    FROM public.service_assignments sa
    JOIN public.service_positions sp ON sa.service_position_id = sp.id
    JOIN public.services s ON sp.service_id = s.id
    WHERE sr.assignment_id = sa.id
      AND sr.status IN ('pending', 'accepted')
      AND s.service_date <= CURRENT_DATE;
  $$
);
```

The API route still serves as a manual trigger (admin can call it to generate reminders on-demand). Protect it with a simple check: either CRON_SECRET header or admin role via getUserRole.
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Verify migration file exists with 3 cron jobs. Verify API route exists and can be called (will need pg_cron enabled in Supabase to actually run the scheduled jobs).</verify>
  <done>pg_cron migration creates 3 scheduled jobs: daily reminders (8 AM), weekly cleanup (90 days), daily swap expiry. API route provides manual reminder trigger. Duplicate prevention via NOT EXISTS check on assignment_id in notification metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Update notification preferences UI for reminder configuration</name>
  <files>
    components/profiles/notification-preferences.tsx
    lib/profiles/actions.ts
  </files>
  <action>
**Modify components/profiles/notification-preferences.tsx:**
- The existing component likely has toggle switches for notify_email and notify_assignment_changes
- Add a new field: "Reminder days before service"
  - Use a Select dropdown (from shadcn/ui) with options: "No reminders" (0), "1 day before" (1), "2 days before" (2, default), "3 days before" (3), "5 days before" (5), "7 days before" (7)
  - Current value from member_profiles.reminder_days_before
  - On change: call updateNotificationPreferences server action with the new value
- Read the existing component first to understand the current structure and follow the same pattern

**Modify lib/profiles/actions.ts:**
- Ensure the updateNotificationPreferences action (or equivalent profile update action) handles `reminder_days_before` as an integer field
- If the action already handles all profile fields, verify reminder_days_before is included
- If it's a separate notification preferences action, add reminder_days_before to it
- Read the existing file first to understand what exists and extend it

Make sure the Select component uses `SelectContent position="popper"` with max-h-48 per existing convention (02-07 decision).
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Navigate to the profile page and check that the notification preferences section shows the reminder days dropdown. Change the value and verify it persists.</verify>
  <done>Notification preferences UI includes a "Reminder days before service" dropdown with options 0-7. Value persists to member_profiles.reminder_days_before. pg_cron job uses this value to determine when to send reminders for each member.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `pnpm lint` passes
- Migration file contains pg_cron extension enable + 3 scheduled jobs
- API route exists at /api/reminders with POST handler
- Notification preferences shows reminder_days_before dropdown
- Changing reminder preference persists to database
- Reminder query includes NOT EXISTS check to prevent duplicates
- Old notifications (90+ days) cleaned up by weekly cron job
- Stale swap requests expired by daily cron job
</verification>

<success_criteria>
- NOTF-05 satisfied: member receives reminder notification before service date, configurable days
- Reminder system prevents duplicate notifications
- Notification table doesn't grow unboundedly (90-day cleanup)
- Swap requests don't linger indefinitely (expiry for past services)
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-05-SUMMARY.md`
</output>
