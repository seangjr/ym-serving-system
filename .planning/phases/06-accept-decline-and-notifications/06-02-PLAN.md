---
phase: 06-accept-decline-and-notifications
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - lib/notifications/actions.ts
  - app/(app)/my-schedule/page.tsx
  - components/schedule/assignment-card.tsx
  - components/schedule/schedule-list.tsx
autonomous: true
requirements:
  - RESP-01
  - RESP-02
  - RESP-05

must_haves:
  truths:
    - "Member can confirm an assignment from My Schedule page"
    - "Member can decline an assignment from My Schedule page"
    - "Declining an assignment creates a notification for the team lead"
    - "Confirm/decline is achievable in 1-2 taps on mobile"
    - "My Schedule shows upcoming assignments grouped by date with service title, position, time, and status"
  artifacts:
    - path: "lib/notifications/actions.ts"
      provides: "respondToAssignment server action with decline notification"
      exports: ["respondToAssignment"]
    - path: "app/(app)/my-schedule/page.tsx"
      provides: "Server component fetching member's upcoming assignments"
      min_lines: 30
    - path: "components/schedule/schedule-list.tsx"
      provides: "Client component rendering assignments grouped by date"
      min_lines: 40
    - path: "components/schedule/assignment-card.tsx"
      provides: "Single assignment card with confirm/decline buttons"
      min_lines: 30
  key_links:
    - from: "components/schedule/assignment-card.tsx"
      to: "lib/notifications/actions.ts"
      via: "respondToAssignment server action call"
      pattern: "respondToAssignment"
    - from: "lib/notifications/actions.ts"
      to: "lib/notifications/send.ts"
      via: "createNotification on decline"
      pattern: "createNotification"
    - from: "app/(app)/my-schedule/page.tsx"
      to: "components/schedule/schedule-list.tsx"
      via: "passes fetched assignments as props"
      pattern: "ScheduleList"
---

<objective>
Implement the accept/decline assignment workflow: a respondToAssignment server action and a full My Schedule page where members see their upcoming assignments and can confirm or decline with 1-2 taps.

Purpose: This is the core member-facing feature -- the ability to respond to assignments. Declining notifies the team lead via the notification infrastructure from Plan 06-01.

Output: respondToAssignment action, My Schedule page with assignment cards, confirm/decline buttons
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@lib/notifications/types.ts
@lib/notifications/schemas.ts
@lib/notifications/send.ts
@lib/notifications/actions.ts
@lib/assignments/types.ts
@lib/assignments/queries.ts
@app/(app)/my-schedule/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add respondToAssignment server action</name>
  <files>lib/notifications/actions.ts</files>
  <action>
Add `respondToAssignment` server action to `lib/notifications/actions.ts` (which already has markAsRead and markAllAsRead from Plan 06-01):

1. Parse input with `respondToAssignmentSchema` from schemas.ts
2. Get caller's memberId via getUserRole
3. Verify ownership: query service_assignments where id = assignmentId AND member_id = callerId (using admin client). Return error if not found.
4. Update assignment status to parsed.data.status (confirmed or declined) using admin client
5. **On decline:** Look up the team lead for the assignment:
   - Join service_assignments -> service_positions -> team_members WHERE role = 'lead'
   - Also fetch the member name (from members table) and position name (from team_positions) and service title (from services)
   - Call createNotification() with:
     - recipientMemberId: team lead's member_id
     - type: 'assignment_declined'
     - title: 'Assignment Declined'
     - body: '{memberName} declined their {positionName} assignment for {serviceTitle}'
     - metadata: { assignmentId, serviceId, memberId: callerId }
     - actionUrl: '/services/{serviceId}'
6. **On confirm:** Also notify team lead (lower priority but helpful):
   - Same lookup as decline
   - type: 'assignment_confirmed'
   - title: 'Assignment Confirmed'
   - body: '{memberName} confirmed their {positionName} assignment for {serviceTitle}'
   - Same metadata/actionUrl
7. revalidatePath('/my-schedule')
8. Return { success: true } or { error: string }

Import createNotification from '../notifications/send' (use dynamic import to cross server-only boundary if needed, or since actions.ts is already "use server" it should work directly).

Follow the established pattern from lib/assignments/actions.ts.
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Verify respondToAssignment is exported from the file.</verify>
  <done>respondToAssignment server action exists, verifies ownership, updates status, and notifies team lead on decline (and confirm). Returns { success: true } | { error: string }.</done>
</task>

<task type="auto">
  <name>Task 2: Build My Schedule page with confirm/decline UI</name>
  <files>
    app/(app)/my-schedule/page.tsx
    components/schedule/schedule-list.tsx
    components/schedule/assignment-card.tsx
  </files>
  <action>
**app/(app)/my-schedule/page.tsx** (replace existing placeholder):
- Server component
- Get caller's memberId via getUserRole
- Query upcoming assignments for this member: service_assignments WHERE member_id = callerId AND the service's service_date >= today (CURRENT_DATE), joined with service_positions -> services (title, service_date, start_time, end_time) and team_positions (name, category) and serving_teams (name). Order by service_date ASC, start_time ASC.
- Use admin client for the query (member may not have RLS access to all joined tables)
- Pass data to ScheduleList client component
- Show page title "My Schedule" with subtitle "Your upcoming assignments"
- If no assignments, show the existing empty state

**Define types** at top of my-schedule/page.tsx or in a shared location:
- `ScheduleAssignment`: id, status, notes, serviceName, serviceDate, startTime, endTime, positionName, category, teamName, teamColor, serviceId

**components/schedule/schedule-list.tsx** ("use client"):
- Receives assignments as prop
- Groups assignments by serviceDate using a Map
- For each date group: render a date header (e.g., "Sunday, 23 February 2026") then the assignment cards
- Uses format() from date-fns for date formatting

**components/schedule/assignment-card.tsx** ("use client"):
- Receives a single ScheduleAssignment
- Renders a Card with:
  - Service title and time (start_time - end_time or just start_time)
  - Position name and team name (with team color dot)
  - Status badge: amber for pending, green for confirmed, red for declined (same colours as existing assignment status badges from Phase 4)
  - **Two buttons (only shown when status is 'pending'):**
    - "Confirm" button (green/primary variant) -- calls respondToAssignment({ assignmentId, status: 'confirmed' })
    - "Decline" button (destructive/outline variant) -- calls respondToAssignment({ assignmentId, status: 'declined' })
  - Use `useTransition` for isPending state on buttons (disable both while action runs)
  - Show toast on success/error via sonner
  - Buttons should be large enough for easy mobile tapping (min-h-10, full-width on mobile)
  - For confirmed/declined status: show a muted badge instead of buttons (no re-action needed)

**Mobile-first design (RESP-05):**
- Cards are full-width stacked on mobile
- Buttons are large tap targets (py-2.5 min)
- 1 tap to confirm, 1 tap to decline (no confirmation dialog needed for confirm; decline is 1 tap as well -- if the member made a mistake they can ask the team lead to reassign)
  </action>
  <verify>Run `pnpm build` to confirm no TypeScript errors. Run `pnpm lint` to check for issues. Navigate to /my-schedule in the browser -- it should show assignments (if any exist for the logged-in member) with Confirm/Decline buttons on pending items.</verify>
  <done>My Schedule page displays upcoming assignments grouped by date. Pending assignments show Confirm and Decline buttons. Tapping Confirm/Decline updates the assignment status and notifies the team lead. Confirmed/declined assignments show status badges instead of buttons. Mobile layout uses full-width cards with large tap targets.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `pnpm lint` passes
- /my-schedule shows the member's upcoming assignments (not the placeholder)
- Pending assignments display Confirm and Decline buttons
- Clicking Confirm changes status to confirmed, shows green badge
- Clicking Decline changes status to declined, shows red badge
- Declining creates a notification in the notifications table for the team lead
- Buttons are large and easy to tap on mobile (1-2 taps)
</verification>

<success_criteria>
- RESP-01 satisfied: member can confirm or decline from schedule view
- RESP-02 satisfied: declining triggers notification to team lead
- RESP-05 satisfied: 1-2 taps on mobile (single tap for confirm, single tap for decline)
- My Schedule page replaces placeholder with real assignment data
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-02-SUMMARY.md`
</output>
