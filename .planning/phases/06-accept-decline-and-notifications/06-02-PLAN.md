---
phase: 06-accept-decline-and-notifications
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - lib/notifications/actions.ts
  - app/(app)/my-schedule/page.tsx
  - components/assignments/assignment-card.tsx
  - components/assignments/assignment-response-buttons.tsx
  - components/assignments/decline-dialog.tsx
autonomous: true
requirements: [RESP-01, RESP-02, RESP-05]

must_haves:
  truths:
    - "Member can see their upcoming assignments as a flat chronological list on /my-schedule"
    - "Member can confirm an assignment with a single tap (no dialog)"
    - "Member can decline an assignment with a confirmation dialog ('Are you sure?')"
    - "Declining an assignment sends a notification to the team lead"
    - "Members can re-toggle between confirmed and declined freely"
    - "Past assignments are not shown (only upcoming)"
    - "Empty state shows 'No upcoming assignments' with a subtle icon"
    - "Confirm/decline buttons are always visible on every assignment card"
  artifacts:
    - path: "app/(app)/my-schedule/page.tsx"
      provides: "My Schedule page rendering upcoming assignments"
      min_lines: 30
    - path: "components/assignments/assignment-card.tsx"
      provides: "Compact assignment card with position, team, time, status badge, action buttons"
      min_lines: 40
    - path: "components/assignments/assignment-response-buttons.tsx"
      provides: "Confirm/Decline button pair for assignment response"
      exports: ["AssignmentResponseButtons"]
    - path: "components/assignments/decline-dialog.tsx"
      provides: "AlertDialog confirmation for declining"
      exports: ["DeclineDialog"]
    - path: "lib/notifications/actions.ts"
      provides: "respondToAssignment server action"
      exports: ["respondToAssignment"]
  key_links:
    - from: "components/assignments/assignment-response-buttons.tsx"
      to: "lib/notifications/actions.ts"
      via: "respondToAssignment server action call"
      pattern: "respondToAssignment"
    - from: "lib/notifications/actions.ts"
      to: "lib/notifications/send.ts"
      via: "createNotification on decline"
      pattern: "createNotification"
    - from: "app/(app)/my-schedule/page.tsx"
      to: "lib/notifications/queries.ts"
      via: "getMyAssignments query"
      pattern: "getMyAssignments"
---

<objective>
Build the accept/decline workflow and My Schedule page. Members see their upcoming assignments as a flat chronological list and can confirm (1 tap) or decline (with confirmation dialog) each assignment. Declining triggers a notification to the team lead.

Purpose: This is the core member-facing feature -- the reason members open the app. Satisfies RESP-01, RESP-02, RESP-05.
Output: Working /my-schedule page with confirm/decline buttons, respondToAssignment server action.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-CONTEXT.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@lib/notifications/types.ts
@lib/notifications/queries.ts
@lib/notifications/actions.ts
@lib/notifications/send.ts
@lib/assignments/types.ts
@lib/auth/roles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: respondToAssignment server action with decline notification</name>
  <files>lib/notifications/actions.ts</files>
  <action>
Add the respondToAssignment server action to lib/notifications/actions.ts (alongside the existing markAsRead/markAllRead actions from Plan 01):

respondToAssignment(data: unknown):
1. Create RLS client, getUserRole to get callerId
2. Parse with respondToAssignmentSchema (from schemas.ts): { assignmentId, status: 'confirmed' | 'declined' }
3. Verify ownership: query service_assignments where id = assignmentId AND member_id = callerId. If not found, return { error: "Assignment not found or not yours." }
4. Update status via admin client: service_assignments.update({ status }).eq('id', assignmentId)
5. On decline, send notification to team lead:
   - Query the assignment's service_position -> team_id
   - Query team_members where team_id and role='lead' to find team lead member_id
   - Query service details (title, service_date) and position name for notification body
   - Call createNotification() with:
     - recipientMemberId: team lead's member_id
     - type: 'assignment_declined'
     - title: 'Assignment Declined'
     - body: '{memberName} declined {positionName} for {serviceTitle} on {formatted date}'
     - metadata: { assignmentId, serviceId, memberId: callerId }
     - actionUrl: '/services/{serviceId}'
   - If no team lead found, skip notification (don't error)
6. revalidatePath('/my-schedule')
7. Return { success: true }

Follow the exact server action pattern from lib/assignments/actions.ts.
  </action>
  <verify>Run `pnpm build` to verify compilation. Verify the action imports createNotification from send.ts and uses the admin client pattern.</verify>
  <done>respondToAssignment action updates assignment status, sends decline notification to team lead, verifies ownership, and follows established patterns.</done>
</task>

<task type="auto">
  <name>Task 2: My Schedule page with compact assignment cards and confirm/decline</name>
  <files>app/(app)/my-schedule/page.tsx, components/assignments/assignment-card.tsx, components/assignments/assignment-response-buttons.tsx, components/assignments/decline-dialog.tsx</files>
  <action>
**app/(app)/my-schedule/page.tsx** (server component):
- Import getMyAssignments from lib/notifications/queries (uses getMyAssignments which fetches upcoming assignments for the logged-in member)
- Import getUserRole, createClient for auth
- Fetch assignments via getMyAssignments()
- Render page header: "My Schedule" title with "Your upcoming assignments" subtitle
- If no assignments: render empty state with a CalendarCheck icon (lucide-react) and "No upcoming assignments" text, styled subtly (text-muted-foreground, dashed border container)
- If assignments exist: render a flat list (no grouping) of AssignmentCard components, ordered by date (already sorted from query)
- Pass each assignment's data + memberId to AssignmentCard

**components/assignments/assignment-card.tsx** ("use client"):
- Compact card per user decision: essentials only
- Layout: Card component with padding p-3 (compact density)
- Left section: position name (font-semibold), team name (text-xs text-muted-foreground)
- Middle: service date formatted as "Mon DD" (e.g., "Feb 23"), start_time formatted as "9:00 AM"
- Right section: status badge + AssignmentResponseButtons
- Status badge: amber for pending, green for confirmed, red for declined (reuse existing status badge colors from Phase 4: amber-pending, green-confirmed, red-declined)
- Badge uses small text (text-xs) with colored background
- AssignmentResponseButtons rendered inline on every card (always visible per user decision)

**components/assignments/assignment-response-buttons.tsx** ("use client"):
- Props: assignmentId (string), currentStatus ('pending' | 'confirmed' | 'declined')
- Two buttons: Confirm (Check icon) and Decline (X icon)
- Confirm button: variant="ghost" size="icon-sm", green hover color. On click, directly calls respondToAssignment({ assignmentId, status: 'confirmed' }). Single tap, NO dialog per user decision.
- Decline button: variant="ghost" size="icon-sm", red hover color. On click, opens DeclineDialog.
- Use useTransition for pending state on both buttons (show spinner/disabled while action runs)
- Optimistic UI: immediately update visual state while action runs. Use startTransition.
- If current status matches the button action (e.g., already confirmed and clicking confirm), that button should appear "active" (filled/solid variant) to indicate current state. The other button remains available for re-toggling.

**components/assignments/decline-dialog.tsx** ("use client"):
- AlertDialog (from components/ui/alert-dialog) with:
  - Title: "Decline Assignment?"
  - Description: "Are you sure you want to decline this assignment? Your team lead will be notified."
  - Cancel button and Decline button (destructive variant)
- On confirm, calls respondToAssignment({ assignmentId, status: 'declined' })
- Use useTransition for pending state on the decline action button
- Controlled via open/onOpenChange props from parent

Mobile-first design: cards should be touch-friendly with adequate tap targets (min 44px for buttons). The entire card layout should work on narrow screens.
  </action>
  <verify>Run `pnpm build` to verify compilation. Navigate to /my-schedule in the browser -- verify it shows assignment cards (or empty state). Test confirm (single tap) and decline (with dialog) on an existing assignment.</verify>
  <done>My Schedule page shows flat chronological list of upcoming assignments. Each card displays position, team, date/time, status badge, and always-visible confirm/decline buttons. Confirming is 1 tap, declining shows confirmation dialog. Declining notifies team lead.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- /my-schedule page renders assignment cards for a logged-in member with assignments
- /my-schedule shows empty state when member has no upcoming assignments
- Confirm button updates status to 'confirmed' immediately (1 tap)
- Decline button opens AlertDialog, confirming updates status to 'declined'
- Declining creates a notification row for the team lead in the notifications table
- Past service dates are not shown
- Cards are compact with position name, team, date, time, status badge, and action buttons
</verification>

<success_criteria>
- Member sees upcoming assignments on /my-schedule as flat list
- Confirm is 1 tap, decline requires confirmation dialog
- Decline triggers notification to team lead (verified in DB)
- Status re-toggles freely (confirmed <-> declined)
- Empty state renders when no assignments
- Mobile-friendly tap targets on buttons
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-02-SUMMARY.md`
</output>
