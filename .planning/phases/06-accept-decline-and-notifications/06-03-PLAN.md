---
phase: 06-accept-decline-and-notifications
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - components/notifications/notification-bell.tsx
  - components/notifications/notification-popover.tsx
  - components/notifications/notification-item.tsx
  - components/notifications/notification-provider.tsx
  - app/(app)/layout.tsx
  - components/app-sidebar.tsx
  - lib/assignments/actions.ts
autonomous: true
requirements: [NOTF-01, NOTF-02, NOTF-04]

must_haves:
  truths:
    - "Bell icon with unread count badge appears in the app header area"
    - "Clicking bell opens a popover dropdown showing recent notifications"
    - "Unread notifications have bold text and a small blue dot indicator"
    - "Read notifications have normal weight text (no blue dot)"
    - "Clicking a notification navigates to its action URL and marks it as read"
    - "New notifications arrive in real-time via Supabase Realtime (no page refresh needed)"
    - "New notification shows a sonner toast with title and a quick-action button"
    - "Assigning a member creates an 'assignment_new' notification for that member"
    - "Unassigning a member creates an 'assignment_changed' notification"
  artifacts:
    - path: "components/notifications/notification-bell.tsx"
      provides: "Bell icon with unread count badge"
      exports: ["NotificationBell"]
    - path: "components/notifications/notification-popover.tsx"
      provides: "Popover dropdown listing recent notifications"
      exports: ["NotificationPopover"]
    - path: "components/notifications/notification-item.tsx"
      provides: "Single notification row with read/unread styling"
      exports: ["NotificationItem"]
    - path: "components/notifications/notification-provider.tsx"
      provides: "React context with Supabase Realtime subscription"
      exports: ["NotificationContextProvider", "useNotifications"]
    - path: "app/(app)/layout.tsx"
      provides: "Updated layout with NotificationContextProvider and bell icon"
      min_lines: 20
  key_links:
    - from: "components/notifications/notification-provider.tsx"
      to: "supabase Realtime"
      via: "postgres_changes subscription on notifications table"
      pattern: "postgres_changes.*notifications"
    - from: "components/notifications/notification-bell.tsx"
      to: "components/notifications/notification-popover.tsx"
      via: "Popover trigger renders popover content"
      pattern: "NotificationPopover"
    - from: "lib/assignments/actions.ts"
      to: "lib/notifications/send.ts"
      via: "createNotification() on assign/unassign"
      pattern: "createNotification"
---

<objective>
Build the in-app notification UI: bell icon with unread badge in the app header, notification popover dropdown (GitHub-style), Supabase Realtime subscription for live updates, sonner toast on new notification arrival, and emit notifications when members are assigned/unassigned.

Purpose: Makes notifications visible and actionable for users. Real-time delivery ensures members know immediately when assigned. Satisfies NOTF-01, NOTF-02, NOTF-04.
Output: Bell icon in header, notification popover, real-time updates, assignment notifications.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-accept-decline-and-notifications/06-CONTEXT.md
@.planning/phases/06-accept-decline-and-notifications/06-RESEARCH.md
@.planning/phases/06-accept-decline-and-notifications/06-01-SUMMARY.md
@lib/notifications/types.ts
@lib/notifications/queries.ts
@lib/notifications/actions.ts
@lib/notifications/send.ts
@lib/supabase/client.ts
@app/(app)/layout.tsx
@components/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification React context with Supabase Realtime subscription and bell/popover UI</name>
  <files>components/notifications/notification-provider.tsx, components/notifications/notification-bell.tsx, components/notifications/notification-popover.tsx, components/notifications/notification-item.tsx</files>
  <action>
**components/notifications/notification-provider.tsx** ("use client"):
- Create NotificationContext with: notifications (Notification[]), unreadCount (number), markAsRead (fn), markAllRead (fn), isLoading (boolean)
- NotificationContextProvider component:
  - Props: memberId (string), initialNotifications (Notification[]), initialUnreadCount (number)
  - State: notifications array, unreadCount
  - useEffect: Set up Supabase Realtime subscription:
    - Channel: `notifications:${memberId}`
    - Event: postgres_changes, INSERT on public.notifications, filter: `recipient_member_id=eq.${memberId}`
    - On new notification: prepend to notifications array, increment unreadCount, show sonner toast with:
      - Title: notification title
      - Description: notification body (truncated to ~80 chars)
      - Action button: "View" that navigates to notification's action_url using router.push()
      - Duration: 5000ms
  - Cleanup: remove channel on unmount
  - markAsRead: call markAsRead server action, update local state (set isRead=true, decrement unreadCount)
  - markAllRead: call markAllRead server action, update local state
- Export useNotifications() hook that consumes context

**components/notifications/notification-bell.tsx** ("use client"):
- Uses useNotifications() to get unreadCount
- Renders Bell icon (lucide-react) inside a button
- If unreadCount > 0: render a small red badge with count (max display "9+" for 10+)
- Badge: absolute positioned, top-right of bell, text-[10px], bg-destructive, text-destructive-foreground, rounded-full, min-w-4 h-4
- Wraps NotificationPopover as the popover content (Popover component from ui/)
- NotificationBell is the Popover trigger

**components/notifications/notification-popover.tsx** ("use client"):
- PopoverContent with:
  - Header: "Notifications" title + "Mark all read" button (only shown if unreadCount > 0)
  - Width: w-80 (320px), max-h-96 with overflow-y-auto
  - List of NotificationItem components
  - Empty state: "No notifications" text centered
  - "Mark all read" calls markAllRead from context
- On open, fetch latest notifications if stale (or rely on Realtime subscription for freshness)

**components/notifications/notification-item.tsx** ("use client"):
- Props: notification (Notification), onRead (fn)
- Layout: flex row
  - Left: small blue dot indicator (w-2 h-2 rounded-full bg-blue-500) for unread, invisible for read
  - Center: title (font-semibold if unread, normal if read), body (text-xs text-muted-foreground, truncated to 2 lines), time (relative: "2m ago", "1h ago" -- use simple relative time helper, no external dep)
  - Right: subtle arrow/chevron indicating clickable
- On click: navigate to action_url (router.push), call onRead(notificationId)
- Hover: bg-muted/50 for subtle highlight

Also add Bell and CalendarOff to the ICON_MAP in app-sidebar.tsx to fix the existing CalendarOff bug (Pitfall 7 from research) and support future Bell icon usage in nav.
  </action>
  <verify>Run `pnpm build` to verify compilation. Check that NotificationContextProvider compiles with Realtime subscription setup. Verify imports are correct and no circular dependencies.</verify>
  <done>Notification bell component with unread badge, popover dropdown with notification list, Realtime subscription for live updates, sonner toast on new notification, CalendarOff+Bell added to sidebar ICON_MAP.</done>
</task>

<task type="auto">
  <name>Task 2: Wire notification UI into app layout and emit notifications on assign/unassign</name>
  <files>app/(app)/layout.tsx, lib/assignments/actions.ts, components/app-sidebar.tsx</files>
  <action>
**app/(app)/layout.tsx:**
- Import NotificationContextProvider from components/notifications/notification-provider
- Import getNotifications, getUnreadCount from lib/notifications/queries
- Import getUserRole (already imported)
- After resolving role and user, also get memberId from getUserRole result
- Fetch initialNotifications = await getNotifications(20) and initialUnreadCount = await getUnreadCount()
- Wrap SidebarInset content with NotificationContextProvider passing memberId, initialNotifications, initialUnreadCount
- Add a header bar above the main content inside SidebarInset:
  - Flex row with justify-end (or space-between if adding breadcrumbs later)
  - Contains NotificationBell component on the right side
  - Sticky top-0 with bg-background/95 backdrop-blur and border-b for visual separation
  - Only render the header/bell for authenticated users (always, since we're in the (app) layout)
  - Height: h-12 with px-4 flex items-center
- The main content area remains below the header

Note: The header bar gives a consistent location for the bell icon across all pages, similar to GitHub's top bar.

**lib/assignments/actions.ts:**
- Import createNotification from lib/notifications/send
- Modify assignMember():
  - After successful INSERT of service_assignment, get the assigned member's name and service details
  - Call createNotification() with:
    - recipientMemberId: parsed.data.memberId (the member being assigned)
    - type: 'assignment_new'
    - title: 'New Assignment'
    - body: 'You have been assigned as {positionName} for {serviceTitle} on {formatted date}'
    - metadata: { assignmentId: <new assignment id>, serviceId: parsed.data.serviceId }
    - actionUrl: '/my-schedule'
  - To get the new assignment ID, change the insert to use .select('id').single() to return the inserted row
  - Wrap createNotification in try/catch -- notification failure should NOT fail the assignment
- Modify unassignMember():
  - Before deleting, fetch the assignment to get member_id, position name, and service details
  - After successful DELETE, call createNotification() with:
    - recipientMemberId: the member who was unassigned
    - type: 'assignment_changed'
    - title: 'Assignment Removed'
    - body: 'Your {positionName} assignment for {serviceTitle} on {date} has been removed'
    - metadata: { serviceId: parsed.data.serviceId }
    - actionUrl: '/my-schedule'
  - Wrap in try/catch

**components/app-sidebar.tsx:**
- Add CalendarOff and Bell to imports from lucide-react
- Add both to ICON_MAP: { ...existing, CalendarOff, Bell }
- This fixes the existing CalendarOff icon bug (Pitfall 7) and prepares Bell for any nav usage
  </action>
  <verify>Run `pnpm build` to verify compilation. Navigate to the app -- verify the bell icon appears in the header. Assign a member to a service position, then check the notifications table for a new 'assignment_new' row. Verify the bell shows the unread count.</verify>
  <done>App layout has sticky header with notification bell. Assigning a member emits 'assignment_new' notification. Unassigning emits 'assignment_changed'. Realtime subscription delivers notifications live. CalendarOff icon bug fixed in sidebar.</done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- Bell icon visible in app header on all pages
- Unread count badge shows correct number
- Clicking bell opens popover with notification list
- Unread notifications have blue dot + bold text
- Clicking notification navigates to action URL and marks it read
- "Mark all read" clears all unread indicators
- Assigning a member creates 'assignment_new' notification (visible in bell)
- Unassigning creates 'assignment_changed' notification
- New notifications appear in real-time (no refresh needed) via Supabase Realtime
- Sonner toast appears on new notification with "View" action button
- CalendarOff icon renders correctly for Availability nav item
</verification>

<success_criteria>
- Bell icon with unread count badge in app header
- Notification popover with read/unread distinction
- Supabase Realtime delivers notifications without polling
- Sonner toast on new notification arrival
- assignMember() and unassignMember() emit notifications
- CalendarOff sidebar icon bug fixed
</success_criteria>

<output>
After completion, create `.planning/phases/06-accept-decline-and-notifications/06-03-SUMMARY.md`
</output>
