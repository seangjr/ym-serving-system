---
phase: 02-teams-and-member-profiles
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/(app)/teams/page.tsx
  - app/(app)/teams/[teamId]/page.tsx
  - components/teams/team-card.tsx
  - components/teams/team-form-dialog.tsx
  - components/teams/position-manager.tsx
  - components/teams/member-assignment.tsx
  - components/teams/team-member-list.tsx
autonomous: true

must_haves:
  truths:
    - "Admin/committee can create a new team with name, description, and color via a dialog form"
    - "Admin/committee can edit an existing team's name, description, and color"
    - "Admin/committee can delete a team with confirmation"
    - "Admin/committee can add positions to a team with name, category, and quantity needed"
    - "Admin/committee can edit and delete positions within a team"
    - "Admin/committee or team lead can add members to a team via a searchable combobox"
    - "Admin/committee or team lead can remove members from a team"
    - "Admin/committee can promote a member to team lead or demote to member for a specific team"
    - "Team detail page shows all members with their roles and position skills"
    - "Teams page shows grid of team cards with name, member count, lead name, and color indicator"
  artifacts:
    - path: "app/(app)/teams/page.tsx"
      provides: "Teams listing page with create button"
      min_lines: 30
    - path: "app/(app)/teams/[teamId]/page.tsx"
      provides: "Team detail page with positions and members"
      min_lines: 50
    - path: "components/teams/team-form-dialog.tsx"
      provides: "Create/edit team dialog form"
      contains: "createTeam\\|updateTeam"
    - path: "components/teams/position-manager.tsx"
      provides: "Position CRUD within a team"
      contains: "createPosition"
    - path: "components/teams/member-assignment.tsx"
      provides: "Add members to team via searchable combobox"
      contains: "addMemberToTeam"
    - path: "components/teams/team-member-list.tsx"
      provides: "Member list with role badges and skill display"
      min_lines: 40
  key_links:
    - from: "app/(app)/teams/page.tsx"
      to: "lib/teams/queries.ts"
      via: "getTeams() server component data fetch"
      pattern: "getTeams\\(\\)"
    - from: "app/(app)/teams/[teamId]/page.tsx"
      to: "lib/teams/queries.ts"
      via: "getTeamWithMembers() server component data fetch"
      pattern: "getTeamWithMembers\\("
    - from: "components/teams/team-form-dialog.tsx"
      to: "lib/teams/actions.ts"
      via: "createTeam/updateTeam server action calls"
      pattern: "createTeam\\(|updateTeam\\("
    - from: "components/teams/member-assignment.tsx"
      to: "lib/teams/queries.ts"
      via: "getAllMembers() for combobox search"
      pattern: "getAllMembers\\("
---

<objective>
Build the team management UI pages where admin/committee users can create teams, manage positions, assign leads, and add/remove members.

Purpose: Delivers TEAM-01 through TEAM-06 requirements -- the full team and position management workflow for admins and team leads.

Output: Two page routes (/teams and /teams/[teamId]) and five components for team CRUD, position management, and member assignment.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-teams-and-member-profiles/02-RESEARCH.md
@.planning/phases/02-teams-and-member-profiles/02-01-SUMMARY.md
@lib/teams/actions.ts
@lib/teams/queries.ts
@lib/teams/schemas.ts
@lib/auth/roles.ts
@components/admin/user-role-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Teams listing page with team cards and create team dialog</name>
  <files>
    app/(app)/teams/page.tsx
    components/teams/team-card.tsx
    components/teams/team-form-dialog.tsx
  </files>
  <action>
**app/(app)/teams/page.tsx** — Server component (admin/committee only access):
- Import getUserRole, createClient, getTeams from established modules.
- Verify role is admin or committee at the top; if not, redirect to "/" using next/navigation redirect().
- Fetch teams via getTeams().
- Render page heading "Teams" with a "Create Team" button (opens TeamFormDialog).
- Display teams in a responsive grid: 1 col on mobile, 2 cols on md, 3 cols on lg.
- Each team rendered as a TeamCard component.
- If no teams exist, show an empty state message encouraging creation.
- Pass user role to client components so they can conditionally show/hide admin-only actions.

**components/teams/team-card.tsx** — Client component ("use client"):
- Props: team object (id, name, description, color, memberCount, leadName), userRole.
- Card layout using shadcn/ui Card component.
- Left color bar or top accent using the team's hex color.
- Display: team name (bold), description (truncated, muted), member count with Users icon, lead name with Crown/Star icon.
- Click anywhere on card navigates to `/teams/${team.id}` using next/navigation useRouter.
- Show edit button (pencil icon) for admin/committee that opens TeamFormDialog in edit mode.
- Show delete button (trash icon) for admin only with confirmation dialog (AlertDialog).
- Delete calls deleteTeam server action.
- Use toast from sonner for success/error feedback.

**components/teams/team-form-dialog.tsx** — Client component ("use client"):
- Props: mode ("create" | "edit"), team (optional, for edit), trigger (ReactNode for the button), onSuccess callback.
- Uses shadcn/ui Dialog with DialogTrigger.
- Form with react-hook-form + zodResolver using createTeamSchema/updateTeamSchema.
- Fields: name (Input), description (Textarea), color (Input type="color" or a simple hex input).
- Submit calls createTeam or updateTeam server action.
- Show loading state during submission (disable button, show spinner).
- Close dialog on success and call onSuccess. Show toast.
- Show inline error if server action returns { error }.

Follow the established responsive pattern from `components/admin/user-role-table.tsx` for mobile-friendly layout.
  </action>
  <verify>
```bash
pnpm build 2>&1 | tail -10
# Verify files exist
ls app/\(app\)/teams/page.tsx components/teams/team-card.tsx components/teams/team-form-dialog.tsx
```
  </verify>
  <done>Teams page shows a responsive grid of team cards with name, color accent, member count, and lead name. Admin/committee can create new teams via a dialog form. Admin can delete teams with confirmation. Cards link to team detail pages.</done>
</task>

<task type="auto">
  <name>Task 2: Team detail page with position management and member assignment</name>
  <files>
    app/(app)/teams/[teamId]/page.tsx
    components/teams/position-manager.tsx
    components/teams/member-assignment.tsx
    components/teams/team-member-list.tsx
  </files>
  <action>
**app/(app)/teams/[teamId]/page.tsx** — Server component:
- Import getTeamWithMembers, getUserRole, createClient.
- Verify role is admin/committee OR user is a lead of this team. If neither, redirect to "/".
- Fetch team data with members via getTeamWithMembers(teamId).
- If team not found, call notFound() from next/navigation.
- Layout: Team name as heading with color indicator, description below, edit button (opens TeamFormDialog).
- Two main sections side by side on desktop (grid cols-1 lg:cols-2), stacked on mobile:
  - **Left: Positions** — PositionManager component showing all positions in the team.
  - **Right: Members** — MemberAssignment (add button) + TeamMemberList.
- Pass userRole and callerMemberId to components for authorization-aware rendering.

**components/teams/position-manager.tsx** — Client component ("use client"):
- Props: teamId, positions array, userRole.
- Displays positions grouped by category (if categories exist, otherwise flat list).
- Each position shows: name, category badge, quantity_needed, sort_order, active status.
- Admin/committee can:
  - Add position: inline form or small dialog with name, category, quantity_needed fields.
  - Edit position: click to expand inline edit form.
  - Delete position: trash icon with confirmation.
  - Toggle active/inactive.
- Calls createPosition, updatePosition, deletePosition server actions.
- Use toast for feedback.
- If no positions, show empty state with "Add your first position" prompt.

**components/teams/member-assignment.tsx** — Client component ("use client"):
- Props: teamId, existingMemberIds (to exclude from search), userRole.
- Uses shadcn/ui Combobox (Command component) for searchable member selection.
- Fetches available members via getAllMembers() — filter out existingMemberIds client-side or show them as disabled.
- On select, calls addMemberToTeam server action with default role "member".
- Show toast on success/error.
- Accessible via a "Add Member" button that opens a Popover with the Combobox.

**components/teams/team-member-list.tsx** — Client component ("use client"):
- Props: teamId, members array (with roles, skills, profile data), userRole, callerMemberId.
- Responsive layout: mobile cards, desktop table (reuse pattern from user-role-table.tsx).
- Each member shows:
  - Avatar (from member_profiles.avatar_url, fallback to initials using shadcn Avatar).
  - Name, email.
  - Role badge: "Lead" (with crown icon) or "Member".
  - Position skills with proficiency badges (color-coded: beginner=gray, intermediate=blue, advanced=purple, expert=gold).
- Actions per member (visible to admin/committee or team lead):
  - Promote to lead / demote to member (calls updateMemberTeamRole).
  - Remove from team (calls removeMemberFromTeam with confirmation).
  - Edit skills: open a dialog to set proficiency/preference per position (calls updateMemberPositionSkill).
- Sort: leads first, then alphabetical by name.
  </action>
  <verify>
```bash
pnpm build 2>&1 | tail -10
ls app/\(app\)/teams/\[teamId\]/page.tsx components/teams/position-manager.tsx components/teams/member-assignment.tsx components/teams/team-member-list.tsx
```
  </verify>
  <done>Team detail page shows positions (with CRUD for admin/committee) and members (with assignment, role management, and skill editing). Position manager supports add/edit/delete with category grouping. Member assignment uses searchable combobox. Member list shows avatars, role badges, and proficiency levels with responsive mobile/desktop layouts.</done>
</task>

</tasks>

<verification>
After both tasks are complete:
1. `pnpm build` passes without errors
2. `pnpm lint` passes
3. `/teams` page renders team grid for admin/committee users
4. `/teams/[teamId]` page renders team detail with positions and members
5. All CRUD operations wire to server actions from 02-01
6. Role-based access: admin/committee see all management controls, team leads see member management only
7. Responsive layout works on mobile (cards) and desktop (grid/table)
</verification>

<success_criteria>
- Teams page shows responsive grid of team cards with create button
- Team detail page shows positions section and members section
- Create/edit/delete team works via dialog forms
- Add/edit/delete positions works within team detail
- Add/remove members works via searchable combobox
- Promote/demote team lead works
- Position skill editing works per member
- Mobile-friendly responsive layout throughout
- TEAM-01 through TEAM-06 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/02-teams-and-member-profiles/02-02-SUMMARY.md`
</output>
