---
phase: 02-teams-and-member-profiles
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/profiles/queries.ts
  - lib/profiles/actions.ts
  - components/profiles/profile-form.tsx
  - components/profiles/notification-preferences.tsx
  - app/(app)/profile/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Profile personal info fields (phone, emergency contact, birthdate) read from and write to the shared members table"
    - "member_profiles table only stores serving-specific fields: avatar_url, joined_serving_at, notify_email, notify_assignment_changes, reminder_days_before"
    - "Reminder days dropdown has fixed height with internal scrolling"
  artifacts:
    - path: "lib/profiles/queries.ts"
      provides: "getOwnProfile reads phone/emergency/birthdate from members table directly"
    - path: "lib/profiles/actions.ts"
      provides: "updateOwnProfile writes phone/emergency/birthdate to members table, not member_profiles"
    - path: "components/profiles/notification-preferences.tsx"
      provides: "SelectContent with max-height and overflow-y-auto for fixed dropdown"
    - path: "app/(app)/profile/page.tsx"
      provides: "Profile page passes data from correct sources"
  key_links:
    - from: "lib/profiles/actions.ts"
      to: "members table"
      via: "supabase update on members"
      pattern: 'from\\("members"\\)'
    - from: "lib/profiles/queries.ts"
      to: "members table"
      via: "supabase select phone, emergency_contact_name, etc from members"
      pattern: "phone|emergency_contact"
---

<objective>
Redirect profile personal info fields to the shared `members` table and fix the reminder days dropdown height.

Purpose: Close Gap 7 (profile fields should use shared members table) and Gap 8 (dropdown fixed height) from UAT. The shared `members` table already has phone, emergency_contact_name, emergency_contact_phone, and birthdate columns. Currently these are duplicated in `member_profiles` — they should be read/written from `members` directly. `member_profiles` should only keep serving-specific fields.
Output: Profile correctly reads/writes shared fields from `members` table; dropdown has fixed scrollable height.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/profiles/queries.ts
@lib/profiles/actions.ts
@lib/profiles/schemas.ts
@components/profiles/profile-form.tsx
@components/profiles/notification-preferences.tsx
@app/(app)/profile/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redirect profile queries and actions to shared members table</name>
  <files>lib/profiles/queries.ts, lib/profiles/actions.ts, app/(app)/profile/page.tsx</files>
  <action>
    **In `lib/profiles/queries.ts`:**
    1. Update the `OwnProfile` interface: move phone, emergency_contact_name, emergency_contact_phone, birthdate from the nested `member_profiles` object to the top level (they come from `members` table directly):
       ```typescript
       export interface OwnProfile {
         id: string;
         full_name: string;
         email: string;
         phone: string | null;
         emergency_contact_name: string | null;
         emergency_contact_phone: string | null;
         birthdate: string | null;
         created_at: string;
         member_profiles: {
           avatar_url: string | null;
           joined_serving_at: string | null;
           notify_email: boolean;
           notify_assignment_changes: boolean;
           reminder_days_before: number;
           updated_at: string;
         } | null;
       }
       ```
    2. Update the `getOwnProfile()` query to select phone, emergency_contact_name, emergency_contact_phone, birthdate from `members` directly (not from member_profiles). The member_profiles select should only include: avatar_url, joined_serving_at, notify_email, notify_assignment_changes, reminder_days_before, updated_at.
       ```typescript
       .select(`
         id,
         full_name,
         email,
         phone,
         emergency_contact_name,
         emergency_contact_phone,
         birthdate,
         created_at,
         member_profiles(
           avatar_url,
           joined_serving_at,
           notify_email,
           notify_assignment_changes,
           reminder_days_before,
           updated_at
         )
       `)
       ```
    3. Update `MemberProfile` interface similarly: move phone, emergency_contact_name, emergency_contact_phone, birthdate to top level. Update `getMemberProfile()` query accordingly.

    **In `lib/profiles/actions.ts`:**
    1. Update `updateOwnProfile()` to write phone, emergency_contact_name, emergency_contact_phone, birthdate to the `members` table instead of `member_profiles`:
       ```typescript
       // Write personal info to shared members table
       const memberUpdates: Record<string, unknown> = {};
       for (const [key, value] of Object.entries(parsed.data)) {
         memberUpdates[key] = value === "" ? null : value;
       }

       const admin = createAdminClient();
       const { error } = await admin
         .from("members")
         .update(memberUpdates)
         .eq("id", memberId);
       ```
       Do NOT write these fields to member_profiles anymore.
    2. Similarly update `adminUpdateMemberProfile()` to write to `members` table instead of `member_profiles` for these fields.

    **In `app/(app)/profile/page.tsx`:**
    1. Update the `initialData` prop passed to `ProfileForm` to read phone, emergency_contact_name, emergency_contact_phone, birthdate from `profile` directly (top-level) instead of `profileData` (the nested member_profiles):
       ```typescript
       phone: profile.phone ?? "",
       emergency_contact_name: profile.emergency_contact_name ?? "",
       emergency_contact_phone: profile.emergency_contact_phone ?? "",
       birthdate: profile.birthdate ?? "",
       ```
  </action>
  <verify>
    Run `pnpm build` — no TypeScript errors. The profile page should load and display personal info from the `members` table. Saving personal info should update the `members` table.
  </verify>
  <done>
    Profile personal info fields read/write from the shared `members` table. `member_profiles` only stores serving-specific fields (avatar_url, joined_serving_at, notification prefs).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix reminder days dropdown height</name>
  <files>components/profiles/notification-preferences.tsx</files>
  <action>
    In the `NotificationPreferences` component, find the `<SelectContent>` inside the `reminder_days_before` form field. Add a `className` with `max-h-48 overflow-y-auto` to constrain its height and enable internal scrolling:
    ```tsx
    <SelectContent className="max-h-48">
    ```
    The shadcn/ui Select component's SelectContent already uses Radix's ScrollArea internally, but the max-height needs to be set to prevent the dropdown from growing unbounded. If `max-h-48` doesn't work with the Select component pattern, try using the `position="popper"` prop on SelectContent along with `className="max-h-48"`.

    Note: shadcn/ui's SelectContent may need `position="popper"` and a `sideOffset` for the scroll constraint to work properly. Check if the existing component supports these props.
  </action>
  <verify>
    Run `pnpm build` — no errors. The reminder days dropdown should show a fixed-height list with internal scrolling instead of growing unbounded.
  </verify>
  <done>
    Reminder days dropdown has a fixed height (max-h-48, ~192px) with internal scrolling, preventing unbounded growth.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. Profile page loads personal info (phone, emergency contact, birthdate) from `members` table
3. Saving personal info writes to `members` table (not member_profiles)
4. member_profiles only stores: avatar_url, joined_serving_at, notify_email, notify_assignment_changes, reminder_days_before
5. Reminder days dropdown has fixed height with scroll
</verification>

<success_criteria>
- Profile personal info correctly uses shared `members` table for read and write
- No data duplication between `members` and `member_profiles` tables
- Reminder days dropdown has constrained height with internal scrolling
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-teams-and-member-profiles/02-07-SUMMARY.md`
</output>
