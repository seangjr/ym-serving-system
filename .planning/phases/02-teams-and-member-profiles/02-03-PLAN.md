---
phase: 02-teams-and-member-profiles
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/(app)/profile/page.tsx
  - components/profiles/profile-form.tsx
  - components/profiles/avatar-upload.tsx
  - components/profiles/notification-preferences.tsx
  - components/profiles/position-preferences.tsx
  - lib/auth/roles.ts
autonomous: true

must_haves:
  truths:
    - "Member can view their own profile with name, email, phone, emergency contact, birthdate, and join date"
    - "Member can edit their own profile fields (phone, emergency contact, birthdate) via a form"
    - "Member can upload a profile avatar that persists and displays"
    - "Member can set notification preferences (email notifications, assignment change notifications, reminder days)"
    - "Member can view their position preferences with proficiency levels across teams"
    - "Profile page handles existing members with no profile row (upsert on first save)"
  artifacts:
    - path: "app/(app)/profile/page.tsx"
      provides: "Profile page with tabbed sections"
      min_lines: 40
    - path: "components/profiles/profile-form.tsx"
      provides: "Profile editing form with react-hook-form"
      contains: "updateOwnProfile"
    - path: "components/profiles/avatar-upload.tsx"
      provides: "Avatar upload component with preview"
      contains: "supabase.storage"
    - path: "components/profiles/notification-preferences.tsx"
      provides: "Notification preference toggles"
      contains: "updateNotificationPreferences"
    - path: "components/profiles/position-preferences.tsx"
      provides: "Read-only position/skill display grouped by team"
      min_lines: 20
  key_links:
    - from: "app/(app)/profile/page.tsx"
      to: "lib/profiles/queries.ts"
      via: "getOwnProfile() server component data fetch"
      pattern: "getOwnProfile\\(\\)"
    - from: "components/profiles/profile-form.tsx"
      to: "lib/profiles/actions.ts"
      via: "updateOwnProfile server action"
      pattern: "updateOwnProfile\\("
    - from: "components/profiles/avatar-upload.tsx"
      to: "lib/profiles/actions.ts"
      via: "updateAvatarUrl after storage upload"
      pattern: "updateAvatarUrl\\("
    - from: "components/profiles/notification-preferences.tsx"
      to: "lib/profiles/actions.ts"
      via: "updateNotificationPreferences server action"
      pattern: "updateNotificationPreferences\\("
---

<objective>
Build the member profile page where users can view and edit their own profile information, upload an avatar, and manage notification preferences.

Purpose: Delivers PROF-02 through PROF-05 requirements -- self-service profile management for every authenticated member.

Output: One page route (/profile) and four components for profile editing, avatar upload, notification preferences, and position display.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-teams-and-member-profiles/02-RESEARCH.md
@.planning/phases/02-teams-and-member-profiles/02-01-SUMMARY.md
@lib/profiles/actions.ts
@lib/profiles/queries.ts
@lib/profiles/schemas.ts
@lib/auth/roles.ts
@components/admin/user-role-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile page with personal info form and avatar upload</name>
  <files>
    app/(app)/profile/page.tsx
    components/profiles/profile-form.tsx
    components/profiles/avatar-upload.tsx
  </files>
  <action>
**app/(app)/profile/page.tsx** — Server component:
- Import getOwnProfile from profiles/queries, getUserRole, createClient.
- Fetch the current user's profile via getOwnProfile(). This returns member data (full_name, email) and profile data (phone, emergency_contact_name, emergency_contact_phone, birthdate, joined_serving_at, avatar_url, notification prefs). Profile data may be null for members who haven't saved yet.
- Layout: Page heading "My Profile" with user's name.
- Use shadcn/ui Tabs component with four tabs:
  1. **Personal Info** — ProfileForm + AvatarUpload components.
  2. **Notification Settings** — NotificationPreferences component.
  3. **Positions & Skills** — PositionPreferences component (read-only display of the member's team positions and skill levels).
  4. (Optional, simple): **About** — displays join date (joined_serving_at or member created_at), formatted with date-fns `format()`.
- Pass the profile data (with null handling) and memberId to each component.
- Add a "Profile" nav item to the sidebar: Update `lib/auth/roles.ts` to add { title: "My Profile", href: "/profile", icon: "UserCircle" } to BOTH `ADMIN_NAV_ITEMS` and `MEMBER_NAV_ITEMS`. Add "UserCircle" to ICON_MAP in `components/app-sidebar.tsx`.

**components/profiles/profile-form.tsx** — Client component ("use client"):
- Props: initialData (profile data, can have null fields), memberId.
- Uses react-hook-form with zodResolver and updateProfileSchema.
- Form fields:
  - Full Name — readonly Input (from members table, not editable here).
  - Email — readonly Input (from members table, not editable here).
  - Phone — Input (type="tel").
  - Emergency Contact Name — Input.
  - Emergency Contact Phone — Input (type="tel").
  - Birthdate — Input (type="date").
- Default values populated from initialData; null/undefined fields default to empty string.
- Submit button calls updateOwnProfile server action.
- Show loading spinner during submit (useTransition or isPending from react-hook-form).
- Show toast on success ("Profile updated") or error.
- Use the shadcn/ui Form component pattern with FormField, FormItem, FormLabel, FormControl, FormMessage for consistent field rendering.

**components/profiles/avatar-upload.tsx** — Client component ("use client"):
- Props: currentAvatarUrl (string | null), memberId.
- Display current avatar using shadcn/ui Avatar component. If no avatar, show initials fallback.
- "Change Photo" button triggers a hidden file input (accept="image/*").
- On file select:
  1. Show preview immediately (URL.createObjectURL).
  2. Upload to Supabase Storage `avatars` bucket: path = `{memberId}/avatar.{ext}`, options = { upsert: true }.
  3. Get public URL via getPublicUrl.
  4. Call updateAvatarUrl server action with the public URL.
  5. Show toast on success/error.
- Show upload progress indicator (loading spinner overlay on avatar).
- File size limit: 5MB. Validate client-side before upload.
- Import createClient from `@/lib/supabase/client` for the browser Supabase client.
  </action>
  <verify>
```bash
pnpm build 2>&1 | tail -10
ls app/\(app\)/profile/page.tsx components/profiles/profile-form.tsx components/profiles/avatar-upload.tsx
# Verify sidebar nav update
grep "profile" lib/auth/roles.ts
```
  </verify>
  <done>Profile page renders with tabbed layout. Personal info tab shows editable form with phone, emergency contact, and birthdate. Avatar upload works with preview, Supabase Storage upload, and URL persistence. Read-only fields (name, email) displayed but not editable. Sidebar includes "My Profile" link for all roles.</done>
</task>

<task type="auto">
  <name>Task 2: Notification preferences and position/skill display components</name>
  <files>
    components/profiles/notification-preferences.tsx
    components/profiles/position-preferences.tsx
  </files>
  <action>
**components/profiles/notification-preferences.tsx** — Client component ("use client"):
- Props: initialPreferences (notify_email, notify_assignment_changes, reminder_days_before) — with defaults for null profile.
- Uses react-hook-form with zodResolver and notificationPreferencesSchema.
- Form fields:
  - Email Notifications — shadcn/ui Switch with label "Receive email notifications".
  - Assignment Change Notifications — Switch with label "Notify me when my assignments change".
  - Reminder Days — Select dropdown with options 0-14 (0 = no reminder, 1 = 1 day before, 2 = 2 days before, etc.). Label: "Remind me before service".
- Submit button calls updateNotificationPreferences server action.
- Show toast on success/error.
- Default values: notify_email = true, notify_assignment_changes = true, reminder_days_before = 2 (matching DB defaults).
- Each preference field has a brief description text below it explaining what it does.

**components/profiles/position-preferences.tsx** — Client component ("use client"):
- Props: positions array (from getOwnProfile — member's position skills with team and position info).
- Read-only display (skills are edited from the team detail page by admin/team lead, not by the member on their own profile — per TEAM-06 which says skill levels are set by management).
- Display grouped by team:
  - Team name as section heading with team color indicator.
  - Each position listed with: position name, category badge, proficiency level badge (color-coded: beginner=slate, intermediate=blue, advanced=purple, expert=amber), preference badge (primary=green, secondary=yellow, willing=gray).
- If no positions/skills assigned, show empty state: "You haven't been assigned to any positions yet. Contact your team leader to get started."
- Use shadcn/ui Badge for proficiency and preference levels.
- Use shadcn/ui Card for each team group.

**Note on PROF-05 (position preferences):** Per the research, position preferences (primary/secondary/willing) are stored in `member_position_skills.preference` and are set by admin/team lead during skill assignment (in 02-02 plan). This component displays them read-only. If the user wants to change their preference, they'd request it from their team lead. This is the correct approach for a church scheduling app where team leads manage assignments.
  </action>
  <verify>
```bash
pnpm build 2>&1 | tail -10
ls components/profiles/notification-preferences.tsx components/profiles/position-preferences.tsx
```
  </verify>
  <done>Notification preferences tab shows toggle switches for email and assignment notifications, plus a dropdown for reminder days. Position preferences tab shows read-only grouped display of the member's positions and skill levels across teams. Both components handle null/empty initial data gracefully.</done>
</task>

</tasks>

<verification>
After both tasks are complete:
1. `pnpm build` passes without errors
2. `pnpm lint` passes
3. `/profile` page renders with four tabs (Personal Info, Notifications, Positions, About)
4. Profile form saves via upsert (works for first-time profile creation)
5. Avatar upload stores file in Supabase Storage and persists URL
6. Notification preferences save correctly
7. Position skills display read-only grouped by team
8. "My Profile" link appears in sidebar for all roles
</verification>

<success_criteria>
- Profile page accessible at /profile with tabbed layout
- Personal info form edits phone, emergency contact, birthdate
- Avatar upload works with preview and Supabase Storage
- Notification preferences toggles save correctly
- Position/skill display shows grouped by team with proficiency badges
- All forms handle null initial data (existing members with no profile row)
- PROF-02, PROF-03, PROF-04, PROF-05 requirements addressed
- Sidebar updated with "My Profile" nav item for all roles
</success_criteria>

<output>
After completion, create `.planning/phases/02-teams-and-member-profiles/02-03-SUMMARY.md`
</output>
