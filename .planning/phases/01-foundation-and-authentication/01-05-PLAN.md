---
phase: 01-foundation-and-authentication
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - lib/auth/roles.ts
  - lib/auth/admin-actions.ts
  - app/(app)/admin/page.tsx
  - components/admin/user-role-table.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin from the sidebar"
    - "Admin panel lists all Supabase Auth users with their current role"
    - "Admin can change a user's role via dropdown (admin, committee, member)"
    - "Non-admin users cannot access /admin â€” they are redirected away"
    - "Sidebar shows 'Admin' nav item only for admin role"
    - "Role changes persist to the database and are reflected immediately in the UI"
  artifacts:
    - path: "app/(app)/admin/page.tsx"
      provides: "Admin panel page for user role management"
      contains: "UserRoleTable"
    - path: "components/admin/user-role-table.tsx"
      provides: "Client component for displaying users and changing roles"
      exports: ["UserRoleTable"]
    - path: "lib/auth/admin-actions.ts"
      provides: "Server actions for listing users and updating roles"
      exports: ["getUsers", "updateUserRole"]
    - path: "lib/auth/roles.ts"
      provides: "Updated nav items with Admin entry for admin role"
      contains: "Admin"
  key_links:
    - from: "app/(app)/admin/page.tsx"
      to: "lib/auth/admin-actions.ts"
      via: "calls getUsers to fetch user list"
      pattern: "getUsers"
    - from: "components/admin/user-role-table.tsx"
      to: "lib/auth/admin-actions.ts"
      via: "calls updateUserRole server action on dropdown change"
      pattern: "updateUserRole"
    - from: "lib/auth/roles.ts"
      to: "app/(app)/admin/page.tsx"
      via: "ADMIN_NAV_ITEMS includes Admin link to /admin"
      pattern: "href.*admin"
---

<objective>
Add an admin panel page for role management, fulfilling AUTH-05. Admins can view all users and change their roles via a dropdown. The admin panel is accessible from the sidebar (admin-only nav item) and is protected so only admins can access it.

Purpose: Without this page, there is no UI for assigning roles to users. The database infrastructure exists (Plan 03), but admins need a dedicated interface to manage who is admin, committee, or member.

Output: Admin page, user role table component, server actions for user listing and role update, updated sidebar nav items.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-03-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-04-SUMMARY.md
@lib/auth/roles.ts
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Admin nav item to sidebar and create server actions for user/role management</name>
  <files>
    lib/auth/roles.ts
    lib/auth/admin-actions.ts
  </files>
  <action>
    1. **Update `lib/auth/roles.ts`** -- add Admin nav item to ADMIN_NAV_ITEMS:
       - Add `{ title: 'Admin', href: '/admin', icon: 'Shield' }` as the LAST item in `ADMIN_NAV_ITEMS`
       - This makes Admin appear at the bottom of the admin/committee sidebar, visually separated from feature sections
       - Do NOT add it to `MEMBER_NAV_ITEMS` -- admin panel is admin-only
       - Note: Committee users will see the Admin link in the sidebar but the page itself will enforce admin-only access. If we want to hide it from committee too, make a separate `ADMIN_ONLY_NAV_ITEMS` array or filter in the sidebar component. Simplest approach: add it to `ADMIN_NAV_ITEMS` (shared by admin and committee) but the page enforces admin-only. Alternatively, create a helper `getNavItems` that appends Admin only when `role === 'admin'`. **Preferred approach:** Update `getNavItems` to conditionally append the Admin item:
         ```typescript
         export function getNavItems(role: AppRole): NavItem[] {
           if (role === 'admin') {
             return [...ADMIN_NAV_ITEMS, { title: 'Admin', href: '/admin', icon: 'Shield' }]
           }
           if (role === 'committee') {
             return ADMIN_NAV_ITEMS
           }
           return MEMBER_NAV_ITEMS
         }
         ```
         This keeps `ADMIN_NAV_ITEMS` as-is (7 items shared by admin and committee) and adds Admin as an 8th item only for admin role.

    2. **Create `lib/auth/admin-actions.ts`** -- server actions for admin panel:
       - Add `'use server'` directive

       **`getUsers()`** -- fetch all users with their roles:
       - Create server Supabase client via `createClient` from `@/lib/supabase/server`
       - First, verify the calling user is an admin:
         - Call `supabase.auth.getUser()` to get current user
         - Query `user_roles` table for the current user's role
         - If not admin, throw an error or return `{ error: 'Unauthorized' }`
       - Query the `user_roles` table: `select('user_id, role, created_at')` to get all role assignments
       - Also need user emails: use `supabase.auth.admin.listUsers()` -- but this requires the service_role key which is NOT available on the client. Instead:
         - Query `auth.users` is not directly accessible via the Supabase JS client with anon key
         - **Alternative approach:** Create a Postgres function (or view) that joins `auth.users` with `user_roles` to return `{id, email, role}`. Add this to the SQL migration as an addendum.
         - **Simpler approach for Phase 1:** Use `supabase.rpc()` to call a database function that returns user data. But that requires adding the function to the migration.
         - **Pragmatic approach:** Create a new Supabase server client using the SERVICE_ROLE_KEY for admin operations only. This is the standard Supabase pattern for admin-level operations.
         - Add `SUPABASE_SERVICE_ROLE_KEY` to `.env.local.example` (NOT `NEXT_PUBLIC_` prefixed -- server-only)
         - Create admin client: `createClient(SUPABASE_URL, SERVICE_ROLE_KEY, { auth: { autoRefreshToken: false, persistSession: false } })`
         - Call `adminClient.auth.admin.listUsers()` to get all auth users
         - Join with `user_roles` data from the regular client query
         - Return array of `{ id: string, email: string, role: AppRole, created_at: string }`
         - For users without a role entry in user_roles, default to 'member'
       - Return type: `{ users: UserWithRole[] } | { error: string }`

       **`updateUserRole(userId: string, newRole: AppRole)`** -- change a user's role:
       - Verify calling user is admin (same check as above)
       - Validate `newRole` is one of 'admin', 'committee', 'member'
       - Use the regular Supabase client (RLS policies allow admins to manage roles)
       - Upsert into `user_roles`: `supabase.from('user_roles').upsert({ user_id: userId, role: newRole }, { onConflict: 'user_id,role' })`
       - Actually, since `user_roles` has a unique constraint on `(user_id, role)` and we want ONE role per user, we need to either:
         - Delete existing role, then insert new one (in a transaction if possible)
         - Or update existing: `supabase.from('user_roles').update({ role: newRole }).eq('user_id', userId)`
         - If no existing row, insert: `supabase.from('user_roles').insert({ user_id: userId, role: newRole })`
         - **Use upsert pattern:** First check if row exists, then update or insert. Or simpler: delete the old row and insert the new one.
         - **Simplest:** Since the unique constraint is on `(user_id, role)` -- which means a user could have MULTIPLE roles -- but our design says ONE role per user. The constraint should be on `(user_id)` alone. However, since Plan 03's SQL already has `unique(user_id, role)`:
           - To handle single-role-per-user: delete all existing roles for the user, then insert the new one
           - `await supabase.from('user_roles').delete().eq('user_id', userId)`
           - `await supabase.from('user_roles').insert({ user_id: userId, role: newRole })`
       - On error, return `{ error: 'Failed to update role' }`
       - On success, call `revalidatePath('/admin')` and return `{ success: true }`

    Run `pnpm format` after creating files.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `lib/auth/roles.ts` `getNavItems('admin')` returns 8 items (7 feature items + Admin)
    - `lib/auth/roles.ts` `getNavItems('committee')` returns 7 items (no Admin)
    - `lib/auth/roles.ts` `getNavItems('member')` returns 4 items (no Admin)
    - `lib/auth/admin-actions.ts` exports `getUsers` and `updateUserRole`
    - `.env.local.example` includes `SUPABASE_SERVICE_ROLE_KEY`
  </verify>
  <done>
    Sidebar nav shows Admin item for admin role only. Server actions exist for listing all users with roles (using service role key for admin.listUsers) and updating a user's role (using RLS-enabled client). Environment template updated with service role key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build admin panel page with user role management table</name>
  <files>
    app/(app)/admin/page.tsx
    components/admin/user-role-table.tsx
  </files>
  <action>
    1. **Create `app/(app)/admin/page.tsx`** -- admin panel page (server component):
       - Import `createClient` from `@/lib/supabase/server`
       - Import `getUserRole` from `@/lib/auth/roles`
       - Import `redirect` from `next/navigation`
       - Import `getUsers` from `@/lib/auth/admin-actions`
       - Fetch current user and their role
       - If role is not 'admin', `redirect('/')` -- admin-only gate
       - Call `getUsers()` to fetch all users with roles
       - If error, display error message
       - Render page with:
         - Title: "Admin" in bold, large text (Dorsey aesthetic)
         - Subtitle: "Manage user roles and permissions"
         - Pass users data to `<UserRoleTable users={users} />`
       - Page styling: generous whitespace, clean typography, consistent with other placeholder pages

    2. **Create `components/admin/user-role-table.tsx`** -- client component for role management:
       - `"use client"` directive
       - Accept `users` prop: array of `{ id: string, email: string, role: AppRole, created_at: string }`
       - Display a table/list of all users:
         - **Mobile layout (default):** Card-style list -- each user is a card showing email, current role dropdown, and member since date
         - **Desktop layout (md+):** Table with columns: Email, Role, Member Since
       - For each user, render a role `<select>` dropdown (or shadcn/ui `Select` component) with options: Admin, Committee, Member
         - Current role is pre-selected
         - On change, call `updateUserRole(userId, newRole)` server action
         - Show a loading/pending state while the action executes (use `useTransition`)
         - On success, the revalidation from the server action refreshes the data
         - On error, show a toast notification via `sonner`
       - Sort users: admins first, then committee, then members, then alphabetically by email within each group
       - Show total user count at the top: "12 users"
       - Use shadcn/ui components: `Table`, `TableBody`, `TableCell`, `TableHead`, `TableHeader`, `TableRow` for desktop; custom cards for mobile
       - Dorsey aesthetic: minimal table chrome, clean borders, monochromatic. Role dropdown uses the standard shadcn Select styling.
       - Prevent admin from changing their own role (disable dropdown for the current user's row, or show a tooltip "Cannot change your own role")

    Run `pnpm format` after creating all files.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `app/(app)/admin/page.tsx` exists and checks for admin role before rendering
    - `components/admin/user-role-table.tsx` exists and renders user list with role dropdowns
    - Non-admin accessing `/admin` is redirected to `/`
    - Admin accessing `/admin` sees the user list with role dropdowns
    - Role dropdown triggers `updateUserRole` server action on change
  </verify>
  <done>
    Admin panel page at `/admin` lists all users with their current roles. Admins can change any user's role via dropdown. Non-admins are redirected away. Mobile shows card layout, desktop shows table. Current user's role is non-editable to prevent self-demotion. Role changes persist immediately via server action.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Admin sidebar shows 8 nav items (7 feature items + Admin)
3. Committee sidebar shows 7 nav items (no Admin)
4. Member sidebar shows 4 nav items (no Admin)
5. `/admin` page loads for admin users and displays all users
6. `/admin` redirects non-admins to `/`
7. Role dropdown changes persist to user_roles table
8. Current user cannot change their own role
9. Mobile layout shows card-style user list
10. Desktop layout shows table with Email, Role, Member Since columns
</verification>

<success_criteria>
- AUTH-05 is satisfied: Admin can assign roles (admin, committee, member) to users via the admin panel
- Admin panel is accessible from sidebar (admin-only nav item)
- Role changes are immediate and persist to the database
- Admin-only access enforcement prevents unauthorized role management
- Jack Dorsey aesthetic maintained: minimal, monochromatic, clean typography
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-05-SUMMARY.md`
</output>
