---
phase: 01-foundation-and-authentication
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - app/layout.tsx
  - app/globals.css
  - app/(app)/layout.tsx
  - app/(app)/page.tsx
  - app/(app)/my-schedule/page.tsx
  - app/(app)/dashboard/page.tsx
  - components/app-sidebar.tsx
  - components/theme-toggle.tsx
  - components/user-nav.tsx
autonomous: false

must_haves:
  truths:
    - "Root layout uses Inter font (not Geist) with CSS variable --font-inter"
    - "Root layout wraps children in ThemeProvider with attribute='class', defaultTheme='system'"
    - "App shell has fixed sidebar on desktop and hamburger slide-over on mobile"
    - "Sidebar shows 7 nav items for admin/committee roles"
    - "Sidebar shows 4 nav items for member role"
    - "Sidebar contains a dark mode toggle that persists across sessions"
    - "Sidebar contains user info and sign-out button"
    - "Authenticated root page redirects to role-based default route"
    - "App is responsive: sidebar hidden on mobile, visible on desktop"
    - "Dark mode toggle switches between light/dark/system themes"
    - "CSS theme uses Jack Dorsey aesthetic: monochromatic with subtle blue accent for primary actions"
  artifacts:
    - path: "app/layout.tsx"
      provides: "Root layout with Inter font and ThemeProvider"
      contains: "ThemeProvider"
    - path: "app/globals.css"
      provides: "Updated theme with Inter font var and Dorsey color palette"
      contains: "--font-inter"
    - path: "app/(app)/layout.tsx"
      provides: "Authenticated app shell with sidebar"
      contains: "SidebarProvider"
    - path: "components/app-sidebar.tsx"
      provides: "Role-filtered sidebar navigation"
      contains: "getNavItems"
    - path: "components/theme-toggle.tsx"
      provides: "Dark mode toggle component"
      contains: "useTheme"
    - path: "components/user-nav.tsx"
      provides: "User info display with sign-out"
      contains: "signout"
  key_links:
    - from: "app/layout.tsx"
      to: "next-themes"
      via: "ThemeProvider wraps all children"
      pattern: "ThemeProvider"
    - from: "components/app-sidebar.tsx"
      to: "lib/auth/roles.ts"
      via: "getNavItems filters sidebar by role"
      pattern: "getNavItems"
    - from: "app/(app)/layout.tsx"
      to: "lib/supabase/server.ts"
      via: "fetches user and role for sidebar"
      pattern: "createClient"
    - from: "app/(app)/page.tsx"
      to: "lib/auth/roles.ts"
      via: "redirects to role-based default route"
      pattern: "getDefaultRoute"
---

<objective>
Build the application shell: root layout with Inter font and ThemeProvider, authenticated layout with role-filtered sidebar navigation, dark mode toggle, user navigation, and role-based landing page redirect. Jack Dorsey design aesthetic throughout.

Purpose: The app shell is the container for every feature built in subsequent phases. It establishes the visual identity (Dorsey aesthetic, Inter font, monochromatic palette with blue accent), navigation structure (role-filtered sidebar), and responsive behavior (mobile hamburger, desktop fixed sidebar). Without this shell, no feature has a home.

Output: Updated root layout, app shell layout with sidebar, role-filtered navigation, dark mode toggle, user nav with sign-out, placeholder pages, and updated theme.
</objective>

<execution_context>
@/Users/chungweijian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chungweijian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-and-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-authentication/01-03-SUMMARY.md
@app/layout.tsx
@app/globals.css
@components/ui/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update root layout, font, theme, and CSS</name>
  <files>
    app/layout.tsx
    app/globals.css
  </files>
  <action>
    1. **Update `app/layout.tsx`:**
       - Replace Geist fonts with Inter from `next/font/google`:
         ```typescript
         import { Inter } from 'next/font/google'
         const inter = Inter({
           variable: '--font-inter',
           subsets: ['latin'],
           display: 'swap',
         })
         ```
       - Remove Geist and Geist_Mono imports entirely
       - Add `ThemeProvider` from `next-themes` wrapping `{children}`:
         ```tsx
         <ThemeProvider attribute="class" defaultTheme="system" enableSystem disableTransitionOnChange>
         ```
       - Add `Toaster` from `sonner` after ThemeProvider children for toast notifications
       - Add `suppressHydrationWarning` to `<html>` (required by next-themes)
       - Apply Inter font variable to `<html>`: `className={inter.variable}`
       - Update metadata: title "YM Serving", description "Worship team scheduling and management"

    2. **Update `app/globals.css`:**
       - Replace `--font-sans: var(--font-geist-sans)` with `--font-sans: var(--font-inter)` in `@theme inline`
       - Remove `--font-mono: var(--font-geist-mono)` (not needed for this app)
       - **Jack Dorsey color palette adjustments for light mode `:root`:**
         - Keep the monochromatic black/white base (already correct)
         - Update `--primary` to a subtle blue for accent actions: `oklch(0.55 0.15 250)` (a muted, professional blue)
         - Update `--primary-foreground` to white: `oklch(1 0 0)`
         - Keep `--secondary`, `--muted`, `--accent` as monochromatic grays (already correct)
         - Keep `--destructive` as-is (functional color)
         - Add status colors as custom properties:
           ```css
           --status-confirmed: oklch(0.65 0.15 145);
           --status-pending: oklch(0.75 0.15 85);
           --status-declined: oklch(0.65 0.2 25);
           ```
       - **Dark mode `.dark` adjustments:**
         - Update `--primary` to a lighter blue: `oklch(0.65 0.15 250)`
         - Update `--primary-foreground` to dark: `oklch(0.15 0 0)`
         - Keep the rest of the dark palette monochromatic (already correct)
         - Add same status colors with slightly adjusted luminance for dark mode
       - Add status color mappings to `@theme inline`:
         ```css
         --color-status-confirmed: var(--status-confirmed);
         --color-status-pending: var(--status-pending);
         --color-status-declined: var(--status-declined);
         ```

    Run `pnpm format` after changes.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `app/layout.tsx` imports Inter (not Geist)
    - `app/layout.tsx` has ThemeProvider wrapping children
    - `app/globals.css` uses `--font-inter` for sans font
    - No references to Geist remain in layout.tsx or globals.css
    - `suppressHydrationWarning` present on `<html>` element
  </verify>
  <done>
    Root layout uses Inter font via CSS variable, wraps all children in ThemeProvider for dark mode support, includes Toaster for notifications. CSS theme updated with Dorsey aesthetic: monochromatic base with subtle blue accent for primary actions, status colors for functional use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build app shell with role-filtered sidebar and dark mode toggle</name>
  <files>
    app/(app)/layout.tsx
    app/(app)/page.tsx
    app/(app)/my-schedule/page.tsx
    app/(app)/dashboard/page.tsx
    components/app-sidebar.tsx
    components/theme-toggle.tsx
    components/user-nav.tsx
  </files>
  <action>
    1. **Create `components/theme-toggle.tsx`** -- dark mode toggle:
       - `"use client"` directive
       - Import `useTheme` from `next-themes`
       - Import `Moon`, `Sun`, `Monitor` icons from `lucide-react`
       - Three-state cycle: system -> light -> dark -> system (or a dropdown with three options)
       - Implement as a simple icon button that cycles through themes on click
       - Use `Button` component with `variant="ghost"` and `size="icon"`
       - Show Sun icon in light, Moon in dark, Monitor in system
       - Accessible: aria-label "Toggle theme"
       - Minimal design: no labels on the button itself, just the icon

    2. **Create `components/user-nav.tsx`** -- user info and sign-out:
       - `"use client"` directive
       - Accept `user` prop with `{ email: string, role: AppRole }`
       - Display user email (truncated if long) and role badge
       - Sign out button: uses `form` with `action="/auth/signout"` and `method="POST"` via a hidden form, or preferably a button that calls `fetch('/auth/signout', { method: 'POST' })` and then `router.push('/login')`
       - Actually, simplest approach: use a `<form action="/auth/signout" method="POST">` with a submit button styled as a ghost button
       - Include `LogOut` icon from lucide-react
       - Dorsey aesthetic: minimal, muted colors, no decoration

    3. **Create `components/app-sidebar.tsx`** -- the main sidebar:
       - `"use client"` directive (uses hooks for active state)
       - Use the existing shadcn/ui `Sidebar` component (`components/ui/sidebar.tsx`)
       - Accept `role` and `user` props
       - Import `getNavItems` from `@/lib/auth/roles` to get role-filtered nav items
       - Map Lucide icon names from NavItem to actual Lucide icon components
       - Sidebar structure:
         - **Header**: App name "YM Serving" in bold, sharp typography
         - **Content**: Navigation items as `SidebarMenu` > `SidebarMenuItem` > `SidebarMenuButton`
         - Each nav item: icon + title, with active state highlighting based on current pathname
         - Use `usePathname()` from `next/navigation` for active state
         - Active item: bold text, blue accent indicator (left border or bg highlight)
         - **Footer**: ThemeToggle component, then UserNav component
       - The shadcn Sidebar component already handles mobile vs desktop:
         - Desktop: fixed sidebar (collapsible)
         - Mobile: Sheet overlay triggered by `SidebarTrigger` (hamburger button)
       - Touch targets: all nav items at least 44px tall for mobile

    4. **Create `app/(app)/layout.tsx`** -- authenticated app shell:
       - **Server component** (no "use client")
       - Import `createClient` from `@/lib/supabase/server`
       - Fetch current user via `supabase.auth.getUser()`
       - If no user, `redirect('/login')` (defense in depth -- middleware should catch this first)
       - Fetch user role from session via `supabase.auth.getSession()` then `getUserRole(session)`
         - Note: Use `getSession()` here ONLY to read cached JWT claims for role extraction (already verified by middleware's `getUser()` call). This is the documented pattern.
       - Wrap children in `SidebarProvider` > `AppSidebar` + `SidebarInset` layout
       - The `SidebarInset` contains a header bar with `SidebarTrigger` (hamburger for mobile) and the main content area
       - Header bar: minimal, contains hamburger trigger (mobile only), breadcrumb or page title area
       - Main content: `<main className="flex-1 p-4 md:p-6">` with children

    5. **Create `app/(app)/page.tsx`** -- authenticated root redirect:
       - Server component
       - Fetch user and role (same pattern as layout)
       - Use `redirect(getDefaultRoute(role))` to send:
         - Members to `/my-schedule`
         - Admin/Committee to `/dashboard`
       - This page never renders UI -- it's purely a redirect

    6. **Create `app/(app)/dashboard/page.tsx`** -- placeholder:
       - Simple server component
       - Title: "Services" (the admin/committee landing page name)
       - Subtitle: "Manage upcoming services and team assignments"
       - Empty state with a message: "No services yet. This page will show the services dashboard."
       - Dorsey aesthetic: clean typography, generous spacing

    7. **Create `app/(app)/my-schedule/page.tsx`** -- placeholder:
       - Simple server component
       - Title: "My Schedule"
       - Subtitle: "Your upcoming assignments and availability"
       - Empty state: "No assignments yet. Your schedule will appear here."
       - Dorsey aesthetic

    Run `pnpm format` after creating all files.
  </action>
  <verify>
    - `pnpm build` succeeds
    - `pnpm dev` starts and navigating to `/` as authenticated user redirects to `/dashboard` or `/my-schedule`
    - Sidebar renders with role-appropriate navigation items
    - Dark mode toggle cycles through light/dark/system
    - On mobile viewport (< 768px): sidebar is hidden, hamburger menu shows
    - On desktop viewport (>= 768px): sidebar is fixed on the left
    - Sign out button works (redirects to `/login`)
    - Inter font is applied to all text
    - Blue accent color appears on primary buttons and active sidebar items
  </verify>
  <done>
    App shell renders with: Inter font, Jack Dorsey monochromatic aesthetic with blue accent, role-filtered sidebar (7 items for admin/committee, 4 for member), dark mode toggle persisting across sessions, user nav with sign-out, mobile hamburger menu, desktop fixed sidebar, and role-based landing page redirect.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete auth flow and app shell</name>
  <files>
    app/(app)/layout.tsx
    app/(auth)/login/page.tsx
    components/app-sidebar.tsx
  </files>
  <action>
    Human verification of the complete Phase 1 auth and app shell. No automated work in this task -- all implementation is done in Tasks 1 and 2. This checkpoint verifies the end-to-end experience.

    **What was built:**
    - Login page with email/password (Jack Dorsey aesthetic)
    - Password reset flow (request + update)
    - Role-filtered sidebar navigation (7 items for admin/committee, 4 for member)
    - Dark mode toggle persisting across sessions
    - Mobile responsive layout (hamburger + slide-over sidebar)
    - Sign out functionality

    **Prerequisites:** Supabase environment configured (env vars set, SQL migration run, custom access token hook enabled)

    **Verification steps:**
    1. Open http://localhost:3000 -- should redirect to /login
    2. Login page: verify Jack Dorsey aesthetic (minimal, monochromatic, Inter font, blue accent on sign-in button)
    3. Try invalid credentials -- error message should appear
    4. Sign in with valid credentials -- should redirect to dashboard or my-schedule based on role
    5. Verify sidebar shows correct nav items for your role
    6. Click dark mode toggle -- theme should switch. Refresh page -- theme should persist
    7. On mobile viewport (use browser DevTools): verify hamburger menu appears, sidebar is a slide-over
    8. Click "Forgot your password?" on login -- should go to reset page
    9. Click sign out in sidebar footer -- should redirect to /login
    10. Try accessing /dashboard directly while logged out -- should redirect to /login
  </action>
  <verify>
    User types "approved" to confirm all 10 verification steps pass, or describes specific issues to fix.
  </verify>
  <done>
    All 10 verification steps pass: auth redirects work, login/logout flow complete, sidebar is role-filtered and responsive, dark mode toggles and persists, password reset navigation works.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. Inter font loads and applies to all text (no Geist references remain)
3. ThemeProvider wraps all pages with class-based dark mode
4. Sidebar uses shadcn/ui Sidebar component with mobile Sheet and desktop fixed modes
5. Role-based navigation: admin/committee see 7 items, member sees 4
6. Dark mode toggle cycles light/dark/system and persists via localStorage
7. Root authenticated page redirects to role-based default route
8. Sign out clears session and redirects to login
9. Blue accent color visible on primary actions
10. Mobile responsive: hamburger + slide-over sidebar on small screens
</verification>

<success_criteria>
- App shell is fully functional with responsive sidebar, dark mode, and role-filtered navigation
- Jack Dorsey design aesthetic is clearly visible: minimal, monochromatic, Inter font, blue accent, generous whitespace
- Complete auth flow works: login -> app shell -> sign out -> login
- Password reset flow: login -> forgot password -> enter email -> (email) -> update password -> app shell
- Mobile-first: all interactions work on mobile viewports with proper touch targets
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-authentication/01-04-SUMMARY.md`
</output>
